\subsubsection{Package \texttt{rnaseqlyze}}
\label{rnaseqlyze-pdf:package-rnaseqlyze}\label{rnaseqlyze-pdf::doc}

\paragraph{Modul \texttt{rnaseqlyze}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{Top level package module}

\PYG{l+s+sd}{Importing this package configures the python "logging"}
\PYG{l+s+sd}{module in a way that messages of any level go to sys.stderr.}
\PYG{l+s+sd}{"""}

\PYG{c}{\PYGZsh{}: the project base-name}
\PYG{c}{\PYGZsh{}: the -cli, -web and -worker project names}
\PYG{c}{\PYGZsh{}: are constructed by appending the part name to this one}
\PYG{n}{project\PYGZus{}name} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{rna-seqlyze}\PYG{l+s}{"}

\PYG{k+kn}{import} \PYG{n+nn}{pkg\PYGZus{}resources}
\PYG{c}{\PYGZsh{}: The \PYGZus{}\PYGZus{}version\PYGZus{}\PYGZus{} property is set automatically set to the value of}
\PYG{c}{\PYGZsh{}: pkg\PYGZus{}resources.get\PYGZus{}distribution(project\PYGZus{}name).version on module import time.}
\PYG{k}{try}\PYG{p}{:}
    \PYG{n}{\PYGZus{}\PYGZus{}version\PYGZus{}\PYGZus{}} \PYG{o}{=} \PYG{n}{pkg\PYGZus{}resources}\PYG{o}{.}\PYG{n}{get\PYGZus{}distribution}\PYG{p}{(}\PYG{n}{project\PYGZus{}name}\PYG{p}{)}\PYG{o}{.}\PYG{n}{version}
\PYG{k}{except}\PYG{p}{:}
    \PYG{c}{\PYGZsh{} When the packe is initially installed, this module is imported by setup.py}
    \PYG{c}{\PYGZsh{} and the the {}`project\PYGZus{}name{}` attribute defined above is used to set the}
    \PYG{c}{\PYGZsh{} project name, in order to make that information non-redundant.}
    \PYG{c}{\PYGZsh{}}
    \PYG{c}{\PYGZsh{} The version, however, is determined at install/build time by running}
    \PYG{c}{\PYGZsh{} {}`git --describe{}` - in setup.py. So it doesn't matter if it is not set at}
    \PYG{c}{\PYGZsh{} that time.  Later on, because {}`python setup.py install/develop{}` writes it}
    \PYG{c}{\PYGZsh{} to rna-seqlyze.egg-info/PKG-INFO, where pkg\PYGZus{}resources picks it up,}
    \PYG{c}{\PYGZsh{} it will be available whenever the package is imported.}
    \PYG{k}{pass}
\PYG{k}{del} \PYG{n}{pkg\PYGZus{}resources}

\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{logging}\PYG{o}{.}\PYG{n}{basicConfig}\PYG{p}{(}\PYG{n}{level}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{format}\PYG{o}{=}\PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}(levelname)-5.5s}\PYG{l+s}{ [}\PYG{l+s+si}{\PYGZpc{}(name)s}\PYG{l+s}{] }\PYG{l+s+si}{\PYGZpc{}(message)s}\PYG{l+s}{"}\PYG{p}{)}
\PYG{k}{del} \PYG{n}{logging}

\PYG{k}{def} \PYG{n+nf}{configure}\PYG{p}{(}\PYG{n}{\PYGZus{}workdir}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Calling this function}

\PYG{l+s+sd}{        - sets rnaseqlyze.workdir to \textless{}workdir\textgreater{}}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        - sets rnaseqlyze.\textless{}setting\textgreater{} attributes for all}
\PYG{l+s+sd}{          settings under [rnaseqlyze] in '\textless{}workdir\textgreater{}/rnaseqlyze.ini'.}

\PYG{l+s+sd}{        - imports Bio.Entrez and sets Bio.Entrez.email to rnaseqlyze.admin\PYGZus{}email}
\PYG{l+s+sd}{    """}

    \PYG{k}{global} \PYG{n}{workdir}
    \PYG{n}{workdir} \PYG{o}{=} \PYG{n}{\PYGZus{}workdir}

    \PYG{k+kn}{from} \PYG{n+nn}{os.path} \PYG{k+kn}{import} \PYG{n}{join}
    \PYG{k+kn}{from} \PYG{n+nn}{ConfigParser} \PYG{k+kn}{import} \PYG{n}{ConfigParser}
    \PYG{n}{config} \PYG{o}{=} \PYG{n}{ConfigParser}\PYG{p}{(}\PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{here}\PYG{o}{=}\PYG{n}{workdir}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{config}\PYG{o}{.}\PYG{n}{read}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{rnaseqlyze.ini}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{)}

    \PYG{k}{for} \PYG{n}{name}\PYG{p}{,} \PYG{n}{value} \PYG{o+ow}{in} \PYG{n}{config}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{rnaseqlyze}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{globals}\PYG{p}{(}\PYG{p}{)}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{value}

    \PYG{k+kn}{import} \PYG{n+nn}{Bio.Entrez}
    \PYG{n}{Bio}\PYG{o}{.}\PYG{n}{Entrez}\PYG{o}{.}\PYG{n}{email} \PYG{o}{=} \PYG{n}{admin\PYGZus{}email}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.build}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-build}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{The rna-seqlyze software consisty of several parts. The majority of those parts}
\PYG{l+s+sd}{have been developped independently of this project and have been released under}
\PYG{l+s+sd}{a permissive license that allows them to be used in other (permissive licenced)}
\PYG{l+s+sd}{projects like this one.}

\PYG{l+s+sd}{This file defines a simple system and stores the commands necessary to build and}
\PYG{l+s+sd}{install those third-party components.}
\PYG{l+s+sd}{"""}

\PYG{k+kn}{from} \PYG{n+nn}{\PYGZus{}\PYGZus{}future\PYGZus{}\PYGZus{}} \PYG{k+kn}{import} \PYG{n}{print\PYGZus{}function}

\PYG{k+kn}{import} \PYG{n+nn}{os}\PYG{o}{,} \PYG{n+nn}{sys}\PYG{o}{,} \PYG{n+nn}{shutil}
\PYG{k+kn}{from} \PYG{n+nn}{os} \PYG{k+kn}{import} \PYG{n}{environ} \PYG{k}{as} \PYG{n}{env}
\PYG{k+kn}{from} \PYG{n+nn}{types} \PYG{k+kn}{import} \PYG{n}{MethodType}
\PYG{k+kn}{import} \PYG{n+nn}{subprocess}\PYG{o}{,} \PYG{n+nn}{multiprocessing}

\PYG{c}{\PYGZsh{} a bit of infrastructure}
\PYG{c}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}

\PYG{k}{class} \PYG{n+nc}{PartType}\PYG{p}{(}\PYG{n+nb}{type}\PYG{p}{)}\PYG{p}{:}

    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n}{cls}\PYG{p}{,} \PYG{o}{*}\PYG{n}{ign}\PYG{p}{)}\PYG{p}{:}
        \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{        auto-create and stock instances}
\PYG{l+s+sd}{        upon creation of "Part" (sub)classes}

\PYG{l+s+sd}{        appends a new instance of the}
\PYG{l+s+sd}{        created class to the "parts" list, if it exists}
\PYG{l+s+sd}{        """}
        \PYG{k}{try}\PYG{p}{:}
            \PYG{n}{parts}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{cls}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{except} \PYG{n+ne}{NameError}\PYG{p}{:}
            \PYG{k}{pass}

\PYG{k}{class} \PYG{n+nc}{Part}\PYG{p}{(}\PYG{n+nb}{object}\PYG{p}{)}\PYG{p}{:}

    \PYG{n}{\PYGZus{}\PYGZus{}metaclass\PYGZus{}\PYGZus{}} \PYG{o}{=} \PYG{n}{PartType}

    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{name} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}class\PYGZus{}\PYGZus{}}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}
        \PYG{k}{try}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{subdir} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{src/}\PYG{l+s}{"} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{srcdir}
        \PYG{k}{except} \PYG{n+ne}{AttributeError}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{subdir} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{src/}\PYG{l+s}{"} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{name}

    \PYG{k}{def} \PYG{n+nf}{execute}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{phase}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{cmds} \PYG{o}{=} \PYG{n+nb}{getattr}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{phase}\PYG{p}{,} \PYG{n+nb+bp}{None}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{cmds} \PYG{o}{==} \PYG{n+nb+bp}{None}\PYG{p}{:} \PYG{k}{return}
        \PYG{k}{print}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{\PYGZsh{}}\PYG{l+s}{"} \PYG{o}{*} \PYG{l+m+mi}{80}\PYG{p}{)}
        \PYG{k}{print}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{\PYGZsh{} executing }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{ phase}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{name}\PYG{p}{,} \PYG{n}{phase}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{print}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{\PYGZsh{}}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{n}{dev\PYGZus{}null} \PYG{o}{=} \PYG{n+nb}{file}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{/dev/null}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{n}{logdir} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{report/buildlogs}\PYG{l+s}{"}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{isdir}\PYG{p}{(}\PYG{n}{logdir}\PYG{p}{)}\PYG{p}{:} \PYG{n}{os}\PYG{o}{.}\PYG{n}{mkdir}\PYG{p}{(}\PYG{n}{logdir}\PYG{p}{)}
        \PYG{n}{logpath} \PYG{o}{=} \PYG{n}{logdir} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{/}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{-}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{.log}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{name}\PYG{p}{,} \PYG{n}{phase}\PYG{p}{)}
        \PYG{n}{T} \PYG{o}{=} \PYG{n}{subprocess}\PYG{o}{.}\PYG{n}{Popen}\PYG{p}{(}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{tee}\PYG{l+s}{"}\PYG{p}{,} \PYG{n}{logpath}\PYG{p}{]}\PYG{p}{,} \PYG{n}{stdin}\PYG{o}{=}\PYG{n}{subprocess}\PYG{o}{.}\PYG{n}{PIPE}\PYG{p}{)}
        \PYG{k}{try}\PYG{p}{:}
            \PYG{k+kn}{import} \PYG{n+nn}{time}
            \PYG{n}{log} \PYG{o}{=} \PYG{k}{lambda} \PYG{n}{msg}\PYG{o}{=}\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{:} \PYG{k}{print}\PYG{p}{(}\PYG{n}{msg}\PYG{p}{,} \PYG{n+nb}{file}\PYG{o}{=}\PYG{n}{T}\PYG{o}{.}\PYG{n}{stdin}\PYG{p}{)}
            \PYG{n}{log}\PYG{p}{(}\PYG{n}{time}\PYG{o}{.}\PYG{n}{asctime}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{log}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{log}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{"}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{=}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{nv}
                \PYG{k}{for} \PYG{n}{nv} \PYG{o+ow}{in} \PYG{n+nb}{filter}\PYG{p}{(}\PYG{k}{lambda} \PYG{n}{i}\PYG{p}{:} \PYG{n}{i}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o+ow}{in} \PYG{p}{(}
                    \PYG{l+s}{"}\PYG{l+s}{TOPDIR}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{PREFIX}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{BINDIR}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{LIBDIR}\PYG{l+s}{"}\PYG{p}{,}
                    \PYG{l+s}{"}\PYG{l+s}{MACHTYPE}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{NCPUS\PYGZus{}ONLN}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{,} \PYG{n}{env}\PYG{o}{.}\PYG{n}{iteritems}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{log}\PYG{p}{(}\PYG{p}{)}
            \PYG{k}{if} \PYG{n+nb}{type}\PYG{p}{(}\PYG{n}{cmds}\PYG{p}{)} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{p}{(}\PYG{n+nb}{list}\PYG{p}{,} \PYG{n+nb}{tuple}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{cmds} \PYG{o}{=} \PYG{n}{cmds}\PYG{p}{,} \PYG{c}{\PYGZsh{} make it a 1-tuple}
            \PYG{k}{for} \PYG{n}{cmd} \PYG{o+ow}{in} \PYG{n}{cmds}\PYG{p}{:}
                \PYG{n}{log}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{\PYGZdl{} cd }\PYG{l+s}{"} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{subdir}\PYG{p}{)}
                \PYG{n}{log}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{\PYGZdl{} }\PYG{l+s}{"} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{  }\PYG{l+s}{"}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{cmd}\PYG{p}{)}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
                \PYG{n}{log}\PYG{p}{(}\PYG{p}{)}
                \PYG{k}{if} \PYG{n+nb}{type}\PYG{p}{(}\PYG{n}{cmd}\PYG{p}{)} \PYG{o}{==} \PYG{n+nb}{str}\PYG{p}{:}
                    \PYG{n}{ret} \PYG{o}{=} \PYG{n}{subprocess}\PYG{o}{.}\PYG{n}{call}\PYG{p}{(}\PYG{n}{cmd}\PYG{p}{,} \PYG{n}{shell}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{,} \PYG{n}{cwd}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{subdir}\PYG{p}{,}
                                \PYG{n}{stdin}\PYG{o}{=}\PYG{n}{dev\PYGZus{}null}\PYG{p}{,} \PYG{n}{stdout}\PYG{o}{=}\PYG{n}{T}\PYG{o}{.}\PYG{n}{stdin}\PYG{p}{,} \PYG{n}{stderr}\PYG{o}{=}\PYG{n}{T}\PYG{o}{.}\PYG{n}{stdin}\PYG{p}{)}
                \PYG{k}{elif} \PYG{n+nb}{type}\PYG{p}{(}\PYG{n}{cmd}\PYG{p}{)} \PYG{o}{==} \PYG{n}{MethodType}\PYG{p}{:}
                    \PYG{k}{def} \PYG{n+nf}{tgt}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
                        \PYG{n}{sys}\PYG{o}{.}\PYG{n}{stdin} \PYG{o}{=} \PYG{n}{dev\PYGZus{}null}
                        \PYG{n}{sys}\PYG{o}{.}\PYG{n}{stdout} \PYG{o}{=} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{stderr} \PYG{o}{=} \PYG{n}{T}\PYG{o}{.}\PYG{n}{stdin}
                        \PYG{n}{os}\PYG{o}{.}\PYG{n}{chdir}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{subdir}\PYG{p}{)}
                        \PYG{k}{return} \PYG{n}{cmd}\PYG{p}{(}\PYG{p}{)}
                    \PYG{n}{sp} \PYG{o}{=} \PYG{n}{multiprocessing}\PYG{o}{.}\PYG{n}{Process}\PYG{p}{(}\PYG{n}{target}\PYG{o}{=}\PYG{n}{tgt}\PYG{p}{)}
                    \PYG{n}{sp}\PYG{o}{.}\PYG{n}{start}\PYG{p}{(}\PYG{p}{)}
                    \PYG{n}{sp}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{p}{)}
                    \PYG{n}{ret} \PYG{o}{=} \PYG{n}{sp}\PYG{o}{.}\PYG{n}{exitcode}
                \PYG{k}{else}\PYG{p}{:}
                    \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Invalid }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{ phase command: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}
                                              \PYG{n}{phase}\PYG{p}{,}             \PYG{n+nb}{repr}\PYG{p}{(}\PYG{n}{cmd}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
                \PYG{n}{log}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{log}\PYG{p}{(}\PYG{n}{time}\PYG{o}{.}\PYG{n}{asctime}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{if} \PYG{n}{ret} \PYG{o}{!=} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{ phase failed -- exit code }\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}
                                    \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{name}\PYG{p}{,} \PYG{n}{phase}\PYG{p}{,} \PYG{n}{ret}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{finally}\PYG{p}{:}
            \PYG{n}{T}\PYG{o}{.}\PYG{n}{stdin}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{T}\PYG{o}{.}\PYG{n}{wait}\PYG{p}{(}\PYG{p}{)}

\PYG{c}{\PYGZsh{} parts \& phases}
\PYG{c}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}

\PYG{n}{parts} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{phases} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{build}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{test}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{install}\PYG{l+s}{'}

\PYG{k}{class} \PYG{n+nc}{bcbb}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{srcdir} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{bcbb/nextgen}\PYG{l+s}{"}
    \PYG{n}{build} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py build}\PYG{l+s}{"}
    \PYG{c}{\PYGZsh{} save some time}
    \PYG{c}{\PYGZsh{}test = "nosetests"}
    \PYG{n}{install} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py install --prefix=\PYGZdl{}PREFIX}\PYG{l+s}{"}

\PYG{k}{class} \PYG{n+nc}{biopython}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{build} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py build}\PYG{l+s}{"}
    \PYG{c}{\PYGZsh{} save some time}
    \PYG{c}{\PYGZsh{}test = "python setup.py test"}
    \PYG{n}{install} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py install --prefix=\PYGZdl{}PREFIX}\PYG{l+s}{"}

\PYG{k}{class} \PYG{n+nc}{bowtie2}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{build} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{make -j\PYGZdl{}NCPUS\PYGZus{}ONLN}\PYG{l+s}{"}
    \PYG{k}{def} \PYG{n+nf}{install}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{        the bowtie2 install function}
\PYG{l+s+sd}{        exists because there is no 'install' target in}
\PYG{l+s+sd}{        the makefile, so the binaries need to be installed manually}
\PYG{l+s+sd}{        """}
        \PYG{k+kn}{import} \PYG{n+nn}{shutil}
        \PYG{k}{for} \PYG{n}{f} \PYG{o+ow}{in} \PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{bowtie2}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{x} \PYG{k}{for} \PYG{n}{x} \PYG{o+ow}{in} \PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{-align}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{-build}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{-inspect}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{shutil}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{n}{f}\PYG{p}{,} \PYG{n}{env}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{BINDIR}\PYG{l+s}{"}\PYG{p}{]}\PYG{p}{)}
            \PYG{n}{os}\PYG{o}{.}\PYG{n}{chmod}\PYG{p}{(}\PYG{n}{env}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{BINDIR}\PYG{l+s}{"}\PYG{p}{]} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{/}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{f}\PYG{p}{,} \PYG{l+m+mo}{0775}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{ncurses}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{build} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{./configure --prefix \PYGZdl{}HOME/.local \&\& make}\PYG{l+s}{"}
    \PYG{n}{install} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{make install}\PYG{l+s}{"}

\PYG{k}{class} \PYG{n+nc}{samtools}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{depends} \PYG{o}{=} \PYG{n}{ncurses}
    \PYG{n}{build} \PYG{o}{=} \PYG{p}{(}
        \PYG{l+s}{'}\PYG{l+s}{make -j\PYGZdl{}NCPUS\PYGZus{}ONLN -C bcftools}\PYG{l+s}{'}\PYG{p}{,}
        \PYG{l+s}{'}\PYG{l+s}{make -j2 SUBDIRS=.}\PYG{l+s}{'}
            \PYG{l+s}{'}\PYG{l+s}{ LIBPATH=-L\PYGZdl{}PREFIX/lib LIBCURSES=-lncurses}\PYG{l+s}{'}
            \PYG{l+s}{'}\PYG{l+s}{ CFLAGS=}\PYG{l+s}{"}\PYG{l+s}{\PYGZdl{}(echo -I\PYGZdl{}PREFIX/include\PYGZob{},/ncurses\PYGZcb{})}\PYG{l+s}{"}\PYG{l+s}{'}
    \PYG{p}{)}
    \PYG{n}{install} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{cp samtools \PYGZdl{}PREFIX/bin}\PYG{l+s}{"}

\PYG{k}{class} \PYG{n+nc}{cufflinks}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{depends} \PYG{o}{=} \PYG{n}{samtools}
    \PYG{n}{build} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{./configure --prefix=\PYGZdl{}PREFIX}\PYG{l+s}{"}       \PYGZbs{}
                \PYG{l+s}{"}\PYG{l+s}{ --with-eigen=\PYGZdl{}TOPDIR/src/eigen}\PYG{l+s}{"} \PYGZbs{}
                \PYG{l+s}{"}\PYG{l+s}{ --with-bam=\PYGZdl{}TOPDIR/src/samtools \&\& make}\PYG{l+s}{"}
    \PYG{n}{install} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{make install}\PYG{l+s}{"}

\PYG{k}{class} \PYG{n+nc}{kent}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{build} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{make -C src/lib}\PYG{l+s}{"}
    \PYG{k}{def} \PYG{n+nf}{install}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{        the kent install function was created, because rna-seqlyze need only}
\PYG{l+s+sd}{        a small subset of the included ulities and the easiest way to build}
\PYG{l+s+sd}{        those is to run "make" with custom arguments for each one of them}
\PYG{l+s+sd}{        """}
        \PYG{k}{for} \PYG{n}{util} \PYG{o+ow}{in} \PYG{l+s}{"}\PYG{l+s}{wigToBigWig bedToBigBed}\PYG{l+s}{"}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{ }\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{subprocess}\PYG{o}{.}\PYG{n}{call}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{make -C src/utils/}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{util}\PYG{p}{,} \PYG{n}{shell}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)} \PYG{o}{!=} \PYG{l+m+mi}{0}\PYG{p}{:}
                \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{kent.install(): couldn}\PYG{l+s}{'}\PYG{l+s}{t install }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{util}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{pysam}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{build} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py build}\PYG{l+s}{"}
    \PYG{c}{\PYGZsh{} tests failing...}
    \PYG{c}{\PYGZsh{}test = "cd tests; nosetests --exe"}
    \PYG{c}{\PYGZsh{}test = "cd tests; ./pysam\PYGZus{}test.py"}
    \PYG{n}{install} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py install --prefix=\PYGZdl{}PREFIX}\PYG{l+s}{"}

\PYG{k}{class} \PYG{n+nc}{rna\PYGZus{}seqlyze\PYGZus{}cli}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{srcdir} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{rna-seqlyze-cli}\PYG{l+s}{"}
    \PYG{n}{build} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py build}\PYG{l+s}{"}
    \PYG{n}{test} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py test}\PYG{l+s}{"}
    \PYG{n}{install} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py develop --prefix=\PYGZdl{}PREFIX}\PYG{l+s}{"}

\PYG{k}{class} \PYG{n+nc}{rna\PYGZus{}seqlyze\PYGZus{}web}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{srcdir} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{rna-seqlyze-web}\PYG{l+s}{"}
    \PYG{n}{build} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py build}\PYG{l+s}{"}
    \PYG{n}{test} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py test}\PYG{l+s}{"}
    \PYG{n}{install} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py develop --prefix=\PYGZdl{}PREFIX}\PYG{l+s}{"}

\PYG{k}{class} \PYG{n+nc}{rna\PYGZus{}seqlyze\PYGZus{}worker}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{srcdir} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{rna-seqlyze-worker}\PYG{l+s}{"}
    \PYG{n}{build} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py build}\PYG{l+s}{"}
    \PYG{n}{test} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py test}\PYG{l+s}{"}
    \PYG{n}{install} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py develop --prefix=\PYGZdl{}PREFIX}\PYG{l+s}{"}

\PYG{k}{class} \PYG{n+nc}{sra\PYGZus{}sdk}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{c}{\PYGZsh{} To get this to compile, I}
    \PYG{c}{\PYGZsh{} 1) created a symlink src/sra\PYGZus{}sdk/libxml2.so}
    \PYG{c}{\PYGZsh{}    pointing to /usr/lib/libxml2.so.2 and added}
    \PYG{c}{\PYGZsh{}    LDFLAGS=-L\PYGZdl{}PWD to avoid having to install libxml2-dev}
    \PYG{c}{\PYGZsh{} 2) replaced the content of src/sra\PYGZus{}sdk/libs/ext/Makefile}
    \PYG{c}{\PYGZsh{}    with "all:" to skip unnesessary downloading of zlib and libbz2}
    \PYG{n}{build} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{LD\PYGZus{}RUN\PYGZus{}PATH=\PYGZdl{}LIBDIR make STATIC= STATICSYSLIBS= LDFLAGS=-L\PYGZdl{}PWD}\PYG{l+s}{"}
    \PYG{n}{install} \PYG{o}{=} \PYG{p}{(}
        \PYG{l+s}{"}\PYG{l+s}{cp -a linux/pub/gcc/\PYGZdl{}ARCH/bin/* \PYGZdl{}BINDIR}\PYG{l+s}{"}\PYG{p}{,}
        \PYG{l+s}{"}\PYG{l+s}{cp -a linux/pub/gcc/\PYGZdl{}ARCH/lib/* \PYGZdl{}LIBDIR}\PYG{l+s}{"}\PYG{p}{,}
        \PYG{l+s}{"}\PYG{l+s}{cp -a linux/pub/gcc/\PYGZdl{}ARCH/mod \PYGZdl{}LIBDIR/ncbi}\PYG{l+s}{"}\PYG{p}{,}
        \PYG{l+s}{"}\PYG{l+s}{cp -a linux/pub/gcc/\PYGZdl{}ARCH/wmod \PYGZdl{}LIBDIR/ncbi}\PYG{l+s}{"}\PYG{p}{,}
    \PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{tophat}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{build} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{./configure --prefix=\PYGZdl{}PREFIX}\PYG{l+s}{"} \PYGZbs{}
                       \PYG{l+s}{"}\PYG{l+s}{ --with-bam=\PYGZdl{}TOPDIR/src/samtools \&\& make}\PYG{l+s}{"}
    \PYG{n}{install} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{make install}\PYG{l+s}{"}

\PYG{k}{class} \PYG{n+nc}{trac}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{build} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py build}\PYG{l+s}{"}
    \PYG{c}{\PYGZsh{} save some time}
    \PYG{c}{\PYGZsh{}test = "python setup.py test"}
    \PYG{n}{install} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py install --prefix=\PYGZdl{}PREFIX}\PYG{l+s}{"}

\PYG{k}{class} \PYG{n+nc}{trac\PYGZus{}env}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf}{install}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{c}{\PYGZsh{} need to discuss server}
        \PYG{c}{\PYGZsh{} configuration with admin}
        \PYG{c}{\PYGZsh{}destdir = "\PYGZpc{}(PREFIX)s/var/trac\PYGZus{}env" \PYGZpc{} env}
        \PYG{c}{\PYGZsh{}basedir = os.path.dirname(destdir)}
        \PYG{c}{\PYGZsh{}if not os.path.isdir(basedir):}
        \PYG{c}{\PYGZsh{}    os.mkdir(basedir)}
        \PYG{c}{\PYGZsh{}shutil.copytree(".", destdir, symlinks=True)}
        \PYG{c}{\PYGZsh{}print("Copied \PYGZpc{}s to \PYGZpc{}s\PYGZbs{}n" \PYGZpc{} (os.getcwd(), destdir))}
        \PYG{k}{print}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{"}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{p}{(}
\PYG{l+s+sd}{"""\PYGZbs{}}
\PYG{l+s+sd}{The following still needs to be done manually:}
\PYG{l+s+sd}{ 1) Set up a database}
\PYG{l+s+sd}{ 2) Restore the backup:}
\PYG{l+s+sd}{    \PYGZdl{} cd """} \PYG{o}{+} \PYG{n}{os}\PYG{o}{.}\PYG{n}{getcwd}\PYG{p}{(}\PYG{p}{)} \PYG{o}{+} \PYG{l+s}{"""}
\PYG{l+s}{    \PYGZdl{} mysql -uUSERNAME -pPASSWORD DATABASE \textless{} mysql-db-backup.sql}
\PYG{l+s}{ 4) Adjust the }\PYG{l+s}{'}\PYG{l+s}{database}\PYG{l+s}{'}\PYG{l+s}{ variable in the [trac] section in }\PYG{l+s}{'}\PYG{l+s}{conf/trac.ini}\PYG{l+s}{'}\PYG{l+s}{:}
\PYG{l+s}{    database = mysql://USERNAME:PASSWORD@localhost/DATABSE}
\PYG{l+s}{"""}
        \PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{transterm\PYGZus{}hp}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{build} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{make}\PYG{l+s}{"}
    \PYG{k}{def} \PYG{n+nf}{install}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{prog} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{transterm}\PYG{l+s}{"}
        \PYG{n}{data} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{expterm.dat}\PYG{l+s}{"}
        \PYG{n}{shutil}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{n}{prog}\PYG{p}{,} \PYG{n}{env}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{BINDIR}\PYG{l+s}{"}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{chmod}\PYG{p}{(}\PYG{n}{env}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{BINDIR}\PYG{l+s}{"}\PYG{p}{]} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{/}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{prog}\PYG{p}{,} \PYG{l+m+mo}{0775}\PYG{p}{)}
        \PYG{n}{shutil}\PYG{o}{.}\PYG{n}{copy}\PYG{p}{(}\PYG{n}{data}\PYG{p}{,} \PYG{n}{env}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{LIBDIR}\PYG{l+s}{"}\PYG{p}{]}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{s3cmd}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{install} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py install --prefix=\PYGZdl{}PREFIX}\PYG{l+s}{"}

\PYG{k}{class} \PYG{n+nc}{docopt}\PYG{p}{(}\PYG{n}{Part}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{install} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{python setup.py install --prefix=\PYGZdl{}PREFIX}\PYG{l+s}{"}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.efetch}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-efetch}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{k+kn}{from} \PYG{n+nn}{Bio} \PYG{k+kn}{import} \PYG{n}{Entrez}

\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}

\PYG{n}{nc\PYGZus{}db} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{nuccore}\PYG{l+s}{"}
\PYG{n}{gb\PYGZus{}type} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{gb}\PYG{l+s}{"}
\PYG{n}{gb\PYGZus{}mode} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{text}\PYG{l+s}{"}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}nc\PYGZus{}id}\PYG{p}{(}\PYG{n}{accession}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{handle} \PYG{o}{=} \PYG{n}{Entrez}\PYG{o}{.}\PYG{n}{esearch}\PYG{p}{(}\PYG{n}{db}\PYG{o}{=}\PYG{n}{nc\PYGZus{}db}\PYG{p}{,} \PYG{n}{term}\PYG{o}{=}\PYG{n}{accession} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{[Accession]}\PYG{l+s}{"}\PYG{p}{)}
    \PYG{n}{id\PYGZus{}list} \PYG{o}{=} \PYG{n}{Entrez}\PYG{o}{.}\PYG{n}{read}\PYG{p}{(}\PYG{n}{handle}\PYG{p}{)}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{IdList}\PYG{l+s}{"}\PYG{p}{]}
    \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{id\PYGZus{}list}\PYG{p}{)} \PYG{o}{!=} \PYG{l+m+mi}{1}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{unexpected reply from Entrez: id\PYGZus{}list: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{id\PYGZus{}list}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{id\PYGZus{}list}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}

\PYG{k}{def} \PYG{n+nf}{fetch\PYGZus{}nc\PYGZus{}gb}\PYG{p}{(}\PYG{n}{gb\PYGZus{}id}\PYG{p}{,} \PYG{n}{out\PYGZus{}file}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{handle} \PYG{o}{=} \PYG{n}{Entrez}\PYG{o}{.}\PYG{n}{efetch}\PYG{p}{(}\PYG{n}{db}\PYG{o}{=}\PYG{n}{nc\PYGZus{}db}\PYG{p}{,} \PYG{n+nb}{id}\PYG{o}{=}\PYG{n}{gb\PYGZus{}id}\PYG{p}{,} \PYG{n}{rettype}\PYG{o}{=}\PYG{n}{gb\PYGZus{}type}\PYG{p}{,} \PYG{n}{retmode}\PYG{o}{=}\PYG{n}{gb\PYGZus{}mode}\PYG{p}{)}
    \PYG{k+kn}{from} \PYG{n+nn}{shutil} \PYG{k+kn}{import} \PYG{n}{copyfileobj} \PYG{k}{as} \PYG{n}{copy}
    \PYG{n}{copy}\PYG{p}{(}\PYG{n}{handle}\PYG{p}{,} \PYG{n}{out\PYGZus{}file}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.galaxy}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-galaxy}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{RNA-Seqlyze Galaxy Module}

\PYG{l+s+sd}{Shamelessly piggy-back onto Penn-State University's "Galaxy" Project.}

\PYG{l+s+sd}{RNA-Seqlyze needs a some publicly available Web-Space, which PSU provides}
\PYG{l+s+sd}{plenty of for bioinformatics reseach data (250.0 Gb per user as of 4 Jul 2012).}

\PYG{l+s+sd}{Thanks go to Penn-State University!}

\PYG{l+s+sd}{http://www.psu.edu/}

\PYG{l+s+sd}{"""}

\PYG{c}{\PYGZsh{} FIXME: the whole code here needs heavy refactoring}

\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{import} \PYG{n+nn}{os}\PYG{o}{,} \PYG{n+nn}{json}\PYG{o}{,} \PYG{n+nn}{time}\PYG{o}{,} \PYG{n+nn}{ftplib}\PYG{o}{,} \PYGZbs{}
       \PYG{n}{urllib}\PYG{p}{,} \PYG{n}{urllib2}\PYG{p}{,} \PYG{n}{cookielib}
\PYG{k+kn}{from} \PYG{n+nn}{threading} \PYG{k+kn}{import} \PYG{n}{local}
\PYG{k+kn}{from} \PYG{n+nn}{datetime} \PYG{k+kn}{import} \PYG{n}{datetime}\PYG{p}{,} \PYG{n}{timedelta}

\PYG{k+kn}{import} \PYG{n+nn}{lxml.html}

\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze} \PYG{k+kn}{import} \PYG{n}{multipart}

\PYG{n}{email} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{ucgxccgr@mailinator.com}\PYG{l+s}{'}
\PYG{n}{password} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{brtbhcdg}\PYG{l+s}{'}
\PYG{n}{api\PYGZus{}key} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{dddb2c53c96c0c4d263e6c74b507d203}\PYG{l+s}{'}
\PYG{n}{hostname} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{main.g2.bx.psu.edu}\PYG{l+s}{'}

\PYG{n}{default\PYGZus{}history} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{16f9a8e916e0e908}\PYG{l+s}{'}

\PYG{n}{default\PYGZus{}history\PYGZus{}url} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{https://main.g2.bx.psu.edu/u/dcgdftvcdv/h/rna-seqlyze}\PYG{l+s}{'}

\PYG{n}{history\PYGZus{}path\PYGZus{}template} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{/api/histories/\PYGZob{}history\PYGZcb{}/contents}\PYG{l+s}{'}
\PYG{n}{ucsc\PYGZus{}bam\PYGZus{}track\PYGZus{}template} \PYG{o}{=} \PYGZbs{}
        \PYG{l+s}{'}\PYG{l+s}{/display\PYGZus{}application/\PYGZob{}dataset\PYGZcb{}/ucsc\PYGZus{}bam/archaea/None/param/track}\PYG{l+s}{'}

\PYG{n}{ucsc\PYGZus{}bam\PYGZus{}path\PYGZus{}template} \PYG{o}{=} \PYGZbs{}
        \PYG{l+s}{'}\PYG{l+s}{/display\PYGZus{}application/\PYGZob{}dataset\PYGZcb{}/}\PYG{l+s}{'} \PYGZbs{}
        \PYG{l+s}{'}\PYG{l+s}{ucsc\PYGZus{}bam/archaea/None/data/galaxy\PYGZus{}\PYGZob{}dataset\PYGZcb{}.bam}\PYG{l+s}{'}

\PYG{n}{dataset\PYGZus{}info\PYGZus{}url\PYGZus{}template} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{/api/histories/\PYGZob{}history\PYGZcb{}/contents/\PYGZob{}dataset\PYGZcb{}}\PYG{l+s}{"}

\PYG{n}{dataset\PYGZus{}display\PYGZus{}url\PYGZus{}template} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{/datasets/\PYGZob{}dataset\PYGZcb{}/display}\PYG{l+s}{"}

\PYG{n}{rq\PYGZus{}headers} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}

\PYG{k}{class} \PYG{n+nc}{Session}\PYG{p}{(}\PYG{n}{local}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{cookies} \PYG{o}{=} \PYG{n+nb+bp}{None}
    \PYG{n}{created} \PYG{o}{=} \PYG{n+nb+bp}{None}

\PYG{n}{session} \PYG{o}{=} \PYG{n}{Session}\PYG{p}{(}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{api\PYGZus{}call}\PYG{p}{(}\PYG{n}{path}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{url} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{https://}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{hostname} \PYG{o}{+} \PYG{n}{path}
    \PYG{k}{return} \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{urlopen}\PYG{p}{(}\PYG{n}{url} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{?key=}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{api\PYGZus{}key}\PYG{p}{)}\PYG{o}{.}\PYG{n}{read}\PYG{p}{(}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{login}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{cookie\PYGZus{}jar} \PYG{o}{=} \PYG{n}{cookielib}\PYG{o}{.}\PYG{n}{CookieJar}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{install\PYGZus{}opener}\PYG{p}{(}\PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{build\PYGZus{}opener}\PYG{p}{(}
                    \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{HTTPCookieProcessor}\PYG{p}{(}\PYG{n}{cookie\PYGZus{}jar}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Loggin in to galaxy server }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ ...}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{hostname}\PYG{p}{)}
    \PYG{n}{login} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{https://}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{hostname} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{/user/login}\PYG{l+s}{"}
    \PYG{n}{rq} \PYG{o}{=} \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{Request}\PYG{p}{(}\PYG{n}{login}\PYG{p}{,} \PYG{n}{headers}\PYG{o}{=}\PYG{n}{rq\PYGZus{}headers}\PYG{p}{)}
    \PYG{n}{request} \PYG{o}{=} \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{urlopen}\PYG{p}{(}\PYG{n}{rq}\PYG{p}{)}
    \PYG{n}{doc} \PYG{o}{=} \PYG{n}{lxml}\PYG{o}{.}\PYG{n}{html}\PYG{o}{.}\PYG{n}{parse}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{o}{.}\PYG{n}{getroot}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{form} \PYG{o}{=} \PYG{n}{doc}\PYG{o}{.}\PYG{n}{forms}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{n}{form}\PYG{o}{.}\PYG{n}{fields}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{email}\PYG{l+s}{"}\PYG{p}{]} \PYG{o}{=} \PYG{n}{email}
    \PYG{n}{form}\PYG{o}{.}\PYG{n}{fields}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{password}\PYG{l+s}{"}\PYG{p}{]} \PYG{o}{=} \PYG{n}{password}
    \PYG{n}{submit} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{login\PYGZus{}button}\PYG{l+s}{"}\PYG{p}{,} \PYG{n}{form}\PYG{o}{.}\PYG{n}{fields}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{login\PYGZus{}button}\PYG{l+s}{"}\PYG{p}{]}
    \PYG{n}{data} \PYG{o}{=} \PYG{n}{urllib}\PYG{o}{.}\PYG{n}{urlencode}\PYG{p}{(}\PYG{n}{form}\PYG{o}{.}\PYG{n}{form\PYGZus{}values}\PYG{p}{(}\PYG{p}{)} \PYG{o}{+} \PYG{p}{[}\PYG{n}{submit}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{posting login form: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{form}\PYG{o}{.}\PYG{n}{action}\PYG{p}{)}
    \PYG{n}{rq} \PYG{o}{=} \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{Request}\PYG{p}{(}\PYG{n}{form}\PYG{o}{.}\PYG{n}{action}\PYG{p}{,} \PYG{n}{headers}\PYG{o}{=}\PYG{n}{rq\PYGZus{}headers}\PYG{p}{)}
    \PYG{n}{request} \PYG{o}{=} \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{urlopen}\PYG{p}{(}\PYG{n}{rq}\PYG{p}{,} \PYG{n}{data}\PYG{p}{)}
    \PYG{n}{doc} \PYG{o}{=} \PYG{n}{lxml}\PYG{o}{.}\PYG{n}{html}\PYG{o}{.}\PYG{n}{parse}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{o}{.}\PYG{n}{getroot}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Success!}\PYG{l+s}{"}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{cookie\PYGZus{}jar}

\PYG{k}{def} \PYG{n+nf}{import\PYGZus{}upload}\PYG{p}{(}\PYG{n}{filename}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{p}{(}\PYG{n}{session}\PYG{o}{.}\PYG{n}{created}
            \PYG{o+ow}{and} \PYG{n}{session}\PYG{o}{.}\PYG{n}{created} \PYG{o}{\textgreater{}} \PYG{p}{(}\PYG{n}{datetime}\PYG{o}{.}\PYG{n}{now}\PYG{p}{(}\PYG{p}{)} \PYG{o}{-} \PYG{n}{timedelta}\PYG{p}{(}\PYG{n}{minutes}\PYG{o}{=}\PYG{l+m+mi}{30}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{session}\PYG{o}{.}\PYG{n}{cookies} \PYG{o}{=} \PYG{n}{login}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{session}\PYG{o}{.}\PYG{n}{created} \PYG{o}{=} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{now}\PYG{p}{(}\PYG{p}{)}

    \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{install\PYGZus{}opener}\PYG{p}{(}\PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{build\PYGZus{}opener}\PYG{p}{(}
                    \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{HTTPCookieProcessor}\PYG{p}{(}\PYG{n}{session}\PYG{o}{.}\PYG{n}{cookies}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Importing ftp file}\PYG{l+s}{"}\PYG{p}{)}
    \PYG{n}{tool} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{https://}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{hostname} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{/tool\PYGZus{}runner?tool\PYGZus{}id=upload1}\PYG{l+s}{"}
    \PYG{n}{rq} \PYG{o}{=} \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{Request}\PYG{p}{(}\PYG{n}{tool}\PYG{p}{,} \PYG{n}{headers}\PYG{o}{=}\PYG{n}{rq\PYGZus{}headers}\PYG{p}{)}
    \PYG{n}{request} \PYG{o}{=} \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{urlopen}\PYG{p}{(}\PYG{n}{rq}\PYG{p}{)}
    \PYG{n}{doc} \PYG{o}{=} \PYG{n}{lxml}\PYG{o}{.}\PYG{n}{html}\PYG{o}{.}\PYG{n}{parse}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{o}{.}\PYG{n}{getroot}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{found} \PYG{o}{=} \PYG{n+nb+bp}{False}
    \PYG{n}{form} \PYG{o}{=} \PYG{n}{doc}\PYG{o}{.}\PYG{n}{forms}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
    \PYG{n}{inp} \PYG{o}{=} \PYG{n}{form}\PYG{o}{.}\PYG{n}{inputs}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{files\PYGZus{}0\textbar{}ftp\PYGZus{}files}\PYG{l+s}{"}\PYG{p}{]}
    \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{inp}\PYG{p}{,} \PYG{n}{lxml}\PYG{o}{.}\PYG{n}{html}\PYG{o}{.}\PYG{n}{InputElement}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{inp}\PYG{o}{.}\PYG{n}{attrib}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{value}\PYG{l+s}{'}\PYG{p}{]} \PYG{o}{==} \PYG{n}{filename}\PYG{p}{:}
            \PYG{n}{found} \PYG{o}{=} \PYG{n}{inp}\PYG{o}{.}\PYG{n}{checked} \PYG{o}{=} \PYG{n+nb+bp}{True}
    \PYG{k}{elif} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{inp}\PYG{p}{,} \PYG{n}{lxml}\PYG{o}{.}\PYG{n}{html}\PYG{o}{.}\PYG{n}{CheckboxGroup}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{box} \PYG{o+ow}{in} \PYG{n}{inp}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{box}\PYG{o}{.}\PYG{n}{attrib}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{value}\PYG{l+s}{'}\PYG{p}{]} \PYG{o}{==} \PYG{n}{filename}\PYG{p}{:}
                \PYG{n}{found} \PYG{o}{=} \PYG{n}{box}\PYG{o}{.}\PYG{n}{checked} \PYG{o}{=} \PYG{n+nb+bp}{True}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{unexpected html element: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{inp}\PYG{p}{)}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{found}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{file not available for import: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{filename}\PYG{p}{)}
    \PYG{n}{submit} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{runtool\PYGZus{}btn}\PYG{l+s}{"}\PYG{p}{,} \PYG{n}{form}\PYG{o}{.}\PYG{n}{fields}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{runtool\PYGZus{}btn}\PYG{l+s}{"}\PYG{p}{]}
    \PYG{n}{data} \PYG{o}{=} \PYG{n}{multipart}\PYG{o}{.}\PYG{n}{urlencode}\PYG{p}{(}\PYG{n}{form}\PYG{o}{.}\PYG{n}{form\PYGZus{}values}\PYG{p}{(}\PYG{p}{)} \PYG{o}{+} \PYG{p}{[}\PYG{n}{submit}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{posting upload form: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{form}\PYG{o}{.}\PYG{n}{action}\PYG{p}{)}
    \PYG{n}{rq} \PYG{o}{=} \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{Request}\PYG{p}{(}\PYG{n}{form}\PYG{o}{.}\PYG{n}{action}\PYG{p}{,} \PYG{n}{data}\PYG{p}{,} \PYG{n}{headers}\PYG{o}{=}\PYG{n}{rq\PYGZus{}headers}\PYG{p}{)}
    \PYG{n}{request} \PYG{o}{=} \PYG{n}{multipart}\PYG{o}{.}\PYG{n}{urlopen}\PYG{p}{(}\PYG{n}{rq}\PYG{p}{)}
    \PYG{n}{doc} \PYG{o}{=} \PYG{n}{lxml}\PYG{o}{.}\PYG{n}{html}\PYG{o}{.}\PYG{n}{parse}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{o}{.}\PYG{n}{getroot}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Success!}\PYG{l+s}{"}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{ftpupload}\PYG{p}{(}\PYG{n}{fileobj}\PYG{p}{,} \PYG{n}{filename}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    upload a file object to galaxy}
\PYG{l+s+sd}{    based on http://love-python.blogspot.com/2008/02/ftp-file-upload.html}
\PYG{l+s+sd}{    """}
    \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{uploading file to ftp server}\PYG{l+s}{"}\PYG{p}{)}
    \PYG{n}{ftp} \PYG{o}{=} \PYG{n}{ftplib}\PYG{o}{.}\PYG{n}{FTP}\PYG{p}{(}\PYG{n}{hostname}\PYG{p}{,} \PYG{n}{email}\PYG{p}{,} \PYG{n}{password}\PYG{p}{)}
    \PYG{n}{ftp}\PYG{o}{.}\PYG{n}{storbinary}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{STOR }\PYG{l+s}{'} \PYG{o}{+} \PYG{n}{filename}\PYG{p}{,} \PYG{n}{fileobj}\PYG{p}{)}
    \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Success!}\PYG{l+s}{"}\PYG{p}{)}
    \PYG{n}{ftp}\PYG{o}{.}\PYG{n}{quit}\PYG{p}{(}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{upload}\PYG{p}{(}\PYG{n}{fileobj}\PYG{p}{,} \PYG{n}{filename}\PYG{p}{)}\PYG{p}{:}

    \PYG{c}{\PYGZsh{} can't initialize this at module import time}
    \PYG{c}{\PYGZsh{} because rnaseqlyze.xxx properties not initialized}
    \PYG{k}{global} \PYG{n}{rq\PYGZus{}headers}
    \PYG{k}{try}\PYG{p}{:}
        \PYG{n}{mail} \PYG{o}{=} \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{admin\PYGZus{}email}
    \PYG{k}{except}\PYG{p}{:}
        \PYG{c}{\PYGZsh{} rnaseqlyze not .configure()d}
        \PYG{n}{mail} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{getenv}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{USER}\PYG{l+s}{"}\PYG{p}{)} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{@}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{os}\PYG{o}{.}\PYG{n}{uname}\PYG{p}{(}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
    \PYG{n}{rq\PYGZus{}headers} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s}{'}\PYG{l+s}{User-Agent}\PYG{l+s}{'}\PYG{p}{:} \PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ (version:}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ / admin:}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{)}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}
            \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{project\PYGZus{}name}\PYG{p}{,} \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}version\PYGZus{}\PYGZus{}}\PYG{p}{,} \PYG{n}{mail}\PYG{p}{)}\PYG{p}{,}
    \PYG{c}{\PYGZsh{}    'User-Agent': "Mozilla/5.0 (X11; Ubuntu; Linux x86\PYGZus{}64; rv:13.0)" \PYGZbs{}}
    \PYG{c}{\PYGZsh{}                  " Gecko/20100101 Firefox/13.0.1",}
    \PYG{p}{\PYGZcb{}}

    \PYG{n}{ftpupload}\PYG{p}{(}\PYG{n}{fileobj}\PYG{p}{,} \PYG{n}{filename}\PYG{p}{)}
    \PYG{n}{import\PYGZus{}upload}\PYG{p}{(}\PYG{n}{filename}\PYG{p}{)}
    \PYG{n}{datasets} \PYG{o}{=} \PYG{n}{json}\PYG{o}{.}\PYG{n}{loads}\PYG{p}{(}\PYG{n}{api\PYGZus{}call}\PYG{p}{(}
        \PYG{n}{history\PYGZus{}path\PYGZus{}template}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{history}\PYG{o}{=}\PYG{n}{default\PYGZus{}history}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    \PYG{c}{\PYGZsh{} assume objects are ordered chronologically...}
    \PYG{k}{for} \PYG{n}{dataset} \PYG{o+ow}{in} \PYG{n+nb}{reversed}\PYG{p}{(}\PYG{n}{datasets}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{dataset}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{name}\PYG{l+s}{'}\PYG{p}{]} \PYG{o}{==} \PYG{n}{filename}\PYG{p}{:}
            \PYG{k}{return} \PYG{n}{dataset}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{id}\PYG{l+s}{'}\PYG{p}{]}
    \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Couldn}\PYG{l+s}{'}\PYG{l+s}{t find id of uploaded file in dataset}\PYG{l+s}{"}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.gb2ptt}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-gb2ptt}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{import} \PYG{n+nn}{sys}

\PYG{k+kn}{from} \PYG{n+nn}{Bio} \PYG{k+kn}{import} \PYG{n}{SeqIO}
\PYG{k+kn}{from} \PYG{n+nn}{Bio.SeqFeature} \PYG{k+kn}{import} \PYG{n}{ExactPosition}

\PYG{k}{def} \PYG{n+nf}{gb2ptt}\PYG{p}{(}\PYG{n}{in\PYGZus{}file}\PYG{p}{,} \PYG{n}{out\PYGZus{}file}\PYG{p}{)}\PYG{p}{:}

    \PYG{n}{debug} \PYG{o}{=} \PYG{n+nb+bp}{False}

    \PYG{n}{seq} \PYG{o}{=} \PYG{n}{SeqIO}\PYG{o}{.}\PYG{n}{parse}\PYG{p}{(}\PYG{n}{in\PYGZus{}file}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{genbank}\PYG{l+s}{"}\PYG{p}{)}\PYG{o}{.}\PYG{n}{next}\PYG{p}{(}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} expected input:}
    \PYG{c}{\PYGZsh{}}
    \PYG{c}{\PYGZsh{} CDS 249..857}
    \PYG{c}{\PYGZsh{}     /locus\PYGZus{}tag="SSO0001"}
    \PYG{c}{\PYGZsh{}     /note="Predicted membrane protein, conserved in archaea"}
    \PYG{c}{\PYGZsh{}     /codon\PYGZus{}start=1}
    \PYG{c}{\PYGZsh{}     /transl\PYGZus{}table=11}
    \PYG{c}{\PYGZsh{}     /product="hypothetical protein"}
    \PYG{c}{\PYGZsh{}     /protein\PYGZus{}id="NP\PYGZus{}341578.1"}
    \PYG{c}{\PYGZsh{}     /db\PYGZus{}xref="GI:15896973"}
    \PYG{c}{\PYGZsh{}     /db\PYGZus{}xref="GeneID:1455258"}
    \PYG{c}{\PYGZsh{}     /translation="MITEFLLKKKLEEHLSHVKEENTIYVTDLVRCPRRVRYESEYKE}
    \PYG{c}{\PYGZsh{}     LAISQVYAPSAILGDILHLGLESVLKGNFNAETEVETLREINVGGKVYKIKGRADAII}
    \PYG{c}{\PYGZsh{}     RNDNGKSIVIEIKTSRSDKGLPLIHHKMQLQIYLWLFSAEKGILVYITPDRIAEYEIN}
    \PYG{c}{\PYGZsh{}     EPLDEATIVRLAEDTIMLQNSPRFNWECKYCIFSVICPAKLT"}

    \PYG{c}{\PYGZsh{} intended output:}
    \PYG{c}{\PYGZsh{}}
    \PYG{c}{\PYGZsh{} Sulfolobus solfataricus P2 chromosome, complete genome - 1..2992245}
    \PYG{c}{\PYGZsh{} 2978 proteins}
    \PYG{c}{\PYGZsh{} Location        Strand  Length  PID     }
    \PYG{c}{\PYGZsh{} 249..857        +       202     15896973}

    \PYG{c}{\PYGZsh{}        Gene    Synonym Code    COG     Product}
    \PYG{c}{\PYGZsh{}        -       SSO0001 -       COG1468L        hypothetical protein}

    \PYG{k+kn}{import} \PYG{n+nn}{csv}
    \PYG{n}{writer} \PYG{o}{=} \PYG{n}{csv}\PYG{o}{.}\PYG{n}{writer}\PYG{p}{(}\PYG{n}{out\PYGZus{}file}\PYG{p}{,} \PYG{n}{delimiter}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s+se}{\PYGZbs{}t}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{lineterminator}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{n}{writer}\PYG{o}{.}\PYG{n}{writerow}\PYG{p}{(}\PYG{p}{(}\PYG{n}{seq}\PYG{o}{.}\PYG{n}{description}\PYG{p}{,}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{writer}\PYG{o}{.}\PYG{n}{writerow}\PYG{p}{(}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{writer}\PYG{o}{.}\PYG{n}{writerow}\PYG{p}{(}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{Location}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{Strand}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{Length}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{PID}\PYG{l+s}{'}\PYG{p}{,}
                     \PYG{l+s}{'}\PYG{l+s}{Gene}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{Synonym}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{Code}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{COG}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{Product}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{)}

    \PYG{n}{n}\PYG{o}{=}\PYG{l+m+mi}{0}
    \PYG{k}{for} \PYG{n}{f} \PYG{o+ow}{in} \PYG{n}{seq}\PYG{o}{.}\PYG{n}{features}\PYG{p}{:}

        \PYG{n}{n}\PYG{o}{+}\PYG{o}{=}\PYG{l+m+mi}{1}
        \PYG{k}{if} \PYG{n}{debug} \PYG{o+ow}{and} \PYG{n}{n} \PYG{o}{\textgreater{}} \PYG{l+m+mi}{10}\PYG{p}{:}
            \PYG{k}{break}

        \PYG{k}{if} \PYG{n}{f}\PYG{o}{.}\PYG{n}{type} \PYG{o}{!=} \PYG{l+s}{'}\PYG{l+s}{CDS}\PYG{l+s}{'}\PYG{p}{:}
            \PYG{k}{continue}

        \PYG{k}{if} \PYG{n+nb}{type}\PYG{p}{(}\PYG{n}{f}\PYG{o}{.}\PYG{n}{location}\PYG{o}{.}\PYG{n}{start}\PYG{p}{)} \PYG{o}{!=} \PYG{n}{ExactPosition} \PYGZbs{}
           \PYG{o+ow}{or} \PYG{n+nb}{type}\PYG{p}{(}\PYG{n}{f}\PYG{o}{.}\PYG{n}{location}\PYG{o}{.}\PYG{n}{end}\PYG{p}{)} \PYG{o}{!=} \PYG{n}{ExactPosition}\PYG{p}{:}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{skipping non-exact location }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{ in }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}
                                                   \PYG{n}{f}\PYG{o}{.}\PYG{n}{location}\PYG{p}{,} \PYG{n}{f}\PYG{o}{.}\PYG{n}{type}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{continue}

        \PYG{n}{\PYGZus{}len} \PYG{o}{=} \PYG{n}{f}\PYG{o}{.}\PYG{n}{location}\PYG{o}{.}\PYG{n}{end}\PYG{o}{.}\PYG{n}{position} \PYG{o}{-} \PYG{n}{f}\PYG{o}{.}\PYG{n}{location}\PYG{o}{.}\PYG{n}{start}\PYG{o}{.}\PYG{n}{position}
        \PYG{k}{if} \PYG{n}{\PYGZus{}len} \PYG{o}{\textless{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{n}{\PYGZus{}len} \PYG{o}{=} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{seq}\PYG{o}{.}\PYG{n}{seq}\PYG{p}{)} \PYGZbs{}
                    \PYG{o}{-} \PYG{n}{f}\PYG{o}{.}\PYG{n}{location}\PYG{o}{.}\PYG{n}{start}\PYG{o}{.}\PYG{n}{position} \PYG{o}{+} \PYG{n}{f}\PYG{o}{.}\PYG{n}{location}\PYG{o}{.}\PYG{n}{end}\PYG{o}{.}\PYG{n}{position}
        \PYG{k}{if} \PYG{n}{\PYGZus{}len} \PYG{o}{\PYGZpc{}} \PYG{l+m+mi}{3}\PYG{p}{:}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{implausible feature length (}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{) in }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n}{\PYGZus{}len}\PYG{p}{,} \PYG{n}{f}\PYG{o}{.}\PYG{n}{type}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{\PYGZus{}len} \PYG{o}{/}\PYG{o}{/}\PYG{o}{=} \PYG{l+m+mi}{3} \PYG{c}{\PYGZsh{} integer division}
        \PYG{n}{\PYGZus{}len} \PYG{o}{-}\PYG{o}{=} \PYG{l+m+mi}{1} \PYG{c}{\PYGZsh{} omit stop codon}

        \PYG{n}{xrefs} \PYG{o}{=} \PYG{n+nb}{dict}\PYG{p}{(}\PYG{n+nb}{map}\PYG{p}{(}\PYG{k}{lambda} \PYG{n}{s}\PYG{p}{:} \PYG{n}{s}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{:}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{,} \PYG{n}{f}\PYG{o}{.}\PYG{n}{qualifiers}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{db\PYGZus{}xref}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{r} \PYG{o+ow}{in} \PYG{l+s}{'}\PYG{l+s}{GI}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{GeneID}\PYG{l+s}{'}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{r} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n}{xrefs}\PYG{p}{:}
                \PYG{n}{xrefs}\PYG{p}{[}\PYG{n}{r}\PYG{p}{]} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{-}\PYG{l+s}{'}

        \PYG{k}{for} \PYG{n}{q} \PYG{o+ow}{in} \PYG{l+s}{'}\PYG{l+s}{gene}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{product}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{locus\PYGZus{}tag}\PYG{l+s}{'}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{q} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n}{f}\PYG{o}{.}\PYG{n}{qualifiers}\PYG{p}{:}
                \PYG{n}{f}\PYG{o}{.}\PYG{n}{qualifiers}\PYG{p}{[}\PYG{n}{q}\PYG{p}{]} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{-}\PYG{l+s}{'}

        \PYG{c}{\PYGZsh{} need to convert between biopython (0-based, incl:excl)}
        \PYG{c}{\PYGZsh{} and genbank (1-based, incl:incl) position boundary notation here}
        \PYG{n}{writer}\PYG{o}{.}\PYG{n}{writerow}\PYG{p}{(}\PYG{p}{(}
            \PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{..}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n}{f}\PYG{o}{.}\PYG{n}{location}\PYG{o}{.}\PYG{n}{start}\PYG{o}{.}\PYG{n}{position}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{f}\PYG{o}{.}\PYG{n}{location}\PYG{o}{.}\PYG{n}{end}\PYG{o}{.}\PYG{n}{position}\PYG{p}{)}\PYG{p}{,}
            \PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{-}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{+}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{[}\PYG{p}{(}\PYG{n}{f}\PYG{o}{.}\PYG{n}{strand} \PYG{o}{+} \PYG{l+m+mi}{1}\PYG{p}{)} \PYG{o}{/} \PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,}
            \PYG{n}{\PYGZus{}len}\PYG{p}{,}
            \PYG{n}{xrefs}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{GI}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{,}
            \PYG{n}{f}\PYG{o}{.}\PYG{n}{qualifiers}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{gene}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}
            \PYG{n}{f}\PYG{o}{.}\PYG{n}{qualifiers}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{locus\PYGZus{}tag}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}
            \PYG{l+s}{'}\PYG{l+s}{-}\PYG{l+s}{'}\PYG{p}{,}
            \PYG{l+s}{'}\PYG{l+s}{-}\PYG{l+s}{'}\PYG{p}{,}
            \PYG{n}{f}\PYG{o}{.}\PYG{n}{qualifiers}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{product}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{p}{)}\PYG{p}{)}

    \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{wrote }\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{ rows}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{n}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.install}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-install}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{RNA-Seqlyze Install}

\PYG{l+s+sd}{This command builds and installs all software components}
\PYG{l+s+sd}{included with and required by the RNA-Seqlyze web application.}

\PYG{l+s+sd}{Usage:}
\PYG{l+s+sd}{    rnas-install}
\PYG{l+s+sd}{    rnas-install --prefix \textless{}dir\textgreater{}}
\PYG{l+s+sd}{    rnas-install -h\textbar{}--help}

\PYG{l+s+sd}{Note:}
\PYG{l+s+sd}{    The command has must run from the top level RNA-Seqlyze source directory.}

\PYG{l+s+sd}{Options:}
\PYG{l+s+sd}{    --prefix \textless{}dir\textgreater{}}
\PYG{l+s+sd}{                    The option is passed on to the ./configure and install}
\PYG{l+s+sd}{                    scripts of the various prorgams that this command installs.}
\PYG{l+s+sd}{                    The effect is, that all produced executables will be}
\PYG{l+s+sd}{                    installed under the that directory.}

\PYG{l+s+sd}{                    If not specified, defaults to {}`{}`\PYGZdl{}HOME/.local{}`{}`}

\PYG{l+s+sd}{.. important::}
\PYG{l+s+sd}{                    The {}`PREFIX{}` variable in the "/etc/init.d/rnaseqlyze.sh"}
\PYG{l+s+sd}{                    worker daemon startup script and the {}`prefix{}` variable}
\PYG{l+s+sd}{                    in the "/var/www/../rna-seqlyze.wsgi" script must both}
\PYG{l+s+sd}{                    be set to the directory specified here!}
\PYG{l+s+sd}{"""}

\PYG{k+kn}{import} \PYG{n+nn}{os}\PYG{o}{,} \PYG{n+nn}{re}
\PYG{k+kn}{from} \PYG{n+nn}{os} \PYG{k+kn}{import} \PYG{n}{environ} \PYG{k}{as} \PYG{n}{env}
\PYG{k+kn}{from} \PYG{n+nn}{os.path} \PYG{k+kn}{import} \PYG{n}{join}\PYG{p}{,} \PYG{n}{exists}

\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.build} \PYG{k+kn}{import} \PYG{n}{parts}\PYG{p}{,} \PYG{n}{phases}

\PYG{k}{def} \PYG{n+nf}{main}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{k+kn}{import} \PYG{n+nn}{docopt}
    \PYG{n}{opts} \PYG{o}{=} \PYG{n}{docopt}\PYG{o}{.}\PYG{n}{docopt}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}doc\PYGZus{}\PYGZus{}}\PYG{p}{)}

    \PYG{k}{assert} \PYG{n}{exists}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{src/rna-seqlyze/rnaseqlyze/\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}.py}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{,} \PYGZbs{}
    \PYG{l+s}{"}\PYG{l+s}{This command must be run from the top level RNA-Seqlyze source directory!}\PYG{l+s}{"}

    \PYG{n}{topdir} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{getcwd}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{prefix} \PYG{o}{=} \PYG{n}{opts}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{--prefix}\PYG{l+s}{'}\PYG{p}{]} \PYGZbs{}
             \PYG{o+ow}{or} \PYG{n}{join}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{getenv}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{HOME}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{.local}\PYG{l+s}{"}\PYG{p}{)}

    \PYG{n}{env}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{TOPDIR}\PYG{l+s}{"}\PYG{p}{]} \PYG{o}{=} \PYG{n}{topdir}
    \PYG{n}{env}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{PREFIX}\PYG{l+s}{"}\PYG{p}{]} \PYG{o}{=} \PYG{n}{prefix}
    \PYG{n}{env}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{BINDIR}\PYG{l+s}{"}\PYG{p}{]} \PYG{o}{=} \PYG{n}{prefix} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{/bin}\PYG{l+s}{"}
    \PYG{n}{env}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{LIBDIR}\PYG{l+s}{"}\PYG{p}{]} \PYG{o}{=} \PYG{n}{prefix} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{/lib}\PYG{l+s}{"}
    \PYG{n}{env}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{MACHTYPE}\PYG{l+s}{"}\PYG{p}{]} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{uname}\PYG{p}{(}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{4}\PYG{p}{]}
    \PYG{n}{env}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{ARCH}\PYG{l+s}{"}\PYG{p}{]} \PYG{o}{=} \PYG{n}{re}\PYG{o}{.}\PYG{n}{sub}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{i.86}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{i386}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{env}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{MACHTYPE}\PYG{l+s}{"}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{env}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{NCPUS\PYGZus{}ONLN}\PYG{l+s}{"}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{sysconf}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{SC\PYGZus{}NPROCESSORS\PYGZus{}ONLN}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}

    \PYG{k}{for} \PYG{n}{part} \PYG{o+ow}{in} \PYG{n}{parts}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{phase} \PYG{o+ow}{in} \PYG{n}{phases}\PYG{p}{:}
            \PYG{n}{part}\PYG{o}{.}\PYG{n}{execute}\PYG{p}{(}\PYG{n}{phase}\PYG{p}{)}

    \PYG{k}{print} \PYG{l+s}{"}\PYG{l+s}{RNA-Seqlyze sucessfully installed.}\PYG{l+s}{"}
    \PYG{k}{print}
    \PYG{k}{print} \PYG{l+s}{"}\PYG{l+s}{   PREFIX=}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{prefix}
    \PYG{k}{print}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.multipart}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-multipart}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{Multipart form-data handling}
\PYG{l+s+sd}{based on http://code.activestate.com/recipes/146306/}
\PYG{l+s+sd}{"""}
\PYG{k+kn}{import} \PYG{n+nn}{uuid}\PYG{o}{,} \PYG{n+nn}{urllib2}\PYG{o}{,} \PYG{n+nn}{mimetypes}

\PYG{k}{def} \PYG{n+nf}{urlopen}\PYG{p}{(}\PYG{n}{url}\PYG{p}{,} \PYG{n}{data}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{url}\PYG{p}{,} \PYG{n+nb}{basestring}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{rq} \PYG{o}{=} \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{Request}\PYG{p}{(}\PYG{n}{url}\PYG{p}{,} \PYG{n}{data}\PYG{p}{)}
    \PYG{k}{elif} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{url}\PYG{p}{,} \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{Request}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{rq} \PYG{o}{=} \PYG{n}{url}
        \PYG{n}{data} \PYG{o}{=} \PYG{n}{rq}\PYG{o}{.}\PYG{n}{data}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{'}\PYG{l+s}{url}\PYG{l+s}{'}\PYG{l+s}{ parameter must be a string or urllib2.Request}\PYG{l+s}{"}\PYG{p}{)}

    \PYG{k}{try}\PYG{p}{:}
        \PYG{n}{boundary} \PYG{o}{=} \PYG{n}{data}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{:}\PYG{n}{data}\PYG{o}{.}\PYG{n}{index}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s+se}{\PYGZbs{}r}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{]}
    \PYG{k}{except} \PYG{n+ne}{ValueError}\PYG{p}{,} \PYG{n}{e}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{couldn}\PYG{l+s}{'}\PYG{l+s}{t find boundary string in data}\PYG{l+s}{"}\PYG{p}{,} \PYG{n}{e}\PYG{p}{)}
    \PYG{n}{rq}\PYG{o}{.}\PYG{n}{add\PYGZus{}header}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{Content-Type}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{multipart/form-data; boundary=}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'} \PYG{o}{\PYGZpc{}} \PYG{n}{boundary}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{urlopen}\PYG{p}{(}\PYG{n}{rq}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{urlencode}\PYG{p}{(}\PYG{n}{fields}\PYG{p}{,} \PYG{n}{files}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    :param asd:}
\PYG{l+s+sd}{      is a sequence of {}`{}`(name, value){}`{}` elements for regular form fields.}

\PYG{l+s+sd}{    :param files:}
\PYG{l+s+sd}{      is a sequence of {}`{}`(name, filename, value){}`{}`}
\PYG{l+s+sd}{      elements for data to be uploaded as files}

\PYG{l+s+sd}{    :returns:}
\PYG{l+s+sd}{      {}`{}`str{}`{}` of **multipart/form-data** encoded fields + files}
\PYG{l+s+sd}{    """}
    \PYG{n}{boundary} \PYG{o}{=} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{uuid}\PYG{o}{.}\PYG{n}{uuid4}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{data} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{k}{for} \PYG{p}{(}\PYG{n}{key}\PYG{p}{,} \PYG{n}{value}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n}{fields}\PYG{p}{:}
        \PYG{n}{data}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{--}\PYG{l+s}{'} \PYG{o}{+} \PYG{n}{boundary}\PYG{p}{)}
        \PYG{n}{data}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{Content-Disposition: form-data; name=}\PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"}\PYG{l+s}{'} \PYG{o}{\PYGZpc{}} \PYG{n}{key}\PYG{p}{)}
        \PYG{n}{data}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{'}\PYG{p}{)}
        \PYG{n}{data}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{value}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{files}\PYG{p}{:}
        \PYG{k}{for} \PYG{p}{(}\PYG{n}{key}\PYG{p}{,} \PYG{n}{filename}\PYG{p}{,} \PYG{n}{value}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n}{files}\PYG{p}{:}
            \PYG{n}{data}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{--}\PYG{l+s}{'} \PYG{o}{+} \PYG{n}{boundary}\PYG{p}{)}
            \PYG{n}{data}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{Content-Disposition: form-data}\PYG{l+s}{'} \PYGZbs{}
                            \PYG{l+s}{'}\PYG{l+s}{; name=}\PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"}\PYG{l+s}{; filename=}\PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"}\PYG{l+s}{'} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n}{key}\PYG{p}{,} \PYG{n}{filename}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{data}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{Content-Type: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'} \PYG{o}{\PYGZpc{}} \PYG{n}{get\PYGZus{}content\PYGZus{}type}\PYG{p}{(}\PYG{n}{filename}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{data}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{'}\PYG{p}{)}
            \PYG{n}{data}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{value}\PYG{p}{)}
    \PYG{n}{data}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{--}\PYG{l+s}{'} \PYG{o}{+} \PYG{n}{boundary} \PYG{o}{+} \PYG{l+s}{'}\PYG{l+s}{--}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{n}{data}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{'}\PYG{p}{)}

    \PYG{k}{return} \PYG{l+s}{'}\PYG{l+s+se}{\PYGZbs{}r}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{'}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{data}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}content\PYGZus{}type}\PYG{p}{(}\PYG{n}{filename}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n}{mimetypes}\PYG{o}{.}\PYG{n}{guess\PYGZus{}type}\PYG{p}{(}\PYG{n}{filename}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o+ow}{or} \PYG{l+s}{'}\PYG{l+s}{application/octet-stream}\PYG{l+s}{'}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.org\_cache}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-org-cache}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{RNA-Seqlyze keeps a cache of organisms available}
\PYG{l+s+sd}{in the UCSC Browser. In addition to that, for each of}
\PYG{l+s+sd}{those organisms, the matching refseq accession is cached.}
\PYG{l+s+sd}{"""}
\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{import} \PYG{n+nn}{csv}
\PYG{k+kn}{import} \PYG{n+nn}{difflib}
\PYG{k+kn}{from} \PYG{n+nn}{pkg\PYGZus{}resources} \PYG{k+kn}{import} \PYG{n}{resource\PYGZus{}stream}

\PYG{k+kn}{from} \PYG{n+nn}{Bio} \PYG{k+kn}{import} \PYG{n}{Entrez}

\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze} \PYG{k+kn}{import} \PYG{n}{ucscbrowser}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core.entities} \PYG{k+kn}{import} \PYG{n}{UCSCOrganism}

\PYG{n}{prokaryotes\PYGZus{}tsv} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{refseq-data/prokaryotes.txt}\PYG{l+s}{"}

\PYG{k}{def} \PYG{n+nf}{refresh}\PYG{p}{(}\PYG{n}{db\PYGZus{}session}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Refresh the organism cache.}

\PYG{l+s+sd}{    The cache is initialized from the list of organisms available in the}
\PYG{l+s+sd}{    UCSC genome browser. A list of rnaseqlyze.orm.UCSCOrganism's is}
\PYG{l+s+sd}{    retrieved by calling rnaseqlyze.ucscbrowser.get\PYGZus{}org\PYGZus{}list().}

\PYG{l+s+sd}{    The retrieved list is not ready to be .add()ed to the :param:db\PYGZus{}session}
\PYG{l+s+sd}{    however, because the objects' primary keys, the refseq accession,}
\PYG{l+s+sd}{    are still missing.}

\PYG{l+s+sd}{    Those are determined by parsing the list of gomplete genomes available in}
\PYG{l+s+sd}{    the ncbi "genome" database, which is stored in}

\PYG{l+s+sd}{        rnaseqlyze/refseq-data/prokaryotes.txt}

\PYG{l+s+sd}{    The file was retrieved from}

\PYG{l+s+sd}{        ftp://ftp.ncbi.nih.gov/genomes/GENOME\PYGZus{}REPORTS/prokaryotes.txt}

\PYG{l+s+sd}{    on Mon, 02 Jul 2012.}

\PYG{l+s+sd}{    Once found, the rnaseqlyze.orm.UCSCOrganism objects are updated with the}
\PYG{l+s+sd}{    refseq accessions and .add()ed to the passed :param:db\PYGZus{}session.}
\PYG{l+s+sd}{    """}

    \PYG{n}{organisms} \PYG{o}{=} \PYG{n}{ucscbrowser}\PYG{o}{.}\PYG{n}{get\PYGZus{}org\PYGZus{}list}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{accessions} \PYG{o}{=} \PYG{n}{get\PYGZus{}accessions}\PYG{p}{(}\PYG{p}{)}

    \PYG{k}{for} \PYG{n}{org} \PYG{o+ow}{in} \PYG{n}{organisms}\PYG{p}{:}
        \PYG{n}{ot} \PYG{o}{=} \PYG{n}{org}\PYG{o}{.}\PYG{n}{title}
        \PYG{k}{for} \PYG{n}{gt}\PYG{p}{,} \PYG{n}{acc} \PYG{o+ow}{in} \PYG{n}{accessions}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{ot} \PYG{o}{==} \PYG{n}{gt}\PYG{p}{:}
                \PYG{n}{org}\PYG{o}{.}\PYG{n}{acc} \PYG{o}{=} \PYG{n}{acc}
                \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{n}{org}\PYG{p}{)}

    \PYG{n}{not\PYGZus{}found} \PYG{o}{=} \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{organisms}\PYG{p}{)} \PYG{o}{-} \PYGZbs{}
                \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{UCSCOrganism}\PYG{p}{)}\PYG{o}{.}\PYG{n}{all}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} try fuzzy-matching the title}
    \PYG{c}{\PYGZsh{} of those organisms that were not found}
    \PYG{k}{for} \PYG{n}{org} \PYG{o+ow}{in} \PYG{n}{not\PYGZus{}found}\PYG{p}{:}
        \PYG{n}{ot} \PYG{o}{=} \PYG{n}{org}\PYG{o}{.}\PYG{n}{title}
        \PYG{n}{best\PYGZus{}ratio} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{n}{best\PYGZus{}match} \PYG{o}{=} \PYG{n+nb+bp}{None}
        \PYG{k}{for} \PYG{n}{gt}\PYG{p}{,} \PYG{n}{acc} \PYG{o+ow}{in} \PYG{n}{accessions}\PYG{p}{:}
            \PYG{n}{ratio} \PYG{o}{=} \PYG{n}{difflib}\PYG{o}{.}\PYG{n}{SequenceMatcher}\PYG{p}{(}\PYG{n+nb+bp}{None}\PYG{p}{,} \PYG{n}{ot}\PYG{p}{,} \PYG{n}{gt}\PYG{p}{)}\PYG{o}{.}\PYG{n}{ratio}\PYG{p}{(}\PYG{p}{)}
            \PYG{k}{if} \PYG{n}{ratio} \PYG{o}{\textgreater{}} \PYG{n}{best\PYGZus{}ratio}\PYG{p}{:}
                \PYG{n}{best\PYGZus{}ratio} \PYG{o}{=} \PYG{n}{ratio}
                \PYG{n}{best\PYGZus{}match} \PYG{o}{=} \PYG{n}{acc}
                \PYG{n}{best\PYGZus{}match\PYGZus{}t} \PYG{o}{=} \PYG{n}{gt}

        \PYG{k}{if} \PYG{n}{best\PYGZus{}ratio} \PYG{o}{\textgreater{}} \PYG{l+m+mf}{0.8}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{UCSCOrganism}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{best\PYGZus{}match}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{NOT using }\PYG{l+s}{'}\PYG{l+s}{\PYGZob{}match\PYGZcb{}}\PYG{l+s}{'}\PYG{l+s}{ for }\PYG{l+s}{'}\PYG{l+s}{\PYGZob{}org\PYGZcb{}}\PYG{l+s}{'}\PYG{l+s}{"}
                           \PYG{l+s}{"}\PYG{l+s}{ despite match ratio of: \PYGZob{}ratio\PYGZcb{}}\PYG{l+s}{"}\PYG{p}{)}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}
                               \PYG{n}{match}\PYG{o}{=}\PYG{n}{best\PYGZus{}match\PYGZus{}t}\PYG{p}{,} \PYG{n}{org}\PYG{o}{=}\PYG{n}{ot}\PYG{p}{,} \PYG{n}{ratio}\PYG{o}{=}\PYG{n}{best\PYGZus{}ratio}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{using }\PYG{l+s}{'}\PYG{l+s}{\PYGZob{}match\PYGZcb{}}\PYG{l+s}{'}\PYG{l+s}{ for }\PYG{l+s}{'}\PYG{l+s}{\PYGZob{}org\PYGZcb{}}\PYG{l+s}{'}\PYG{l+s}{"}
                          \PYG{l+s}{"}\PYG{l+s}{ match ratio: \PYGZob{}ratio\PYGZcb{}}\PYG{l+s}{"}\PYG{p}{)}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}
                               \PYG{n}{match}\PYG{o}{=}\PYG{n}{best\PYGZus{}match\PYGZus{}t}\PYG{p}{,} \PYG{n}{org}\PYG{o}{=}\PYG{n}{ot}\PYG{p}{,} \PYG{n}{ratio}\PYG{o}{=}\PYG{n}{best\PYGZus{}ratio}\PYG{p}{)}\PYG{p}{)}
                \PYG{n}{org}\PYG{o}{.}\PYG{n}{acc} \PYG{o}{=} \PYG{n}{best\PYGZus{}match}
                \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{n}{org}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{warn}\PYG{p}{(}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{'}\PYG{l+s}{\PYGZob{}org\PYGZcb{}}\PYG{l+s}{'}\PYG{l+s}{ not found in NCBI }\PYG{l+s}{'}\PYG{l+s}{genome}\PYG{l+s}{'}\PYG{l+s}{ database}\PYG{l+s}{"}
                      \PYG{l+s}{"}\PYG{l+s}{ (best match ratio only \PYGZob{}ratio\PYGZcb{})}\PYG{l+s}{"}\PYG{p}{)}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}
                          \PYG{n}{org}\PYG{o}{=}\PYG{n}{ot}\PYG{p}{,} \PYG{n}{ratio}\PYG{o}{=}\PYG{n}{best\PYGZus{}ratio}\PYG{p}{)}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} make sure that that regular expression in views.post() that translates}
    \PYG{c}{\PYGZsh{} the 'org\PYGZus{}accession' from 'title (db/accession)', as generated in}
    \PYG{c}{\PYGZsh{} rnaseqlyze.create.js, back to 'accession' doesn't fail}
    \PYG{k}{for} \PYG{n}{org} \PYG{o+ow}{in} \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{UCSCOrganism}\PYG{p}{)}\PYG{o}{.}\PYG{n}{all}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n+nb}{any}\PYG{p}{(}\PYG{n}{needle} \PYG{o+ow}{in} \PYG{n}{heystack}
                    \PYG{k}{for} \PYG{n}{needle} \PYG{o+ow}{in} \PYG{l+s}{'}\PYG{l+s}{()}\PYG{l+s}{'}
                    \PYG{k}{for} \PYG{n}{heystack} \PYG{o+ow}{in} \PYG{p}{(}\PYG{n}{org}\PYG{o}{.}\PYG{n}{db}\PYG{p}{,} \PYG{n}{org}\PYG{o}{.}\PYG{n}{acc}\PYG{p}{,} \PYG{n}{org}\PYG{o}{.}\PYG{n}{title}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{warn}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Droping organism with parentesis}\PYG{l+s}{"}
                     \PYG{l+s}{"}\PYG{l+s}{ to avoid problems in parsing auto}\PYG{l+s}{"}
                     \PYG{l+s}{"}\PYG{l+s}{completed form input in views.post()}\PYG{l+s}{"}\PYG{p}{)}
            \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{expunge}\PYG{p}{(}\PYG{n}{org}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}accessions}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}

    \PYG{n}{data\PYGZus{}file} \PYG{o}{=} \PYG{n}{resource\PYGZus{}stream}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{,} \PYG{n}{prokaryotes\PYGZus{}tsv}\PYG{p}{)}
    \PYG{n}{reader} \PYG{o}{=} \PYG{n}{csv}\PYG{o}{.}\PYG{n}{reader}\PYG{p}{(}\PYG{n}{data\PYGZus{}file}\PYG{p}{,} \PYG{n}{delimiter}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s+se}{\PYGZbs{}t}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{n}{headings} \PYG{o}{=} \PYG{n}{reader}\PYG{o}{.}\PYG{n}{next}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{colnums} \PYG{o}{=} \PYG{n+nb}{dict}\PYG{p}{(}\PYG{n+nb}{zip}\PYG{p}{(}\PYG{n}{headings}\PYG{p}{,} \PYG{n+nb}{map}\PYG{p}{(}\PYG{n}{headings}\PYG{o}{.}\PYG{n}{index}\PYG{p}{,} \PYG{n}{headings}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
    \PYG{c}{\PYGZsh{} -\textgreater{} \PYGZob{} '\PYGZsh{}Organism/Name': 0, ..., 'Chromosomes/RefSeq': 7 \PYGZcb{}}
    \PYG{n}{ret} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{cols} \PYG{o+ow}{in} \PYG{n}{reader}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{cols}\PYG{p}{[}\PYG{n}{colnums}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{Chromosomes/RefSeq}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{]} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{-}\PYG{l+s}{'}\PYG{p}{:}
            \PYG{k}{continue}
        \PYG{n}{ret}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{(}\PYG{n}{cols}\PYG{p}{[}\PYG{n}{colnums}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{\PYGZsh{}Organism/Name}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{]}\PYG{p}{,}
                    \PYG{n}{cols}\PYG{p}{[}\PYG{n}{colnums}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{Chromosomes/RefSeq}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{ret}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.s3}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-s3}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{Upload files to Amazon S* using the s3cmd tools}

\PYG{l+s+sd}{The access credentials must be configured in \PYGZti{}/.s3cfg .}
\PYG{l+s+sd}{The s3cmd creates this file interactively with the --configure option.}
\PYG{l+s+sd}{"""}

\PYG{c}{\PYGZsh{}: The s3 bucket name in "S3Uri" format}
\PYG{n}{base\PYGZus{}uri} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{s3://biocalc/}\PYG{l+s}{"}

\PYG{k+kn}{import} \PYG{n+nn}{os}

\PYG{c}{\PYGZsh{} import this to fix a circular import dependency problem in s3cmd ...}
\PYG{k+kn}{import} \PYG{n+nn}{S3.Exceptions}

\PYG{k+kn}{from} \PYG{n+nn}{S3.S3} \PYG{k+kn}{import} \PYG{n}{S3}
\PYG{k+kn}{from} \PYG{n+nn}{S3.Config} \PYG{k+kn}{import} \PYG{n}{Config}
\PYG{k+kn}{from} \PYG{n+nn}{S3.S3Uri} \PYG{k+kn}{import} \PYG{n}{S3Uri}
\PYG{k+kn}{from} \PYG{n+nn}{S3.SortedDict} \PYG{k+kn}{import} \PYG{n}{SortedDict}

\PYG{c}{\PYGZsh{} same "interface" like rnaseqlyze.galaxy}
\PYG{k}{def} \PYG{n+nf}{upload}\PYG{p}{(}\PYG{n}{fileobj}\PYG{p}{,} \PYG{n}{filename}\PYG{p}{)}\PYG{p}{:}

    \PYG{n}{cfg} \PYG{o}{=} \PYG{n}{Config}\PYG{p}{(}\PYG{p}{)}

    \PYG{n}{cfg}\PYG{o}{.}\PYG{n}{read\PYGZus{}config\PYGZus{}file}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{getenv}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{HOME}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{.s3cfg}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{cfg}\PYG{o}{.}\PYG{n}{progress\PYGZus{}meter} \PYG{o}{=} \PYG{n+nb+bp}{False}
    \PYG{n}{cfg}\PYG{o}{.}\PYG{n}{acl\PYGZus{}public} \PYG{o}{=} \PYG{n+nb+bp}{True}

    \PYG{n}{s3} \PYG{o}{=} \PYG{n}{S3}\PYG{p}{(}\PYG{n}{cfg}\PYG{p}{)}

    \PYG{n}{headers} \PYG{o}{=} \PYG{n}{SortedDict}\PYG{p}{(}\PYG{n}{ignore\PYGZus{}case} \PYG{o}{=} \PYG{n+nb+bp}{True}\PYG{p}{)}
    \PYG{n}{headers}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{x-amz-acl}\PYG{l+s}{"}\PYG{p}{]} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{public-read}\PYG{l+s}{"}
    \PYG{n}{headers}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{x-amz-storage-class}\PYG{l+s}{"}\PYG{p}{]} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{REDUCED\PYGZus{}REDUNDANCY}\PYG{l+s}{"}

    \PYG{n}{remote\PYGZus{}uri} \PYG{o}{=} \PYG{n}{S3Uri}\PYG{p}{(}\PYG{n}{base\PYGZus{}uri} \PYG{o}{+} \PYG{n}{filename}\PYG{p}{)}

    \PYG{n}{fileobj}\PYG{o}{.}\PYG{n}{seek}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,}\PYG{l+m+mi}{2}\PYG{p}{)} \PYG{c}{\PYGZsh{} seek to end}
    \PYG{n}{size} \PYG{o}{=} \PYG{n}{fileobj}\PYG{o}{.}\PYG{n}{tell}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{fileobj}\PYG{o}{.}\PYG{n}{seek}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)} \PYG{c}{\PYGZsh{} seek to start}

    \PYG{n}{response} \PYG{o}{=} \PYG{n}{s3}\PYG{o}{.}\PYG{n}{send\PYGZus{}file\PYGZus{}multipart}\PYG{p}{(}\PYG{n}{fileobj}\PYG{p}{,} \PYG{n}{headers}\PYG{p}{,} \PYG{n}{remote\PYGZus{}uri}\PYG{p}{,} \PYG{n}{size}\PYG{p}{)}

    \PYG{k}{assert} \PYG{n}{response}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{status}\PYG{l+s}{'}\PYG{p}{]} \PYG{o}{==} \PYG{l+m+mi}{200}

    \PYG{k}{return} \PYG{n}{remote\PYGZus{}uri}\PYG{o}{.}\PYG{n}{public\PYGZus{}url}\PYG{p}{(}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.transterm}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-transterm}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{A module to run transterm\PYGZus{}hp}
\PYG{l+s+sd}{"""}

\PYG{k+kn}{import} \PYG{n+nn}{os}\PYG{o}{,} \PYG{n+nn}{subprocess}
\PYG{k+kn}{from} \PYG{n+nn}{subprocess} \PYG{k+kn}{import} \PYG{n}{PIPE}

\PYG{k}{def} \PYG{n+nf}{run}\PYG{p}{(}\PYG{n}{args}\PYG{p}{,} \PYG{n}{out}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{,} \PYG{n}{err}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Run transterm\PYGZus{}hp with the given arguments plus "-p expterm.dat"}
\PYG{l+s+sd}{    """}
    \PYG{k}{def} \PYG{n+nf}{findit}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{path} \PYG{o+ow}{in} \PYG{n}{os}\PYG{o}{.}\PYG{n}{getenv}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{PATH}\PYG{l+s}{"}\PYG{p}{)}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{pathsep}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{name} \PYG{o+ow}{in} \PYG{n}{os}\PYG{o}{.}\PYG{n}{listdir}\PYG{p}{(}\PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{path}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{../lib}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
                \PYG{k}{if} \PYG{n}{name} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{expterm.dat}\PYG{l+s}{'}\PYG{p}{:}
                    \PYG{k}{return} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{path}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{../lib}\PYG{l+s}{"}\PYG{p}{,} \PYG{n}{name}\PYG{p}{)}
    \PYG{n}{expterm\PYGZus{}dat} \PYG{o}{=} \PYG{n}{findit}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{expterm\PYGZus{}dat}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{'}\PYG{l+s}{expterm.dat}\PYG{l+s}{'}\PYG{l+s}{ not found}\PYG{l+s}{"}\PYG{p}{)}
    \PYG{n}{cmd} \PYG{o}{=} \PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{transterm}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{-p}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{expterm\PYGZus{}dat}\PYG{p}{)} \PYG{o}{+} \PYG{n+nb}{tuple}\PYG{p}{(}\PYG{n}{args}\PYG{p}{)}
    \PYG{n}{proc} \PYG{o}{=} \PYG{n}{subprocess}\PYG{o}{.}\PYG{n}{Popen}\PYG{p}{(}\PYG{n}{cmd}\PYG{p}{,} \PYG{n}{stdout}\PYG{o}{=}\PYG{n}{out}\PYG{p}{,} \PYG{n}{stderr}\PYG{o}{=}\PYG{n}{err}\PYG{p}{)}
    \PYG{n}{proc}\PYG{o}{.}\PYG{n}{wait}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{proc}\PYG{o}{.}\PYG{n}{returncode} \PYG{o}{!=} \PYG{l+m+mi}{0}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{cmd}\PYG{p}{)} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{ failed}\PYG{l+s}{"}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{tt2bed}\PYG{p}{(}\PYG{n}{tt\PYGZus{}output}\PYG{p}{,} \PYG{n}{bed\PYGZus{}file}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{for} \PYG{n+nb}{id}\PYG{p}{,} \PYG{n}{begin}\PYG{p}{,} \PYG{n}{end}\PYG{p}{,} \PYG{n}{strand}\PYG{p}{,} \PYG{n}{confidence} \PYG{o+ow}{in} \PYG{n}{iterator}\PYG{p}{(}\PYG{n}{tt\PYGZus{}output}\PYG{p}{)}\PYG{p}{:}
        \PYG{c}{\PYGZsh{} let color vary from 0 (black) to 100 (gray)}
        \PYG{n}{rgb\PYGZus{}color} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{,}\PYG{l+s}{'}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{str}\PYG{p}{(}\PYG{l+m+mi}{100} \PYG{o}{-} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{confidence}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}\PYG{p}{)}\PYG{o}{*}\PYG{l+m+mi}{3}\PYG{p}{)}
        \PYG{k}{print} \PYG{o}{\textgreater{}\textgreater{}} \PYG{n}{bed\PYGZus{}file}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s+se}{\PYGZbs{}t}\PYG{l+s}{'}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{p}{(}
            \PYG{l+s}{'}\PYG{l+s}{chr}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{begin}\PYG{p}{,} \PYG{n}{end}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{TERM\PYGZus{}}\PYG{l+s}{'} \PYG{o}{+} \PYG{n+nb}{id}\PYG{p}{,}
            \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{confidence}\PYG{p}{)}\PYG{p}{,} \PYG{n}{strand}\PYG{p}{,} \PYG{n}{begin}\PYG{p}{,} \PYG{n}{end}\PYG{p}{,} \PYG{n}{rgb\PYGZus{}color}
        \PYG{p}{)}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{iterator}\PYG{p}{(}\PYG{n}{tt\PYGZus{}output}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{for} \PYG{n}{line} \PYG{o+ow}{in} \PYG{n}{tt\PYGZus{}output}\PYG{p}{:}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{line}\PYG{o}{.}\PYG{n}{startswith}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{  TERM}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{continue}
        \PYG{n}{TERM}\PYG{p}{,} \PYG{n+nb}{id}\PYG{p}{,} \PYG{n}{begin}\PYG{p}{,} \PYG{n}{dash}\PYG{p}{,} \PYG{n}{end}\PYG{p}{,} \PYGZbs{}
              \PYG{n}{strand}\PYG{p}{,} \PYG{n}{position}\PYG{p}{,} \PYG{n}{confidence}\PYG{p}{,} \PYG{n}{rest} \PYG{o}{=} \PYG{n}{line}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{n+nb+bp}{None}\PYG{p}{,} \PYG{l+m+mi}{8}\PYG{p}{)}
        \PYG{c}{\PYGZsh{} switch begin \& end on reverse strand}
        \PYG{k}{if} \PYG{n}{strand} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{-}\PYG{l+s}{'}\PYG{p}{:}
            \PYG{n}{begin}\PYG{p}{,} \PYG{n}{end} \PYG{o}{=} \PYG{n}{end}\PYG{p}{,} \PYG{n}{begin}
        \PYG{k}{yield} \PYG{n+nb}{id}\PYG{p}{,} \PYG{n}{begin}\PYG{p}{,} \PYG{n}{end}\PYG{p}{,} \PYG{n}{strand}\PYG{p}{,} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{confidence}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.ucscbrowser}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-ucscbrowser}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{Tools to deal with the UCSC genome browser at http://archaea.ucsc.edu/}
\PYG{l+s+sd}{"""}
\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{from} \PYG{n+nn}{json} \PYG{k+kn}{import} \PYG{n}{load}
\PYG{k+kn}{from} \PYG{n+nn}{urllib2} \PYG{k+kn}{import} \PYG{n}{urlopen}
\PYG{k+kn}{from} \PYG{n+nn}{urlparse} \PYG{k+kn}{import} \PYG{n}{urljoin}
\PYG{k+kn}{from} \PYG{n+nn}{StringIO} \PYG{k+kn}{import} \PYG{n}{StringIO}
\PYG{k+kn}{from} \PYG{n+nn}{shutil} \PYG{k+kn}{import} \PYG{n}{copyfileobj}
\PYG{k+kn}{from} \PYG{n+nn}{os} \PYG{k+kn}{import} \PYG{n}{listdir}\PYG{p}{,} \PYG{n}{makedirs}
\PYG{k+kn}{from} \PYG{n+nn}{os.path} \PYG{k+kn}{import} \PYG{n}{join}\PYG{p}{,} \PYG{n}{dirname}\PYG{p}{,} \PYG{n}{isdir}

\PYG{k+kn}{from} \PYG{n+nn}{lxml.html} \PYG{k+kn}{import} \PYG{n}{parse}
\PYG{k+kn}{from} \PYG{n+nn}{lxml.etree} \PYG{k+kn}{import} \PYG{n}{dump}

\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core} \PYG{k+kn}{import} \PYG{n}{security}
\PYG{c}{\PYGZsh{} delay import because of a}
\PYG{c}{\PYGZsh{} circular import dependency ...}
\PYG{c}{\PYGZsh{}from rnaseqlyze.core.entities import UCSCOrganism}

\PYG{n}{cart\PYGZus{}reset\PYGZus{}url} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{http://archaea.ucsc.edu/cgi-bin/cartReset}\PYG{l+s}{"}
\PYG{n}{custom\PYGZus{}track\PYGZus{}url} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{http://archaea.ucsc.edu/cgi-bin/hgTracks}\PYG{l+s}{"}
\PYG{n}{custom\PYGZus{}track\PYGZus{}params} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{?db=\PYGZob{}org\PYGZus{}db\PYGZcb{}\&hgt.customText=\PYGZob{}track\PYGZus{}url\PYGZcb{}}\PYG{l+s}{"}

\PYG{k}{class} \PYG{n+nc}{BigDataTrack}\PYG{p}{(}\PYG{n+nb}{str}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    A UCSC "Big Data Track"}

\PYG{l+s+sd}{    You should pass a 'name' and a 'url'}
\PYG{l+s+sd}{    keyword argument to the constructor.}
\PYG{l+s+sd}{    """}

    \PYG{n}{template} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{track type=}\PYG{l+s}{"}\PYG{l+s}{\PYGZob{}type\PYGZcb{}}\PYG{l+s}{"}\PYG{l+s}{ name=}\PYG{l+s}{"}\PYG{l+s}{\PYGZob{}name\PYGZcb{}}\PYG{l+s}{"}\PYG{l+s}{ bigDataUrl=}\PYG{l+s}{"}\PYG{l+s}{\PYGZob{}url\PYGZcb{}}\PYG{l+s}{"}\PYG{l+s}{'}

    \PYG{n}{\PYGZus{}\PYGZus{}new\PYGZus{}\PYGZus{}} \PYG{o}{=} \PYG{k}{lambda} \PYG{n}{cls}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{:} \PYG{n}{cls}\PYG{o}{.}\PYG{n}{template}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n+nb}{type}\PYG{o}{=}\PYG{n}{cls}\PYG{o}{.}\PYG{n}{type}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{BAMTrack}\PYG{p}{(}\PYG{n}{BigDataTrack}\PYG{p}{)}\PYG{p}{:} \PYG{n+nb}{type} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{bam}\PYG{l+s}{"}
\PYG{k}{class} \PYG{n+nc}{BigWigTrack}\PYG{p}{(}\PYG{n}{BigDataTrack}\PYG{p}{)}\PYG{p}{:} \PYG{n+nb}{type} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{bigWig}\PYG{l+s}{"}
\PYG{k}{class} \PYG{n+nc}{BigBedTrack}\PYG{p}{(}\PYG{n}{BigDataTrack}\PYG{p}{)}\PYG{p}{:} \PYG{n+nb}{type} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{bigBed}\PYG{l+s}{"}

\PYG{c}{\PYGZsh{} FIXME:}
\PYG{c}{\PYGZsh{}    The org\PYGZus{}list\PYGZus{}default\PYGZus{}dir = dirname(\PYGZus{}\PYGZus{}file\PYGZus{}\PYGZus{})}
\PYG{c}{\PYGZsh{}    hack will not work if the distribution is installed}
\PYG{c}{\PYGZsh{}    as a zipped .egg. pkg\PYGZus{}resources.resource\PYGZus{}stream or}
\PYG{c}{\PYGZsh{}    pkg\PYGZus{}resources.resource\PYGZus{}string should be used instead.}
\PYG{n}{org\PYGZus{}list\PYGZus{}base\PYGZus{}url} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{http://archaea.ucsc.edu/wp-content/data/}\PYG{l+s}{"}
\PYG{n}{org\PYGZus{}list\PYGZus{}default\PYGZus{}dir} \PYG{o}{=} \PYG{n}{join}\PYG{p}{(}\PYG{n}{dirname}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}file\PYGZus{}\PYGZus{}}\PYG{p}{)}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{ucscbrowser-data}\PYG{l+s}{"}\PYG{p}{)}
\PYG{n}{json\PYGZus{}links\PYGZus{}file\PYGZus{}name} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{ucsc-wp-data.html}\PYG{l+s}{"}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}org\PYGZus{}list}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{global} \PYG{n}{UCSCOrganism}
    \PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core.entities} \PYG{k+kn}{import} \PYG{n}{UCSCOrganism}

    \PYG{k}{global} \PYG{n}{org\PYGZus{}list\PYGZus{}cache\PYGZus{}dir}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb}{hasattr}\PYG{p}{(}\PYG{n}{rnaseqlyze}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{ucsc\PYGZus{}org\PYGZus{}list\PYGZus{}cache\PYGZus{}dir}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{rnaseqlyze.configure(workdir) }\PYG{l+s}{"}
                        \PYG{l+s}{"}\PYG{l+s}{must be called before calling this function}\PYG{l+s}{"}\PYG{p}{)}
    \PYG{n}{org\PYGZus{}list\PYGZus{}cache\PYGZus{}dir} \PYG{o}{=} \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{ucsc\PYGZus{}org\PYGZus{}list\PYGZus{}cache\PYGZus{}dir}

    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{isdir}\PYG{p}{(}\PYG{n}{org\PYGZus{}list\PYGZus{}cache\PYGZus{}dir}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{makedirs}\PYG{p}{(}\PYG{n}{org\PYGZus{}list\PYGZus{}cache\PYGZus{}dir}\PYG{p}{)}

    \PYG{n}{orgs} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{k}{for} \PYG{n}{org} \PYG{o+ow}{in} \PYG{n}{get\PYGZus{}organisms}\PYG{p}{(}\PYG{n}{get\PYGZus{}json\PYGZus{}files}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{existing} \PYG{o+ow}{in} \PYG{n}{orgs}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{existing}\PYG{o}{.}\PYG{n}{title} \PYG{o}{==} \PYG{n}{org}\PYG{o}{.}\PYG{n}{title}\PYG{p}{:}
                \PYG{n}{log}\PYG{o}{.}\PYG{n}{warn}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{ already present (db: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{/}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{)}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYGZbs{}
                                    \PYG{p}{(}\PYG{n}{org}\PYG{o}{.}\PYG{n}{title}\PYG{p}{,} \PYG{n}{org}\PYG{o}{.}\PYG{n}{db}\PYG{p}{,} \PYG{n}{existing}\PYG{o}{.}\PYG{n}{db}\PYG{p}{)}\PYG{p}{)}
                \PYG{k}{break}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n}{orgs}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{org}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{orgs}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}json\PYGZus{}files}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}

    \PYG{n}{json\PYGZus{}links\PYGZus{}file} \PYG{o}{=} \PYG{n+nb+bp}{None}
    \PYG{n}{json\PYGZus{}files} \PYG{o}{=} \PYG{n+nb+bp}{None}

    \PYG{k}{for} \PYG{n}{get\PYGZus{}json\PYGZus{}links\PYGZus{}file} \PYG{o+ow}{in} \PYG{p}{(}\PYG{n}{get\PYGZus{}json\PYGZus{}links\PYGZus{}file\PYGZus{}web}\PYG{p}{,}
                                \PYG{n}{get\PYGZus{}json\PYGZus{}links\PYGZus{}file\PYGZus{}cache}\PYG{p}{,}
                                \PYG{n}{get\PYGZus{}json\PYGZus{}links\PYGZus{}file\PYGZus{}default}\PYG{p}{,}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{try}\PYG{p}{:}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{trying }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{get\PYGZus{}json\PYGZus{}links\PYGZus{}file}\PYG{o}{.}\PYG{n}{func\PYGZus{}name}\PYG{p}{)}
            \PYG{n}{json\PYGZus{}links\PYGZus{}file} \PYG{o}{=} \PYG{n}{get\PYGZus{}json\PYGZus{}links\PYGZus{}file}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{except} \PYG{n+ne}{Exception}\PYG{p}{,} \PYG{n}{e}\PYG{p}{:}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{warn}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ failed: }\PYG{l+s+si}{\PYGZpc{}r}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n}{get\PYGZus{}json\PYGZus{}links\PYGZus{}file}\PYG{o}{.}\PYG{n}{func\PYGZus{}name}\PYG{p}{,} \PYG{n}{e}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{continue}
        
        \PYG{k}{for} \PYG{n}{get\PYGZus{}json\PYGZus{}files} \PYG{o+ow}{in} \PYG{p}{(}\PYG{n}{get\PYGZus{}get\PYGZus{}json\PYGZus{}files\PYGZus{}web}\PYG{p}{(}\PYG{n}{json\PYGZus{}links\PYGZus{}file}\PYG{p}{)}\PYG{p}{,}
                               \PYG{n}{get\PYGZus{}json\PYGZus{}files\PYGZus{}cache}\PYG{p}{,}
                               \PYG{n}{get\PYGZus{}json\PYGZus{}files\PYGZus{}default}\PYG{p}{,}\PYG{p}{)}\PYG{p}{:}

            \PYG{k}{try}\PYG{p}{:}
                \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{trying }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{get\PYGZus{}json\PYGZus{}files}\PYG{o}{.}\PYG{n}{func\PYGZus{}name}\PYG{p}{)}
                \PYG{k}{return} \PYG{n}{get\PYGZus{}json\PYGZus{}files}\PYG{p}{(}\PYG{p}{)}
            \PYG{k}{except} \PYG{n+ne}{Exception}\PYG{p}{,} \PYG{n}{e}\PYG{p}{:}
                \PYG{n}{log}\PYG{o}{.}\PYG{n}{warn}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ failed: }\PYG{l+s+si}{\PYGZpc{}r}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n}{get\PYGZus{}json\PYGZus{}files}\PYG{o}{.}\PYG{n}{func\PYGZus{}name}\PYG{p}{,} \PYG{n}{e}\PYG{p}{)}\PYG{p}{)}
    
    \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Couldn}\PYG{l+s}{'}\PYG{l+s}{t get json organism lists}\PYG{l+s}{"}\PYG{p}{)}

\PYG{c}{\PYGZsh{} getting the links file}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}json\PYGZus{}links\PYGZus{}file\PYGZus{}web}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{json\PYGZus{}links\PYGZus{}file} \PYG{o}{=} \PYG{n}{StringIO}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{copyfileobj}\PYG{p}{(}\PYG{n}{urlopen}\PYG{p}{(}\PYG{n}{org\PYGZus{}list\PYGZus{}base\PYGZus{}url}\PYG{p}{)}\PYG{p}{,} \PYG{n}{json\PYGZus{}links\PYGZus{}file}\PYG{p}{)}
    \PYG{n}{json\PYGZus{}links\PYGZus{}file}\PYG{o}{.}\PYG{n}{seek}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{json\PYGZus{}links\PYGZus{}file}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}json\PYGZus{}links\PYGZus{}file\PYGZus{}cache}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n}{org\PYGZus{}list\PYGZus{}cache\PYGZus{}dir}\PYG{p}{,} \PYG{n}{json\PYGZus{}links\PYGZus{}file\PYGZus{}name}\PYG{p}{)}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}json\PYGZus{}links\PYGZus{}file\PYGZus{}default}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{return} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n}{org\PYGZus{}list\PYGZus{}default\PYGZus{}dir}\PYG{p}{,} \PYG{n}{json\PYGZus{}links\PYGZus{}file\PYGZus{}name}\PYG{p}{)}\PYG{p}{)}


\PYG{c}{\PYGZsh{} getting json files}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}get\PYGZus{}json\PYGZus{}files\PYGZus{}web}\PYG{p}{(}\PYG{n}{json\PYGZus{}links\PYGZus{}file}\PYG{p}{)}\PYG{p}{:}

    \PYG{k}{def} \PYG{n+nf}{get\PYGZus{}json\PYGZus{}files\PYGZus{}web}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{e} \PYG{o+ow}{in} \PYG{n}{parse}\PYG{p}{(}\PYG{n}{json\PYGZus{}links\PYGZus{}file}\PYG{p}{)}\PYG{o}{.}\PYG{n}{getroot}\PYG{p}{(}\PYG{p}{)}\PYG{o}{.}\PYG{n}{iter}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{a}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{link} \PYG{o}{=} \PYG{n}{e}\PYG{o}{.}\PYG{n}{attrib}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{href}\PYG{l+s}{'}\PYG{p}{]}
            \PYG{k}{if} \PYG{n}{link}\PYG{o}{.}\PYG{n}{endswith}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{.json}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{security}\PYG{o}{.}\PYG{n}{check\PYGZus{}valid\PYGZus{}filename}\PYG{p}{(}\PYG{n}{link}\PYG{p}{)}
                \PYG{c}{\PYGZsh{} FIXME: The json files should also be returned as StringIO}
                \PYG{c}{\PYGZsh{}        buffers only and the cache files shouldn't be}
                \PYG{c}{\PYGZsh{}        overwritten until it is certain that the newly}
                \PYG{c}{\PYGZsh{}        downloaded files contain the expected data}
                \PYG{n}{json\PYGZus{}file} \PYG{o}{=} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n}{org\PYGZus{}list\PYGZus{}cache\PYGZus{}dir}\PYG{p}{,} \PYG{n}{link}\PYG{p}{)}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w+}\PYG{l+s}{"}\PYG{p}{)}
                \PYG{n}{copyfileobj}\PYG{p}{(}\PYG{n}{urlopen}\PYG{p}{(}\PYG{n}{urljoin}\PYG{p}{(}
                        \PYG{n}{org\PYGZus{}list\PYGZus{}base\PYGZus{}url}\PYG{p}{,} \PYG{n}{link}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,} \PYG{n}{json\PYGZus{}file}\PYG{p}{)}
                \PYG{n}{json\PYGZus{}file}\PYG{o}{.}\PYG{n}{seek}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
                \PYG{k}{yield} \PYG{n}{json\PYGZus{}file}

        \PYG{k}{try}\PYG{p}{:}
            \PYG{n}{json\PYGZus{}links\PYGZus{}file}\PYG{o}{.}\PYG{n}{fileno}\PYG{p}{(}\PYG{p}{)}
            \PYG{c}{\PYGZsh{} json\PYGZus{}links\PYGZus{}file was defaults or cached}
        \PYG{k}{except}\PYG{p}{:}
            \PYG{c}{\PYGZsh{} json\PYGZus{}links\PYGZus{}file was a memory buffer - save it because}
            \PYG{c}{\PYGZsh{} if this code is is reached, it means there was no error,}
            \PYG{c}{\PYGZsh{} in the code above, so the buffer likely contains good links}
            \PYG{n}{json\PYGZus{}links\PYGZus{}file}\PYG{o}{.}\PYG{n}{seek}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
            \PYG{n}{copyfileobj}\PYG{p}{(}\PYG{n}{json\PYGZus{}links\PYGZus{}file}\PYG{p}{,} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}
                    \PYG{n}{org\PYGZus{}list\PYGZus{}cache\PYGZus{}dir}\PYG{p}{,} \PYG{n}{json\PYGZus{}links\PYGZus{}file\PYGZus{}name}\PYG{p}{)}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}

    \PYG{k}{return} \PYG{n}{get\PYGZus{}json\PYGZus{}files\PYGZus{}web}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}json\PYGZus{}files\PYGZus{}cache}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{for} \PYG{n}{json} \PYG{o+ow}{in} \PYG{n}{listdir}\PYG{p}{(}\PYG{n}{org\PYGZus{}list\PYGZus{}cache\PYGZus{}dir}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{json}\PYG{o}{.}\PYG{n}{endswith}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{.json}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{yield} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n}{org\PYGZus{}list\PYGZus{}cache\PYGZus{}dir}\PYG{p}{,} \PYG{n}{json}\PYG{p}{)}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}json\PYGZus{}files\PYGZus{}default}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{for} \PYG{n}{json} \PYG{o+ow}{in} \PYG{n}{listdir}\PYG{p}{(}\PYG{n}{org\PYGZus{}list\PYGZus{}default\PYGZus{}dir}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{json}\PYG{o}{.}\PYG{n}{endswith}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{.json}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{yield} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n}{org\PYGZus{}list\PYGZus{}default\PYGZus{}dir}\PYG{p}{,} \PYG{n}{json}\PYG{p}{)}\PYG{p}{)}


\PYG{c}{\PYGZsh{} creating UCSCOrganism objects from json files}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}organisms}\PYG{p}{(}\PYG{n}{json\PYGZus{}files}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{for} \PYG{n}{json\PYGZus{}file} \PYG{o+ow}{in} \PYG{n}{json\PYGZus{}files}\PYG{p}{:}
        \PYG{k}{for} \PYG{n+nb}{object} \PYG{o+ow}{in} \PYG{n}{load}\PYG{p}{(}\PYG{n}{json\PYGZus{}file}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{child} \PYG{o+ow}{in} \PYG{n+nb}{object}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{children}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{:}
                \PYG{k}{for} \PYG{n}{grandchild} \PYG{o+ow}{in} \PYG{n}{child}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{children}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{:}
                    \PYG{k}{if} \PYG{n}{grandchild}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{attr}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{rel}\PYG{l+s}{'}\PYG{p}{]} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{genome}\PYG{l+s}{'}\PYG{p}{:}
                        \PYG{k}{yield} \PYG{n}{UCSCOrganism}\PYG{p}{(}\PYG{n}{db}\PYG{o}{=}\PYG{n}{grandchild}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{attr}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{id}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{,}
                                           \PYG{n}{title}\PYG{o}{=}\PYG{n}{grandchild}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{data}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{title}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{)}
\end{Verbatim}


\subsubsection{Package \texttt{rnaseqlyze.core}}
\label{rnaseqlyze-pdf:package-rnaseqlyze-core}

\paragraph{Modul \texttt{rnaseqlyze.core}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-core}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{Core functionality}
\PYG{l+s+sd}{"""}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.core.analysis}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-core-analysis}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{Property getters and methods for Analysis instances}
\PYG{l+s+sd}{"""}

\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{import} \PYG{n+nn}{os}
\PYG{k+kn}{from} \PYG{n+nn}{os.path} \PYG{k+kn}{import} \PYG{n}{join}\PYG{p}{,} \PYG{n}{exists}
\PYG{k+kn}{import} \PYG{n+nn}{datetime}
\PYG{k+kn}{from} \PYG{n+nn}{urllib} \PYG{k+kn}{import} \PYG{n}{quote}

\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy} \PYG{k+kn}{import} \PYG{n}{ForeignKey}
\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy} \PYG{k+kn}{import} \PYG{n}{Table}\PYG{p}{,} \PYG{n}{Column}
\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy} \PYG{k+kn}{import} \PYG{n}{Boolean}\PYG{p}{,} \PYG{n}{Integer}\PYG{p}{,} \PYG{n}{String}\PYG{p}{,} \PYG{n}{Text}\PYG{p}{,} \PYG{n}{DateTime}
\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy.orm} \PYG{k+kn}{import} \PYG{n}{relationship}\PYG{p}{,} \PYG{n}{backref}\PYG{p}{,} \PYG{n}{validates}
\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy.orm.properties} \PYG{k+kn}{import} \PYG{n}{RelationshipProperty}
\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy.ext.declarative} \PYG{k+kn}{import} \PYG{n}{declared\PYGZus{}attr}\PYG{p}{,} \PYG{n}{declarative\PYGZus{}base}

\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze} \PYG{k+kn}{import} \PYG{n}{galaxy}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze} \PYG{k+kn}{import} \PYG{n}{ucscbrowser}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core} \PYG{k+kn}{import} \PYG{n}{security}

\PYG{k}{class} \PYG{n+nc}{Methods}\PYG{p}{(}\PYG{n+nb}{object}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Here the various analysis configurations are handled}
\PYG{l+s+sd}{    as transparently as possible. The properties should be}
\PYG{l+s+sd}{    seasy to deal with so the worker.core code doesn't get too hairy.}

\PYG{l+s+sd}{    .. note::}

\PYG{l+s+sd}{        Weather the input is an SRR identifier or a sra/fastq file is}
\PYG{l+s+sd}{        distinguished by checking "self.inputfile\PYGZus{}name == None" in at least}
\PYG{l+s+sd}{            - the Worker}
\PYG{l+s+sd}{            - the analysis.pt template}
\PYG{l+s+sd}{            - in this file}

\PYG{l+s+sd}{    .. note::}

\PYG{l+s+sd}{        Weather the organism input is a NCBI RefSeq accession or a genbank file}
\PYG{l+s+sd}{        is distinguished by checking "self.genbankfile\PYGZus{}name == None" in at least}
\PYG{l+s+sd}{            - the Worker}
\PYG{l+s+sd}{            - the analysis.pt template}
\PYG{l+s+sd}{            - in this file}
\PYG{l+s+sd}{    """}

    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{Methods}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{creation\PYGZus{}date} \PYG{o}{=} \PYG{n}{datetime}\PYG{o}{.}\PYG{n}{datetime}\PYG{o}{.}\PYG{n}{utcnow}\PYG{p}{(}\PYG{p}{)}

    \PYG{k}{def} \PYG{n+nf}{create\PYGZus{}data\PYGZus{}dir}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{isdir}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{os}\PYG{o}{.}\PYG{n}{makedirs}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} org\PYGZus{}db and hg\PYGZus{}url (which depends upon org\PYGZus{}db) are not set}
    \PYG{c}{\PYGZsh{} as a db attribute, so old analyses where the organism was not}
    \PYG{c}{\PYGZsh{} known at creation time automatically get the right url set if the}
    \PYG{c}{\PYGZsh{} organism later on becomes available in the UCSC Browser}

    \PYG{k}{def} \PYG{n+nf}{get\PYGZus{}hg\PYGZus{}url}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{org\PYGZus{}db}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}hg\PYGZus{}text}\PYG{p}{:}
            \PYG{k}{return}
        \PYG{n}{hg\PYGZus{}url} \PYG{o}{=} \PYG{n}{ucscbrowser}\PYG{o}{.}\PYG{n}{custom\PYGZus{}track\PYGZus{}url} \PYG{o}{+} \PYGZbs{}
                    \PYG{n}{ucscbrowser}\PYG{o}{.}\PYG{n}{custom\PYGZus{}track\PYGZus{}params}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}
                        \PYG{n}{org\PYGZus{}db}\PYG{o}{=}\PYG{n}{org\PYGZus{}db}\PYG{p}{,} \PYG{n}{track\PYGZus{}url}\PYG{o}{=}\PYG{n}{quote}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hg\PYGZus{}url}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{hg\PYGZus{}url}

    \PYG{k}{def} \PYG{n+nf}{get\PYGZus{}galaxy\PYGZus{}id}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{name}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{ds} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}datasets}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{ds}\PYG{o}{.}\PYG{n}{name} \PYG{o}{==} \PYG{n}{name}\PYG{p}{:}
                \PYG{k}{return} \PYG{n}{ds}

\PYG{k}{class} \PYG{n+nc}{Properties}\PYG{p}{(}\PYG{n+nb}{object}\PYG{p}{)}\PYG{p}{:}

    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    .. note::}

\PYG{l+s+sd}{        - {}`input{}` means {}`short reads data{}`}
\PYG{l+s+sd}{        - {}`genbank{}` means {}`"genome" database nucleotide sequence{}`}
\PYG{l+s+sd}{    """}

\PYG{c}{\PYGZsh{} data uploaded or id specified ?}
\PYG{c}{\PYGZsh{} -------------------------------}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{inputfile\PYGZus{}uploaded}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}inputfile\PYGZus{}name} \PYG{o+ow}{and} \PYG{n+nb+bp}{True}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{genbankfile\PYGZus{}uploaded}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}genbankfile\PYGZus{}name} \PYG{o+ow}{and} \PYG{n+nb+bp}{True}

\PYG{c}{\PYGZsh{} directories}
\PYG{c}{\PYGZsh{} -----------}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{data\PYGZus{}dir}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{join}\PYG{p}{(}\PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{analyses\PYGZus{}path}\PYG{p}{,} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}\PYG{p}{)}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{input\PYGZus{}data\PYGZus{}dir}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}uploaded}\PYG{p}{:}
            \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rnaseq\PYGZus{}run}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{genbank\PYGZus{}data\PYGZus{}dir}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}uploaded}\PYG{p}{:}
            \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{return} \PYG{n}{join}\PYG{p}{(}\PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{shared\PYGZus{}data\PYGZus{}path}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{org\PYGZus{}accession}\PYG{p}{)}

\PYG{c}{\PYGZsh{} short reads files}
\PYG{c}{\PYGZsh{} -----------------}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{inputfile\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}inputfile\PYGZus{}name} \PYGZbs{}
                \PYG{o+ow}{or} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rnaseq\PYGZus{}run} \PYG{o+ow}{and} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{rnaseq\PYGZus{}run}\PYG{o}{.}\PYG{n}{srr} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{.sra}\PYG{l+s}{"}

    \PYG{n+nd}{@inputfile\PYGZus{}name.setter}
    \PYG{k}{def} \PYG{n+nf}{inputfile\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{value}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}inputfile\PYGZus{}name} \PYG{o}{=} \PYG{n}{value}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{inputfile\PYGZus{}path}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}data\PYGZus{}dir}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}name}\PYG{p}{)}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{inputfile\PYGZus{}base\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}name}\PYG{o}{.}\PYG{n}{rsplit}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{.}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{inputfile\PYGZus{}fq\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}base\PYGZus{}name} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{.fastq}\PYG{l+s}{"}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{inputfile\PYGZus{}fq\PYGZus{}path}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{input\PYGZus{}data\PYGZus{}dir}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}fq\PYGZus{}name}\PYG{p}{)}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{inputfile\PYGZus{}header}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{exists}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}fq\PYGZus{}path}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{return}
        \PYG{n}{fq\PYGZus{}file} \PYG{o}{=} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}fq\PYGZus{}path}\PYG{p}{)}
        \PYG{n}{lines} \PYG{o}{=} \PYG{p}{[}\PYG{n}{fq\PYGZus{}file}\PYG{o}{.}\PYG{n}{readline}\PYG{p}{(}\PYG{p}{)} \PYG{k}{for} \PYG{n}{i} \PYG{o+ow}{in} \PYG{n+nb}{range}\PYG{p}{(}\PYG{l+m+mi}{4}\PYG{p}{)}\PYG{p}{]}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Header: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{lines}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{fq\PYGZus{}file}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{return} \PYG{l+s}{"}\PYG{l+s}{"}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{lines}\PYG{p}{)}

\PYG{c}{\PYGZsh{} organism files}
\PYG{c}{\PYGZsh{} --------------}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{genbankfile\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}genbankfile\PYGZus{}name} \PYGZbs{}
                \PYG{o+ow}{or} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{org\PYGZus{}accession} \PYG{o+ow}{and} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{org\PYGZus{}accession} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{.gb}\PYG{l+s}{"}

    \PYG{n+nd}{@genbankfile\PYGZus{}name.setter}
    \PYG{k}{def} \PYG{n+nf}{genbankfile\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{value}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}genbankfile\PYGZus{}name} \PYG{o}{=} \PYG{n}{value}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{genbankfile\PYGZus{}path}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}data\PYGZus{}dir}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}name}\PYG{p}{)}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{genbankfile\PYGZus{}base\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}name}\PYG{o}{.}\PYG{n}{rsplit}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{.}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{genbankfile\PYGZus{}fa\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}base\PYGZus{}name} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{.fa}\PYG{l+s}{"}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{genbankfile\PYGZus{}fa\PYGZus{}path}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}data\PYGZus{}dir}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}fa\PYGZus{}name}\PYG{p}{)}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{xgenbankfile\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}base\PYGZus{}name} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{.augmented.gb}\PYG{l+s}{"}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{xgenbankfile\PYGZus{}path}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{xgenbankfile\PYGZus{}name}\PYG{p}{)}

\PYG{c}{\PYGZsh{} magic galaxy\PYGZus{}xxx attributes}
\PYG{c}{\PYGZsh{} ---------------------------}

    \PYG{n}{galaxy\PYGZus{}stuff} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{hg\PYGZus{}text bam coverage hp\PYGZus{}terms pr\PYGZus{}operons}\PYG{l+s}{"}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{p}{)}

    \PYG{k}{for} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n}{galaxy\PYGZus{}stuff}\PYG{p}{:} \PYG{k}{exec} \PYG{l+s}{"""}\PYG{l+s}{if True: \PYGZsh{} just to enable indentation ...}
\PYG{l+s}{        @declared\PYGZus{}attr}
\PYG{l+s}{        def galaxy\PYGZus{}}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{(self):}
\PYG{l+s}{            return relationship(}\PYG{l+s}{"}\PYG{l+s}{GalaxyDataset}\PYG{l+s}{"}\PYG{l+s}{,}
\PYG{l+s}{                                 uselist=False, primaryjoin=}\PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"}\PYG{l+s}{)}\PYG{l+s}{"""} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n}{x}\PYG{p}{,}

                \PYG{l+s}{"}\PYG{l+s}{and\PYGZus{}(GalaxyDataset.type == }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{, }\PYG{l+s}{"}
                     \PYG{l+s}{"}\PYG{l+s}{Analysis.id == GalaxyDataset.analysis\PYGZus{}id)}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{x}\PYG{p}{)}
    \PYG{k}{del} \PYG{n}{x}
    \PYG{n+nd}{@validates}\PYG{p}{(}\PYG{o}{*}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{galaxy\PYGZus{}}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{x} \PYG{k}{for} \PYG{n}{x} \PYG{o+ow}{in} \PYG{n}{galaxy\PYGZus{}stuff}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}set\PYGZus{}galaxy\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{attr}\PYG{p}{,} \PYG{n}{dataset}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{dataset}\PYG{o}{.}\PYG{n}{type}\PYG{o}{=}\PYG{n}{attr}\PYG{p}{[}\PYG{l+m+mi}{7}\PYG{p}{:}\PYG{p}{]}
        \PYG{k}{return} \PYG{n}{dataset}

\PYG{c}{\PYGZsh{} other things}
\PYG{c}{\PYGZsh{} ------------}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{hg\PYGZus{}url}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}hg\PYGZus{}text}\PYG{p}{:}
            \PYG{k}{return}
        \PYG{k}{return} \PYG{l+s}{"}\PYG{l+s}{https://}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{hostname} \PYGZbs{}
                    \PYG{o}{+} \PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{dataset\PYGZus{}display\PYGZus{}url\PYGZus{}template} \PYGZbs{}
                        \PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{dataset}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}hg\PYGZus{}text}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{data\PYGZus{}dir\PYGZus{}state}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb}{hash}\PYG{p}{(}\PYG{n+nb}{tuple}\PYG{p}{(}\PYG{p}{(}\PYG{n}{x}\PYG{p}{,}\PYG{n+nb}{tuple}\PYG{p}{(}\PYG{n}{y}\PYG{p}{)}\PYG{p}{,}\PYG{n+nb}{tuple}\PYG{p}{(}\PYG{n}{z}\PYG{p}{)}\PYG{p}{)}
                          \PYG{k}{for} \PYG{n}{x}\PYG{p}{,} \PYG{n}{y}\PYG{p}{,} \PYG{n}{z} \PYG{o+ow}{in} \PYG{n}{os}\PYG{o}{.}\PYG{n}{walk}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{stage\PYGZus{}logs\PYGZus{}state}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb}{hash}\PYG{p}{(}\PYG{n+nb}{tuple}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{stage\PYGZus{}logs}\PYG{p}{)}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{Validators}\PYG{p}{(}\PYG{n+nb}{object}\PYG{p}{)}\PYG{p}{:}
    \PYG{n+nd}{@validates}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{org\PYGZus{}accession}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{k}{def} \PYG{n+nf}{validate\PYGZus{}org\PYGZus{}accession}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{attr}\PYG{p}{,} \PYG{n}{acc}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{security}\PYG{o}{.}\PYG{n}{check\PYGZus{}valid\PYGZus{}filename}\PYG{p}{(}\PYG{n}{acc}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{acc}\PYG{o}{.}\PYG{n}{upper}\PYG{p}{(}\PYG{p}{)}

    \PYG{n+nd}{@validates}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{strandspecific}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{pairended}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{k}{def} \PYG{n+nf}{validate\PYGZus{}boolean}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{attr}\PYG{p}{,} \PYG{n}{val}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{val} \PYG{o+ow}{and} \PYG{n+nb+bp}{True} \PYG{o+ow}{or} \PYG{n+nb+bp}{False}

    \PYG{n+nd}{@validates}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{inputfile\PYGZus{}name}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{genbankfile\PYGZus{}name}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{k}{def} \PYG{n+nf}{validate\PYGZus{}x\PYGZus{}file\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{attr}\PYG{p}{,} \PYG{n}{name}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{l+s}{'}\PYG{l+s+se}{\PYGZbs{}\PYGZbs{}}\PYG{l+s}{'} \PYG{o+ow}{in} \PYG{n}{name}\PYG{p}{:}
            \PYG{n}{name} \PYG{o}{=} \PYG{n}{name}\PYG{o}{.}\PYG{n}{rsplit}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s+se}{\PYGZbs{}\PYGZbs{}}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{n}{security}\PYG{o}{.}\PYG{n}{check\PYGZus{}valid\PYGZus{}filename}\PYG{p}{(}\PYG{n}{name}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{name}\PYG{o}{.}\PYG{n}{find}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{.}\PYG{l+s}{'}\PYG{p}{)} \PYG{o}{\textless{}} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Please make sure your input file has a}\PYG{l+s}{"}
                            \PYG{l+s}{"}\PYG{l+s}{ (meaningful) extension, like .fastq or .sra}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{k}{return} \PYG{n}{name}

\PYG{k}{class} \PYG{n+nc}{Mixins}\PYG{p}{(}\PYG{n}{Methods}\PYG{p}{,} \PYG{n}{Properties}\PYG{p}{,} \PYG{n}{Validators}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{pass}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.core.entities}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-core-entities}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{SQLAlchemy Database Entities}

\PYG{l+s+sd}{A nice tutorial showing how everything works is {}`here}
\PYG{l+s+sd}{    \textless{}http://docs.sqlalchemy.org/en/latest/orm/tutorial.html\textgreater{}{}`\PYGZus{}.}
\PYG{l+s+sd}{"""}

\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core.orm} \PYG{k+kn}{import} \PYG{o}{*}

\PYG{k}{class} \PYG{n+nc}{Analysis}\PYG{p}{(}\PYG{n}{AnalysisMixins}\PYG{p}{,} \PYG{n}{Entity}\PYG{p}{)}\PYG{p}{:}

    \PYG{c}{\PYGZsh{} The order of superclasses matters!}
    \PYG{c}{\PYGZsh{} AnalysisMethods.\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{} calls Entity.\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}

    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    The central entity.}
\PYG{l+s+sd}{    Represents an analysis by a researcher.}
\PYG{l+s+sd}{    The whole rnaseqlyze project basically revolves around this entity.}
\PYG{l+s+sd}{    """}

    \PYG{n+nb}{id}                  \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Integer}\PYG{p}{,} \PYG{n}{primary\PYGZus{}key}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}

    \PYG{n}{org\PYGZus{}gid}             \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Integer}\PYG{p}{)}  \PYG{c}{\PYGZsh{} Organisms Genebank/Entrez gid}
    \PYG{n}{org\PYGZus{}accession}       \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{)}   \PYG{c}{\PYGZsh{} Organisms Genebank accession number}

    \PYG{n}{\PYGZus{}inputfile\PYGZus{}name}     \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{inputfile\PYGZus{}name}\PYG{l+s}{"}\PYG{p}{,} \PYG{n}{String}\PYG{p}{)}
    \PYG{n}{inputfile\PYGZus{}type}      \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{)}
    \PYG{n}{\PYGZus{}genbankfile\PYGZus{}name}   \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{genbankfile\PYGZus{}name}\PYG{l+s}{"}\PYG{p}{,} \PYG{n}{String}\PYG{p}{)}

    \PYG{n}{strandspecific}      \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Boolean}\PYG{p}{)}
    \PYG{n}{pairended}           \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Boolean}\PYG{p}{)}
    \PYG{n}{pairendlen}          \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Integer}\PYG{p}{)}

    \PYG{n}{owner}               \PYG{o}{=} \PYG{n}{relationship}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{User}\PYG{l+s}{"}\PYG{p}{,} \PYG{n}{backref}\PYG{o}{=}\PYG{n}{backref}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{analyses}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{owner\PYGZus{}name}          \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{,} \PYG{n}{ForeignKey}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{user.name}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{)}

    \PYG{n}{creation\PYGZus{}date}       \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{DateTime}\PYG{p}{)}
    \PYG{n}{started}             \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Boolean}\PYG{p}{)}
    \PYG{n}{finished}            \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Boolean}\PYG{p}{)}
    \PYG{n}{stage}               \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{)}
    \PYG{n}{error}               \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{)}

    \PYG{n}{rnaseq\PYGZus{}run}          \PYG{o}{=} \PYG{n}{relationship}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{RNASeqRun}\PYG{l+s}{"}\PYG{p}{,} \PYG{n}{backref}\PYG{o}{=}\PYG{n}{backref}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{analyses}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{rnaseq\PYGZus{}run\PYGZus{}srr}      \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{,} \PYG{n}{ForeignKey}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{rnaseqrun.srr}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} ft\PYGZus{}predictions    = {}`backref{}` from FeaturePredictions}
    \PYG{c}{\PYGZsh{} hg\PYGZus{}tracks         = {}`backref{}` from HgTrack}
    \PYG{c}{\PYGZsh{} galaxy\PYGZus{}datasets   = {}`backref{}` from GalaxyDataset}

\PYG{k}{class} \PYG{n+nc}{UploadSession}\PYG{p}{(}\PYG{n}{Entity}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Is created when somebody uploads a file}
\PYG{l+s+sd}{    """}
    \PYG{n+nb}{id}              \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Integer}\PYG{p}{,} \PYG{n}{primary\PYGZus{}key}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}
    \PYG{n}{analysis\PYGZus{}id}     \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Integer}\PYG{p}{,} \PYG{n}{ForeignKey}\PYG{p}{(}\PYG{n}{Analysis}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{analysis}        \PYG{o}{=} \PYG{n}{relationship}\PYG{p}{(}\PYG{n}{Analysis}\PYG{p}{,} \PYG{n}{uselist}\PYG{o}{=}\PYG{n+nb+bp}{False}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{User}\PYG{p}{(}\PYG{n}{Entity}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Constitutes a user of this service}
\PYG{l+s+sd}{    """}
    \PYG{n}{name}            \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{,} \PYG{n}{primary\PYGZus{}key}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}
    \PYG{c}{\PYGZsh{} analyses      = {}`backref{}` from Analysis}

    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{name}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{name} \PYG{o}{=} \PYG{n}{name}

\PYG{c}{\PYGZsh{} SRA analogons}

\PYG{k}{class} \PYG{n+nc}{RNASeqStudy}\PYG{p}{(}\PYG{n}{Entity}\PYG{p}{)}\PYG{p}{:} \PYG{c}{\PYGZsh{} stub}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Constitues an SRA "SRP" == SRA Study}
\PYG{l+s+sd}{    """}
    \PYG{n}{srp}             \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{,} \PYG{n}{primary\PYGZus{}key}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}
    \PYG{c}{\PYGZsh{} analyses      = {}`backref{}` from Analysis}
    \PYG{c}{\PYGZsh{} experiments   = {}`backref{}` from RNASeqExperiment}

\PYG{k}{class} \PYG{n+nc}{RNASeqExperiment}\PYG{p}{(}\PYG{n}{Entity}\PYG{p}{)}\PYG{p}{:} \PYG{c}{\PYGZsh{} stub}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Constitutes an SRA "SRX" == SRA Experiment}
\PYG{l+s+sd}{    """}
    \PYG{n}{srx}         \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{,} \PYG{n}{primary\PYGZus{}key}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}
    \PYG{n}{srp\PYGZus{}srp}     \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Integer}\PYG{p}{,} \PYG{n}{ForeignKey}\PYG{p}{(}\PYG{n}{RNASeqStudy}\PYG{o}{.}\PYG{n}{srp}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{srp}         \PYG{o}{=} \PYG{n}{relationship}\PYG{p}{(}\PYG{n}{RNASeqStudy}\PYG{p}{,} \PYG{n}{backref}\PYG{o}{=}\PYG{n}{backref}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{experiments}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}
    \PYG{c}{\PYGZsh{} runs      = {}`backref{}` from RNASeqRun}

\PYG{k}{class} \PYG{n+nc}{RNASeqRun}\PYG{p}{(}\PYG{n}{RNASeqRunMixins}\PYG{p}{,} \PYG{n}{Entity}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Constitutes an SRA "SRR" == SRA Run}
\PYG{l+s+sd}{    """}
    \PYG{n}{srr}         \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{,} \PYG{n}{primary\PYGZus{}key}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}
    \PYG{n}{srx\PYGZus{}srx}     \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Integer}\PYG{p}{,} \PYG{n}{ForeignKey}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{rnaseqexperiment.srx}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{srx}         \PYG{o}{=} \PYG{n}{relationship}\PYG{p}{(}\PYG{n}{RNASeqExperiment}\PYG{p}{,} \PYG{n}{backref}\PYG{o}{=}\PYG{n}{backref}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{runs}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{UCSCOrganism}\PYG{p}{(}\PYG{n}{Entity}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Holds information about the mapping of UCSC browser "db" names to}
\PYG{l+s+sd}{    "gene id 'title'"s, and RefSeq Accessions.}
\PYG{l+s+sd}{    """}
    \PYG{n}{acc}         \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{,} \PYG{n}{primary\PYGZus{}key}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}
    \PYG{n}{db}          \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{,} \PYG{n}{unique}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}
    \PYG{n}{title}       \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{,} \PYG{n}{unique}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{GalaxyDataset}\PYG{p}{(}\PYG{n}{Entity}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Holds a mapping from an analysis to a galaxy dataset id}
\PYG{l+s+sd}{    """}
    \PYG{n+nb}{id}          \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{,} \PYG{n}{primary\PYGZus{}key}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}
    \PYG{n}{analysis\PYGZus{}id} \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Integer}\PYG{p}{,} \PYG{n}{ForeignKey}\PYG{p}{(}\PYG{n}{Analysis}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}\PYG{p}{,} \PYG{n}{primary\PYGZus{}key}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}
    \PYG{n}{analysis}    \PYG{o}{=} \PYG{n}{relationship}\PYG{p}{(}\PYG{n}{Analysis}\PYG{p}{,} \PYG{n}{backref}\PYG{o}{=}\PYG{n}{backref}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{galaxy\PYGZus{}datasets}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}
    \PYG{n+nb}{type}        \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{)}
    \PYG{n}{name}        \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{StageLog}\PYG{p}{(}\PYG{n}{Entity}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Holds the log output of one processing stage}
\PYG{l+s+sd}{    """}
    \PYG{c}{\PYGZsh{} the primary key could be stage/analysis\PYGZus{}id}
    \PYG{c}{\PYGZsh{} but using an id automatically adds ordering}
    \PYG{c}{\PYGZsh{} which comes handy, because how to order the stages otherwise ?}
    \PYG{n+nb}{id}          \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Integer}\PYG{p}{,} \PYG{n}{primary\PYGZus{}key}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}
    \PYG{n}{stage}       \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{String}\PYG{p}{)}
    \PYG{n}{analysis\PYGZus{}id} \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Integer}\PYG{p}{,} \PYG{n}{ForeignKey}\PYG{p}{(}\PYG{n}{Analysis}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{analysis}    \PYG{o}{=} \PYG{n}{relationship}\PYG{p}{(}\PYG{n}{Analysis}\PYG{p}{,} \PYG{n}{backref}\PYG{o}{=}\PYG{n}{backref}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{stage\PYGZus{}logs}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{text}        \PYG{o}{=} \PYG{n}{Column}\PYG{p}{(}\PYG{n}{Text}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.core.orm}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-core-orm}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{This module declares and imports everyting needed to}
\PYG{l+s+sd}{define the database entitiy classes in :mod:{}`.entities{}`.}
\PYG{l+s+sd}{"""}

\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy} \PYG{k+kn}{import} \PYG{p}{(}
        \PYG{n}{ForeignKey}\PYG{p}{,}
        \PYG{n}{Table}\PYG{p}{,} \PYG{n}{Column}\PYG{p}{,}
        \PYG{n}{Boolean}\PYG{p}{,} \PYG{n}{Integer}\PYG{p}{,}
        \PYG{n}{String}\PYG{p}{,} \PYG{n}{Text}\PYG{p}{,} \PYG{n}{DateTime}
\PYG{p}{)}
\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy.orm} \PYG{k+kn}{import} \PYG{n}{relationship}\PYG{p}{,} \PYG{n}{backref}
\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy.ext.declarative} \PYG{k+kn}{import} \PYG{n}{declared\PYGZus{}attr}

\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core.analysis} \PYG{k+kn}{import} \PYG{n}{Mixins} \PYG{k}{as} \PYG{n}{AnalysisMixins}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core.srr} \PYG{k+kn}{import} \PYG{n}{Mixins} \PYG{k}{as} \PYG{n}{RNASeqRunMixins}

\PYG{k}{class} \PYG{n+nc}{\PYGZus{}Entity}\PYG{p}{(}\PYG{n+nb}{object}\PYG{p}{)}\PYG{p}{:}

    \PYG{n+nd}{@declared\PYGZus{}attr}
    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}tablename\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n}{cls}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{cls}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{o}{.}\PYG{n}{lower}\PYG{p}{(}\PYG{p}{)}

    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}setattr\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{name}\PYG{p}{,} \PYG{n}{value}\PYG{p}{)}\PYG{p}{:}

        \PYG{c}{\PYGZsh{} raise an exception when setting}
        \PYG{c}{\PYGZsh{} attributes that are not db columns}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{p}{(}\PYG{n}{name}\PYG{o}{.}\PYG{n}{startswith}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{\PYGZus{}}\PYG{l+s}{'}\PYG{p}{)} \PYG{o+ow}{or} \PYG{n+nb}{hasattr}\PYG{p}{(}\PYG{n+nb}{type}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{,} \PYG{n}{name}\PYG{p}{)}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{ is not a declared attribute}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{name}\PYG{p}{)}

        \PYG{n+nb}{super}\PYG{p}{(}\PYG{n}{\PYGZus{}Entity}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}setattr\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n}{name}\PYG{p}{,} \PYG{n}{value}\PYG{p}{)}

\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy.ext.declarative} \PYG{k+kn}{import} \PYG{n}{declarative\PYGZus{}base}
\PYG{n}{Entity} \PYG{o}{=} \PYG{n}{declarative\PYGZus{}base}\PYG{p}{(}\PYG{n}{cls}\PYG{o}{=}\PYG{n}{\PYGZus{}Entity}\PYG{p}{)}
\PYG{k}{del} \PYG{n}{declarative\PYGZus{}base}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.core.security}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-core-security}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{A collection of security related functions.}

\PYG{l+s+sd}{In case a check fails, an exception is raised, otherwise None is returned.}
\PYG{l+s+sd}{"""}

\PYG{k}{def} \PYG{n+nf}{check\PYGZus{}valid\PYGZus{}filename}\PYG{p}{(}\PYG{n}{name}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Assert that the passed name doesn't contain}
\PYG{l+s+sd}{    any "funny" characters (e.g. ../../../../sensitive.txt)}
\PYG{l+s+sd}{    """}

    \PYG{n}{max\PYGZus{}len} \PYG{o}{=} \PYG{l+m+mi}{128}
    \PYG{k}{assert} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{name}\PYG{p}{)} \PYG{o}{\textless{}} \PYG{n}{max\PYGZus{}len}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{Filename too long}\PYG{l+s}{"}

    \PYG{k+kn}{import} \PYG{n+nn}{string}
    \PYG{k}{assert} \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{name}\PYG{p}{)} \PYG{o}{\textless{}} \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{string}\PYG{o}{.}\PYG{n}{digits} \PYG{o}{+} \PYG{n}{string}\PYG{o}{.}\PYG{n}{letters} \PYG{o}{+} \PYG{l+s}{'}\PYG{l+s}{.\PYGZus{}}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{,} \PYGZbs{}
            \PYG{l+s}{"}\PYG{l+s}{Only digits, letters, point and underscore allowed in filenames}\PYG{l+s}{"}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.core.service}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-core-service}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{import} \PYG{n+nn}{os}
\PYG{k+kn}{import} \PYG{n+nn}{urllib2}

\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core} \PYG{k+kn}{import} \PYG{n}{security}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core.entities} \PYG{k+kn}{import} \PYG{n}{Analysis}\PYG{p}{,} \PYG{n}{User}\PYG{p}{,} \PYG{n}{RNASeqRun}\PYG{p}{,} \PYG{n}{UploadSession}
\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}upload\PYGZus{}session}\PYG{p}{(}\PYG{n}{db\PYGZus{}session}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{sess} \PYG{o}{=} \PYG{n}{UploadSession}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{n}{sess}\PYG{p}{)}
    \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{flush}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{sess}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}uploadfile}\PYG{p}{(}\PYG{n}{db\PYGZus{}session}\PYG{p}{,} \PYG{n}{session}\PYG{p}{,} \PYG{n}{name}\PYG{p}{,} \PYG{n+nb}{type}\PYG{p}{)}\PYG{p}{:}
    \PYG{c}{\PYGZsh{} This doesn't look right, but it works. The database needs to}
    \PYG{c}{\PYGZsh{} be locked here to make sure that the first upload request that}
    \PYG{c}{\PYGZsh{} comes in creates the analysis and the second uses the same analysis.}
    \PYG{c}{\PYGZsh{} We need to lock the whole database and this seemingly useless statement}
    \PYG{c}{\PYGZsh{} does just that. With SQLite. I have been asking on irc \PYGZsh{}sqlalchemy about}
    \PYG{c}{\PYGZsh{} how to do it the right way, but I didn't get any useful reply. I have}
    \PYG{c}{\PYGZsh{} checked the SQLAlchemy as well as the SQLite docs and tried various things}
    \PYG{c}{\PYGZsh{} like DBSession.execute("BEGIN") and such things - nothing seems to work}
    \PYG{c}{\PYGZsh{} - this is the only solution I have found.}
    \PYG{c}{\PYGZsh{}}
    \PYG{c}{\PYGZsh{} EDT: it could be as simple as increasing the sqlalchemy debug level, check}
    \PYG{c}{\PYGZsh{}      what sql statements are executed and then DBSession.execute() those}
    \PYG{c}{\PYGZsh{}}
    \PYG{n}{session}\PYG{o}{.}\PYG{n}{analysis} \PYG{o}{=} \PYG{n}{session}\PYG{o}{.}\PYG{n}{analysis}
    \PYG{c}{\PYGZsh{}}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{session}\PYG{o}{.}\PYG{n}{analysis}\PYG{p}{:}
        \PYG{n}{session}\PYG{o}{.}\PYG{n}{analysis} \PYG{o}{=} \PYG{n}{Analysis}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{n}{session}\PYG{o}{.}\PYG{n}{analysis}\PYG{p}{)} \PYG{c}{\PYGZsh{} needed ?}
        \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{flush}\PYG{p}{(}\PYG{p}{)} \PYG{c}{\PYGZsh{} sets analysis.id}
        \PYG{n}{session}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{create\PYGZus{}data\PYGZus{}dir}\PYG{p}{(}\PYG{p}{)}

    \PYG{k}{assert} \PYG{n+nb}{type} \PYG{o+ow}{in} \PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{inputfile}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{genbankfile}\PYG{l+s}{'}\PYG{p}{)}

    \PYG{n}{typename} \PYG{o}{=} \PYG{n+nb}{type} \PYG{o}{+} \PYG{l+s}{'}\PYG{l+s}{\PYGZus{}name}\PYG{l+s}{'}

    \PYG{c}{\PYGZsh{} inputfile\PYGZus{}name -\textgreater{} Short Reads in SRA or FASTQ format}
    \PYG{c}{\PYGZsh{} genabnkfile\PYGZus{}name -\textgreater{} Organism genbank file}
    \PYG{c}{\PYGZsh{}=if session.analysis.inputfile\PYGZus{}name:}
    \PYG{k}{if} \PYG{n+nb}{getattr}\PYG{p}{(}\PYG{n}{session}\PYG{o}{.}\PYG{n}{analysis}\PYG{p}{,} \PYG{n+nb}{type} \PYG{o}{+} \PYG{l+s}{'}\PYG{l+s}{\PYGZus{}uploaded}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{:}
        \PYG{c}{\PYGZsh{} you land here if a user uploads}
        \PYG{c}{\PYGZsh{} more than one file per type}
        \PYG{c}{\PYGZsh{} this is not intended, BUT}
        \PYG{c}{\PYGZsh{} these are the interwebs!}
        \PYG{k}{pass} \PYG{c}{\PYGZsh{} FIXE: remove old}

    \PYG{c}{\PYGZsh{}=session.analysis.inputfile\PYGZus{}name = name}
    \PYG{n+nb}{setattr}\PYG{p}{(}\PYG{n}{session}\PYG{o}{.}\PYG{n}{analysis}\PYG{p}{,} \PYG{n}{typename}\PYG{p}{,} \PYG{n}{name}\PYG{p}{)}

    \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{creating upload file }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{ for analysis \PYGZsh{}}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}
                                     \PYG{n}{name}\PYG{p}{,}             \PYG{n}{session}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} this would be the place to throw in a wrapper}
    \PYG{c}{\PYGZsh{} to track upload progress the old way, i.e.}
    \PYG{c}{\PYGZsh{} with server callbacks...}

    \PYG{c}{\PYGZsh{}inputfile\PYGZus{}path is a @property}
    \PYG{k}{return} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n+nb}{getattr}\PYG{p}{(}\PYG{n}{session}\PYG{o}{.}\PYG{n}{analysis}\PYG{p}{,} \PYG{n+nb}{type} \PYG{o}{+} \PYG{l+s}{'}\PYG{l+s}{\PYGZus{}path}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w+b}\PYG{l+s}{"}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}analysis}\PYG{p}{(}\PYG{n}{db\PYGZus{}session}\PYG{p}{,} \PYG{n}{attributes}\PYG{p}{)}\PYG{p}{:}

    \PYG{c}{\PYGZsh{} owner handling}
    \PYG{k}{if} \PYG{l+s}{'}\PYG{l+s}{owner}\PYG{l+s}{'} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n}{attributes}\PYG{p}{:}
        \PYG{n}{owner} \PYG{o}{=} \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{User}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{anonymous}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{owner}\PYG{p}{:}
            \PYG{n}{owner} \PYG{o}{=} \PYG{n}{User}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{anonymous}\PYG{l+s}{"}\PYG{p}{)}
            \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{n}{owner}\PYG{p}{)}
        \PYG{n}{attributes}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{owner}\PYG{l+s}{'}\PYG{p}{]} \PYG{o}{=} \PYG{n}{owner}

    \PYG{c}{\PYGZsh{} srr handling}
    \PYG{n}{rnaseq\PYGZus{}run} \PYG{o}{=} \PYG{n+nb+bp}{None}
    \PYG{k}{if} \PYG{l+s}{'}\PYG{l+s}{rnaseq\PYGZus{}run}\PYG{l+s}{'} \PYG{o+ow}{in} \PYG{n}{attributes} \PYGZbs{}
       \PYG{o+ow}{and} \PYG{l+s}{'}\PYG{l+s}{inputfile\PYGZus{}name}\PYG{l+s}{'} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n}{attributes}\PYG{p}{:}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{rnaseq\PYGZus{}run: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{attributes}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{rnaseq\PYGZus{}run}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{rnaseq\PYGZus{}run} \PYG{o}{=} \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{RNASeqRun}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{attributes}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{rnaseq\PYGZus{}run}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{rnaseq\PYGZus{}run}\PYG{p}{:}
            \PYG{n}{attributes}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{rnaseq\PYGZus{}run}\PYG{l+s}{'}\PYG{p}{]} \PYG{o}{=} \PYG{n}{rnaseq\PYGZus{}run}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{try}\PYG{p}{:}
                \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{creating new RNASeqRun}\PYG{l+s}{"}\PYG{p}{)}
                \PYG{n}{rnaseq\PYGZus{}run} \PYG{o}{=} \PYG{n}{RNASeqRun}\PYG{p}{(}\PYG{n}{srr}\PYG{o}{=}\PYG{n}{attributes}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{rnaseq\PYGZus{}run}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{)}
                \PYG{n}{attributes}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{rnaseq\PYGZus{}run}\PYG{l+s}{'}\PYG{p}{]} \PYG{o}{=} \PYG{n}{rnaseq\PYGZus{}run}
                \PYG{n}{rnaseq\PYGZus{}run}\PYG{o}{.}\PYG{n}{create\PYGZus{}directories}\PYG{p}{(}\PYG{p}{)}
                \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{n}{rnaseq\PYGZus{}run}\PYG{p}{)}
            \PYG{k}{except} \PYG{n+ne}{Exception}\PYG{p}{,} \PYG{n}{e}\PYG{p}{:}
                \PYG{c}{\PYGZsh{} The RNASeqRun constructor checks the SRRnnnnnn argument}
                \PYG{c}{\PYGZsh{} and raises an exception unless it passes the checks}
                \PYG{c}{\PYGZsh{} e.g. if field was left blank/at default value}
                \PYG{c}{\PYGZsh{} TODO: decide/document what to do}
                \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{failed: }\PYG{l+s+si}{\PYGZpc{}r}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{e}\PYG{p}{)}
        \PYG{k}{del} \PYG{n}{attributes}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{rnaseq\PYGZus{}run}\PYG{l+s}{'}\PYG{p}{]}

    \PYG{n}{upload\PYGZus{}session} \PYG{o}{=} \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{UploadSession}\PYG{p}{)} \PYGZbs{}
                            \PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n}{attributes}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{upload\PYGZus{}session}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{)}
    \PYG{k}{del} \PYG{n}{attributes}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{upload\PYGZus{}session}\PYG{l+s}{'}\PYG{p}{]}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{upload\PYGZus{}session}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{this session has expired -}\PYG{l+s}{'}
                        \PYG{l+s}{'}\PYG{l+s}{ reload the }\PYG{l+s}{"}\PYG{l+s}{New Analysis}\PYG{l+s}{"}\PYG{l+s}{ page to start a new one}\PYG{l+s}{'}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} the analysis exist already if the user uploaded something}
    \PYG{k}{if} \PYG{n}{upload\PYGZus{}session}\PYG{o}{.}\PYG{n}{analysis}\PYG{p}{:}
        \PYG{n}{analysis} \PYG{o}{=} \PYG{n}{upload\PYGZus{}session}\PYG{o}{.}\PYG{n}{analysis}
        \PYG{k}{for} \PYG{n}{attr}\PYG{p}{,} \PYG{n}{value} \PYG{o+ow}{in} \PYG{n}{attributes}\PYG{o}{.}\PYG{n}{items}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb}{setattr}\PYG{p}{(}\PYG{n}{analysis}\PYG{p}{,} \PYG{n}{attr}\PYG{p}{,} \PYG{n}{value}\PYG{p}{)}

    \PYG{k}{else}\PYG{p}{:}
        \PYG{c}{\PYGZsh{} create db object}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{creating new analysis: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{attributes}\PYG{p}{)}
        \PYG{n}{analysis} \PYG{o}{=} \PYG{n}{Analysis}\PYG{p}{(}\PYG{o}{*}\PYG{o}{*}\PYG{n}{attributes}\PYG{p}{)}
        \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{n}{analysis}\PYG{p}{)}
        \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{flush}\PYG{p}{(}\PYG{p}{)} \PYG{c}{\PYGZsh{} sets analysis.id}
        \PYG{n}{analysis}\PYG{o}{.}\PYG{n}{create\PYGZus{}data\PYGZus{}dir}\PYG{p}{(}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} allow no more uploads to this analysis}
    \PYG{n}{db\PYGZus{}session}\PYG{o}{.}\PYG{n}{delete}\PYG{p}{(}\PYG{n}{upload\PYGZus{}session}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} if no input file has been uploaded}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{analysis}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}name}\PYG{p}{:}
        \PYG{c}{\PYGZsh{} an SRR identifier is needed}
        \PYG{k}{if} \PYG{n}{rnaseq\PYGZus{}run}\PYG{p}{:}
            \PYG{n}{analysis}\PYG{o}{.}\PYG{n}{rnaseq\PYGZus{}run} \PYG{o}{=} \PYG{n}{rnaseq\PYGZus{}run}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Please upload an input file or specify an SRR id}\PYG{l+s}{"}\PYG{p}{)}

    \PYG{k}{return} \PYG{n}{analysis}

\PYG{k}{def} \PYG{n+nf}{start\PYGZus{}analysis}\PYG{p}{(}\PYG{n}{analysis}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{url} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{http://127.0.0.1:6543/analyses/}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{"}
    \PYG{n}{rq} \PYG{o}{=} \PYG{n}{RNASWorkerSTARTRequest}\PYG{p}{(}\PYG{n}{url} \PYG{o}{\PYGZpc{}} \PYG{n}{analysis}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}
    \PYG{n}{opener} \PYG{o}{=} \PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{build\PYGZus{}opener}\PYG{p}{(}\PYG{n}{HTTRNASWorkerHandler}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{rsp} \PYG{o}{=} \PYG{n}{opener}\PYG{o}{.}\PYG{n}{open}\PYG{p}{(}\PYG{n}{rq}\PYG{p}{)}
    \PYG{n}{body} \PYG{o}{=} \PYG{n}{rsp}\PYG{o}{.}\PYG{n}{read}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{rsp}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{RNASWorkerSTARTRequest}\PYG{p}{(}\PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{Request}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf}{get\PYGZus{}method}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+s}{'}\PYG{l+s}{START}\PYG{l+s}{'}

\PYG{k}{class} \PYG{n+nc}{HTTRNASWorkerHandler}\PYG{p}{(}\PYG{n}{urllib2}\PYG{o}{.}\PYG{n}{HTTPHandler}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf}{http\PYGZus{}error}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{req}\PYG{p}{,} \PYG{n}{fp}\PYG{p}{,} \PYG{n}{code}\PYG{p}{,} \PYG{n}{msg}\PYG{p}{,} \PYG{n}{hdrs}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{raise} \PYG{n}{WorkerException}\PYG{p}{(}\PYG{n}{fp}\PYG{o}{.}\PYG{n}{read}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{http\PYGZus{}error\PYGZus{}400} \PYG{o}{=} \PYG{n}{http\PYGZus{}error}
    \PYG{n}{http\PYGZus{}error\PYGZus{}500} \PYG{o}{=} \PYG{n}{http\PYGZus{}error}

\PYG{k}{class} \PYG{n+nc}{WorkerException}\PYG{p}{(}\PYG{n+ne}{Exception}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{exc\PYGZus{}body}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{exc\PYGZus{}body} \PYG{o}{=} \PYG{n}{exc\PYGZus{}body}
    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}repr\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+s}{"}\PYG{l+s}{WorkerException()}\PYG{l+s}{"}
    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}str\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{exc\PYGZus{}body}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.core.sra}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-core-sra}

\paragraph{Modul \texttt{rnaseqlyze.core.srr}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-core-srr}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{Sequence Run Archive interaction}
\PYG{l+s+sd}{"""}

\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{import} \PYG{n+nn}{os}
\PYG{k+kn}{from} \PYG{n+nn}{os} \PYG{k+kn}{import} \PYG{n}{path}
\PYG{k+kn}{from} \PYG{n+nn}{urllib2} \PYG{k+kn}{import} \PYG{n}{urlopen}
\PYG{k+kn}{from} \PYG{n+nn}{shutil} \PYG{k+kn}{import} \PYG{n}{copyfileobj}

\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy.orm} \PYG{k+kn}{import} \PYG{n}{validates}

\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}

\PYG{n}{url\PYGZus{}template} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{http://ftp-private.ncbi.nlm.nih.gov}\PYG{l+s}{"} \PYGZbs{}
        \PYG{l+s}{"}\PYG{l+s}{/sra/sra-instant/reads/ByRun/sra/SRR/\PYGZob{}srr:.6\PYGZcb{}/\PYGZob{}srr\PYGZcb{}/\PYGZob{}srr\PYGZcb{}.sra}\PYG{l+s}{"}
\PYG{c}{\PYGZsh{} e.g.  "/sra/sra-instant/reads/ByRun/sra/SRR/SRR000/SRR000001/SRR000001.sra"}

\PYG{k}{class} \PYG{n+nc}{Methods}\PYG{p}{(}\PYG{n+nb}{object}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf}{download}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{try}\PYG{p}{:}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{fetching }\PYG{l+s}{"} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{srr}\PYG{p}{)}
            \PYG{n}{srr\PYGZus{}url} \PYG{o}{=} \PYG{n}{url\PYGZus{}template}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{srr}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{srr}\PYG{p}{)}
            \PYG{n}{remote} \PYG{o}{=} \PYG{n}{urlopen}\PYG{p}{(}\PYG{n}{srr\PYGZus{}url}\PYG{p}{,} \PYG{n}{timeout}\PYG{o}{=}\PYG{l+m+mi}{60}\PYG{p}{)}
            \PYG{n}{local} \PYG{o}{=} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sra\PYGZus{}path}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w}\PYG{l+s}{"}\PYG{p}{)}
            \PYG{n}{copyfileobj}\PYG{p}{(}\PYG{n}{remote}\PYG{p}{,} \PYG{n}{local}\PYG{p}{)}
        \PYG{k}{except} \PYG{n+ne}{Exception}\PYG{p}{,} \PYG{n}{e}\PYG{p}{:}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{error}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Error fetching SRR: }\PYG{l+s+si}{\PYGZpc{}r}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{e}\PYG{p}{)}
            \PYG{n}{os}\PYG{o}{.}\PYG{n}{unlink}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sra\PYGZus{}path}\PYG{p}{)}
            \PYG{k}{raise}
        \PYG{k}{finally}\PYG{p}{:}
            \PYG{c}{\PYGZsh{} note:}
            \PYG{c}{\PYGZsh{}  in case of an error, unlinking wil precede closing}
            \PYG{c}{\PYGZsh{}   -- no problem on unix}
            \PYG{k}{if} \PYG{n}{local}\PYG{p}{:}
                \PYG{n}{local}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{done}\PYG{l+s}{"}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{Properties}\PYG{p}{(}\PYG{n+nb}{object}\PYG{p}{)}\PYG{p}{:}
    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{data\PYGZus{}dir}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{shared\PYGZus{}data\PYGZus{}path}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{srr}\PYG{p}{)}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{sra\PYGZus{}path}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{sra\PYGZus{}name}\PYG{p}{)}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{sra\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{srr} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{.sra}\PYG{l+s}{"}

    \PYG{k}{def} \PYG{n+nf}{create\PYGZus{}directories}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{isdir}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{os}\PYG{o}{.}\PYG{n}{makedirs}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{Validators}\PYG{p}{(}\PYG{n+nb}{object}\PYG{p}{)}\PYG{p}{:}
    \PYG{n+nd}{@validates}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{srr}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{k}{def} \PYG{n+nf}{check\PYGZus{}srr}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{key}\PYG{p}{,} \PYG{n}{srr}\PYG{p}{)}\PYG{p}{:}
        \PYG{k+kn}{import} \PYG{n+nn}{string}
        \PYG{k}{assert} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{srr}\PYG{p}{)} \PYG{o}{==} \PYG{l+m+mi}{9}
        \PYG{k}{assert} \PYG{n}{srr}\PYG{p}{[}\PYG{p}{:}\PYG{l+m+mi}{3}\PYG{p}{]} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{SRR}\PYG{l+s}{'}
        \PYG{k}{assert} \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{srr}\PYG{p}{[}\PYG{l+m+mi}{3}\PYG{p}{:}\PYG{p}{]}\PYG{p}{)} \PYG{o}{\textless{}} \PYG{n+nb}{set}\PYG{p}{(}\PYG{n}{string}\PYG{o}{.}\PYG{n}{digits}\PYG{p}{)}
        \PYG{c}{\PYGZsh{} ... what a powerful language python is! :-)}
        \PYG{c}{\PYGZsh{} http://docs.python.org/library/stdtypes.html\PYGZsh{}set}
        \PYG{c}{\PYGZsh{} http://docs.python.org/library/string.html\PYGZsh{}string-constants}
        \PYG{k}{return} \PYG{n}{srr}\PYG{o}{.}\PYG{n}{upper}\PYG{p}{(}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{Mixins}\PYG{p}{(}\PYG{n}{Methods}\PYG{p}{,} \PYG{n}{Properties}\PYG{p}{,} \PYG{n}{Validators}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{pass}
\end{Verbatim}


\subsubsection{Package \texttt{rnaseqlyze.cli}}
\label{rnaseqlyze-pdf:package-rnaseqlyze-cli}

\paragraph{Modul \texttt{rnaseqlyze.cli}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-cli}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""\PYGZbs{}}
\PYG{l+s+sd}{Programs runnable from the command line.}

\PYG{l+s+sd}{For each module contained in this package, a wrapper script}
\PYG{l+s+sd}{called {}`rnas-\textless{}module name\textgreater{}{}` will be installed in {}`\textless{}prefix\textgreater{}/bin{}`.}
\PYG{l+s+sd}{"""}

\PYG{k+kn}{from} \PYG{n+nn}{..} \PYG{k+kn}{import} \PYG{n}{project\PYGZus{}name}
\PYG{n}{project\PYGZus{}name} \PYG{o}{+}\PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{-cli}\PYG{l+s}{"}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.cli.apidoc}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-cli-apidoc}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""\PYGZbs{}}
\PYG{l+s+sd}{RNA-Seqlyze ApiDoc Generator}

\PYG{l+s+sd}{Usage:}
\PYG{l+s+sd}{    rnas-apidoc -h\textbar{}--help}
\PYG{l+s+sd}{    rnas-apidoc [-s\textbar{}--source] \textless{}path\textgreater{} ...}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{Generates one \textless{}package\textgreater{}.rst sphinx apidoc source file,}
\PYG{l+s+sd}{in the current directory, for each package found in \textless{}path\textgreater{}.}

\PYG{l+s+sd}{Options:}
\PYG{l+s+sd}{    -s --source    Use {}`literalinclude{}` in addition to {}`automodule{}`.}
\PYG{l+s+sd}{                   When using this option, the generated output will be}
\PYG{l+s+sd}{                   optimized for processing with the spinx latexpdf module that}
\PYG{l+s+sd}{                   generates a pdf document. Even without this option, when}
\PYG{l+s+sd}{                   using the html output module, the modules source code will}
\PYG{l+s+sd}{                   still be available in the generated Website, but not on the}
\PYG{l+s+sd}{                   same pages as the rest of the modules documentation}
\PYG{l+s+sd}{                   (controlled by the "html\PYGZus{}show\PYGZus{}sourcelink" option in}
\PYG{l+s+sd}{                   apidoc/conf.py).}

\PYG{l+s+sd}{"""}
\PYG{k+kn}{import} \PYG{n+nn}{os}\PYG{o}{,} \PYG{n+nn}{sys}
\PYG{k+kn}{from} \PYG{n+nn}{pkgutil} \PYG{k+kn}{import} \PYG{n}{walk\PYGZus{}packages}

\PYG{k}{def} \PYG{n+nf}{main}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{k+kn}{import} \PYG{n+nn}{docopt}
    \PYG{n}{opts} \PYG{o}{=} \PYG{n}{docopt}\PYG{o}{.}\PYG{n}{docopt}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}doc\PYGZus{}\PYGZus{}}\PYG{p}{)}

    \PYG{k}{global} \PYG{n}{pkg\PYGZus{}tpl}
    \PYG{k}{global} \PYG{n}{mod\PYGZus{}tpl}
    \PYG{k}{if} \PYG{n}{opts}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{--source}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{:}
        \PYG{n}{pkg\PYGZus{}tpl}\PYG{p}{,} \PYG{n}{mod\PYGZus{}tpl} \PYG{o}{=} \PYG{n}{pkg\PYGZus{}src\PYGZus{}tpl}\PYG{p}{,} \PYG{n}{mod\PYGZus{}src\PYGZus{}tpl}

    \PYG{c}{\PYGZsh{}: implicit args to write():}
    \PYG{c}{\PYGZsh{}:  pkg.outfile, pgkpath, name, filename}
    \PYG{k}{def} \PYG{n+nf}{write}\PYG{p}{(}\PYG{n}{tpl}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{pkg}\PYG{o}{.}\PYG{n}{outfile}\PYG{o}{.}\PYG{n}{write}\PYG{p}{(}\PYG{n}{tpl}\PYG{o}{.}\PYG{n}{format}\PYG{p}{(}
            \PYG{n}{name}\PYG{o}{=}\PYG{n}{name}\PYG{p}{,} \PYG{n}{path}\PYG{o}{=}\PYG{n}{pkgpath} \PYG{o}{+} \PYG{n}{os}\PYG{o}{.}\PYG{n}{sep} \PYG{o}{+} \PYG{n}{filename}\PYG{p}{,}
            \PYG{n}{equals}\PYG{o}{=}\PYG{l+s}{"}\PYG{l+s}{=}\PYG{l+s}{"} \PYG{o}{*} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{name}\PYG{p}{)}\PYG{p}{,} \PYG{n}{dashes}\PYG{o}{=}\PYG{l+s}{"}\PYG{l+s}{-}\PYG{l+s}{"} \PYG{o}{*} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{name}\PYG{p}{)}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{)}

    \PYG{n}{packages} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{n}{Package} \PYG{o}{=} \PYG{n+nb}{type}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{'}\PYG{p}{,} \PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} requirement/assumption:}
    \PYG{c}{\PYGZsh{}  parent packages will come before their children}
    \PYG{k}{for} \PYG{n}{loader}\PYG{p}{,} \PYG{n}{name}\PYG{p}{,} \PYG{n}{is\PYGZus{}pkg} \PYG{o+ow}{in} \PYG{n}{walk\PYGZus{}packages}\PYG{p}{(}\PYG{n}{opts}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{\textless{}path\textgreater{}}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{)}\PYG{p}{:}

        \PYG{n}{pkgname} \PYG{o}{=} \PYG{n}{name}\PYG{o}{.}\PYG{n}{rsplit}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{.}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}
        \PYG{n}{pkgpath} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{relpath}\PYG{p}{(}\PYG{n}{loader}\PYG{o}{.}\PYG{n}{path}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{.}\PYG{l+s}{"}\PYG{p}{)}

        \PYG{k}{if} \PYG{n}{is\PYGZus{}pkg}\PYG{p}{:}
            \PYG{c}{\PYGZsh{} note: 'pkgname' is actually the}
            \PYG{c}{\PYGZsh{}       \PYGZus{}parent\PYGZus{} package name in this case}

            \PYG{c}{\PYGZsh{} associate non-root-packages with their parents}
            \PYG{k}{if} \PYG{l+s}{'}\PYG{l+s}{.}\PYG{l+s}{'} \PYG{o+ow}{in} \PYG{n}{name}\PYG{p}{:}
                \PYG{n}{packages}\PYG{p}{[}\PYG{n}{pkgname}\PYG{p}{]}\PYG{o}{.}\PYG{n}{subpackages}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{name}\PYG{p}{)}

            \PYG{c}{\PYGZsh{} create \& init a 'Package' object,}
            \PYG{c}{\PYGZsh{} open \textless{}fully-qualified-package-name\textgreater{}.rst}
            \PYG{c}{\PYGZsh{} and set filename to \textless{}package-name\textgreater{}/\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}.py}
            \PYG{n}{pkg} \PYG{o}{=} \PYG{n}{Package}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{pkg}\PYG{o}{.}\PYG{n}{subpackages} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
            \PYG{k}{print} \PYG{l+s}{"}\PYG{l+s}{creating }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{.rst}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{name}
            \PYG{n}{pkg}\PYG{o}{.}\PYG{n}{outfile} \PYG{o}{=} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{name} \PYG{o}{+} \PYG{l+s}{'}\PYG{l+s}{.rst}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{w}\PYG{l+s}{'}\PYG{p}{)}
            \PYG{n}{filename} \PYG{o}{=} \PYG{n}{name}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{.}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{[}\PYG{o}{-}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{n}{os}\PYG{o}{.}\PYG{n}{sep} \PYG{o}{+} \PYG{l+s}{'}\PYG{l+s}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}.py}\PYG{l+s}{'}

            \PYG{c}{\PYGZsh{} add the package to the list}
            \PYG{c}{\PYGZsh{} and write the packages .rst file heading}
            \PYG{n}{packages}\PYG{p}{[}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{pkg}
            \PYG{n}{write}\PYG{p}{(}\PYG{n}{pkg\PYGZus{}tpl}\PYG{p}{)}

        \PYG{k}{else}\PYG{p}{:}
            \PYG{c}{\PYGZsh{} skip modules that are not part of any package, like setup.py}
            \PYG{k}{if} \PYG{n}{pkgname} \PYG{o+ow}{not} \PYG{o+ow}{in} \PYG{n}{packages}\PYG{p}{:}
                \PYG{k}{continue}

            \PYG{c}{\PYGZsh{} find the containing package and set filename to \textless{}module\textgreater{}.py}
            \PYG{n}{pkg} \PYG{o}{=} \PYG{n}{packages}\PYG{p}{[}\PYG{n}{pkgname}\PYG{p}{]}
            \PYG{n}{filename} \PYG{o}{=} \PYG{n}{name}\PYG{p}{[}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{pkgname}\PYG{p}{)}\PYG{o}{+}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]} \PYG{o}{+} \PYG{l+s}{'}\PYG{l+s}{.py}\PYG{l+s}{'}

            \PYG{c}{\PYGZsh{} append the doc entry for this module to the package .rst file}
            \PYG{n}{write}\PYG{p}{(}\PYG{n}{mod\PYGZus{}tpl}\PYG{p}{)}

    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{opts}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{--source}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{:}
        \PYG{k}{for} \PYG{n}{pkg} \PYG{o+ow}{in} \PYG{n}{packages}\PYG{o}{.}\PYG{n}{values}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{if} \PYG{n}{pkg}\PYG{o}{.}\PYG{n}{subpackages}\PYG{p}{:}
                \PYG{n}{write}\PYG{p}{(}\PYG{n}{sub\PYGZus{}pkg\PYGZus{}tpl}\PYG{p}{,} \PYG{n}{names}\PYG{o}{=}\PYG{l+s}{"}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}t}\PYG{l+s}{"}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{pkg}\PYG{o}{.}\PYG{n}{subpackages}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{pkg\PYGZus{}tpl} \PYG{o}{=} \PYG{l+s}{"""}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s}{:mod:{}`\PYGZob{}name\PYGZcb{}{}`}
\PYG{l+s}{\PYGZob{}equals\PYGZcb{}=======}

\PYG{l+s}{.. automodule:: \PYGZob{}name\PYGZcb{}}

\PYG{l+s}{"""}

\PYG{n}{pkg\PYGZus{}src\PYGZus{}tpl} \PYG{o}{=} \PYG{l+s}{"""}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s}{:mod:{}`\PYGZob{}name\PYGZcb{}{}`}
\PYG{l+s}{\PYGZob{}equals\PYGZcb{}=======}

\PYG{l+s}{:mod:{}`\PYGZob{}name\PYGZcb{}{}`}
\PYG{l+s}{\PYGZob{}dashes\PYGZcb{}-------}

\PYG{l+s}{.. automodule:: \PYGZob{}name\PYGZcb{}}

\PYG{l+s}{Source Code:}

\PYG{l+s}{.. literalinclude:: \PYGZob{}path\PYGZcb{}}

\PYG{l+s}{"""}

\PYG{n}{mod\PYGZus{}tpl} \PYG{o}{=} \PYG{l+s}{"""}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s}{:mod:{}`\PYGZob{}name\PYGZcb{}{}`}
\PYG{l+s}{\PYGZob{}dashes\PYGZcb{}-------}

\PYG{l+s}{.. automodule:: \PYGZob{}name\PYGZcb{}}

\PYG{l+s}{"""}

\PYG{n}{mod\PYGZus{}src\PYGZus{}tpl} \PYG{o}{=} \PYG{l+s}{"""}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s}{:mod:{}`\PYGZob{}name\PYGZcb{}{}`}
\PYG{l+s}{\PYGZob{}dashes\PYGZcb{}-------}

\PYG{l+s}{.. automodule:: \PYGZob{}name\PYGZcb{}}

\PYG{l+s}{Source Code:}

\PYG{l+s}{.. literalinclude:: \PYGZob{}path\PYGZcb{}}

\PYG{l+s}{"""}

\PYG{n}{sub\PYGZus{}pkg\PYGZus{}tpl} \PYG{o}{=} \PYG{l+s}{"""}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s}{Subpackages}
\PYG{l+s}{-----------}

\PYG{l+s}{.. toctree::}
\PYG{l+s}{	:titlesonly:}

\PYG{l+s}{	\PYGZob{}names\PYGZcb{}}

\PYG{l+s}{"""}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.cli.galaxy\_upload}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-cli-galaxy-upload}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""\PYGZbs{}}
\PYG{l+s+sd}{RNA-Seqlyze Galaxy-Upload}

\PYG{l+s+sd}{Usage:}
\PYG{l+s+sd}{    rnas-galaxy-upload \textless{}local\PYGZus{}file\textgreater{}}
\PYG{l+s+sd}{"""}
\PYG{k+kn}{import} \PYG{n+nn}{sys}\PYG{o}{,} \PYG{n+nn}{os}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze} \PYG{k+kn}{import} \PYG{n}{galaxy}

\PYG{k}{def} \PYG{n+nf}{main}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}

    \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{)} \PYG{o}{\textless{}} \PYG{l+m+mi}{2} \PYG{o+ow}{or} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o+ow}{in} \PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{-h}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{--help}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{print} \PYG{n}{\PYGZus{}\PYGZus{}doc\PYGZus{}\PYGZus{}}
        \PYG{k}{return}

    \PYG{k}{print} \PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{upload}\PYG{p}{(}\PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{,} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{basename}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.cli.gb2fasta}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-cli-gb2fasta}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""\PYGZbs{}}
\PYG{l+s+sd}{RNA-Seqlyze gb2fasta}

\PYG{l+s+sd}{Convert a genbank file to fasta format}

\PYG{l+s+sd}{Usage:}
\PYG{l+s+sd}{    rnas-gb2fasta \textless{}input.gb\textgreater{} \textless{}output.fa\textgreater{}}

\PYG{l+s+sd}{If \textless{}input.gb\textgreater{} is '-', use 'sys.stdin, if \textless{}output.fa\textgreater{} is '-', use 'sys.stdout'.}
\PYG{l+s+sd}{"""}
\PYG{k+kn}{import} \PYG{n+nn}{sys}
\PYG{k+kn}{import} \PYG{n+nn}{Bio.SeqIO}

\PYG{k}{def} \PYG{n+nf}{main}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}

    \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{)} \PYG{o}{\textless{}} \PYG{l+m+mi}{2} \PYG{o+ow}{or} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o+ow}{in} \PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{-h}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{--help}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{print} \PYG{n}{\PYGZus{}\PYGZus{}doc\PYGZus{}\PYGZus{}}
        \PYG{k}{return}

    \PYG{n}{inputfile} \PYG{o}{=} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{-}\PYG{l+s}{'} \PYG{o+ow}{and} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{stdin} \PYG{o+ow}{or} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{outputfile} \PYG{o}{=} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{-}\PYG{l+s}{'} \PYG{o+ow}{and} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{stdout} \PYG{o+ow}{or} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w}\PYG{l+s}{"}\PYG{p}{)}
    \PYG{n}{Bio}\PYG{o}{.}\PYG{n}{SeqIO}\PYG{o}{.}\PYG{n}{write}\PYG{p}{(}\PYG{n}{Bio}\PYG{o}{.}\PYG{n}{SeqIO}\PYG{o}{.}\PYG{n}{parse}\PYG{p}{(}\PYG{n}{inputfile}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{genbank}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{,} \PYG{n}{outputfile}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{fasta}\PYG{l+s}{"}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.cli.gb2ptt}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-cli-gb2ptt}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""\PYGZbs{}}
\PYG{l+s+sd}{RNA-Seqlyze gb2ptt}

\PYG{l+s+sd}{Convert a genbank file to ptt (protein table) format}

\PYG{l+s+sd}{Usage:}
\PYG{l+s+sd}{    rnas-gb2ptt \textless{}input.gb\textgreater{} \textless{}output.ptt\textgreater{}}

\PYG{l+s+sd}{If \textless{}input.gb\textgreater{} is '-', use 'sys.stdin, if \textless{}output.ptt\textgreater{} is '-', use 'sys.stdout'.}
\PYG{l+s+sd}{"""}
\PYG{k+kn}{import} \PYG{n+nn}{sys}\PYG{o}{,} \PYG{n+nn}{logging}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.gb2ptt} \PYG{k+kn}{import} \PYG{n}{gb2ptt}

\PYG{k}{def} \PYG{n+nf}{main}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}

    \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{)} \PYG{o}{\textless{}} \PYG{l+m+mi}{2} \PYG{o+ow}{or} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o+ow}{in} \PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{-h}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{--help}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{print} \PYG{n}{\PYGZus{}\PYGZus{}doc\PYGZus{}\PYGZus{}}
        \PYG{k}{return}

    \PYG{n}{inputfile} \PYG{o}{=} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{-}\PYG{l+s}{'} \PYG{o+ow}{and} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{stdin} \PYG{o+ow}{or} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{outputfile} \PYG{o}{=} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{-}\PYG{l+s}{'} \PYG{o+ow}{and} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{stdout} \PYG{o+ow}{or} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w}\PYG{l+s}{"}\PYG{p}{)}

    \PYG{n}{loggin}\PYG{o}{.}\PYG{n}{basicConfig}\PYG{p}{(}\PYG{n}{level}\PYG{o}{=}\PYG{n}{logging}\PYG{o}{.}\PYG{n}{NOTSET}\PYG{p}{)} \PYG{c}{\PYGZsh{} logs to stderr}

    \PYG{n}{gb2ptt}\PYG{p}{(}\PYG{n}{inputfile}\PYG{p}{,} \PYG{n}{outputfile}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.cli.init}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-cli-init}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""\PYGZbs{}}
\PYG{l+s+sd}{RNA-Seqlyze Init}

\PYG{l+s+sd}{(Re-)initialize an rnaseqlyze 'workdir'.}

\PYG{l+s+sd}{Usage:}
\PYG{l+s+sd}{    rnas-init \textless{}workdir\textgreater{}}
\PYG{l+s+sd}{    rnas-init --recreatedb \textless{}workdir\textgreater{}}
\PYG{l+s+sd}{    rnas-init --development \textless{}workdir\textgreater{}}
\PYG{l+s+sd}{    rnas-init -h\textbar{}--help}

\PYG{l+s+sd}{Options:}
\PYG{l+s+sd}{    --recreatedb}
\PYG{l+s+sd}{                    Remove and re-initialize the database if it exists.}

\PYG{l+s+sd}{    --development}
\PYG{l+s+sd}{                    Use the development versions of the config file templates.}

\PYG{l+s+sd}{Arguments:}
\PYG{l+s+sd}{    \textless{}workdir\textgreater{}}
\PYG{l+s+sd}{                    The filesystem path to the directory to be initialized.}
\PYG{l+s+sd}{                    If the directory already exists, by default, existing}
\PYG{l+s+sd}{                    files inside that directory are not overwritten.}

\PYG{l+s+sd}{.. important::}
\PYG{l+s+sd}{                    The {}`WORKDIR{}` variable in the "/etc/init.d/rnaseqlyze.sh"}
\PYG{l+s+sd}{                    worker daemon startup script and the {}`workdir{}` variable}
\PYG{l+s+sd}{                    in the "/var/www/../rna-seqlyze.wsgi" script must both}
\PYG{l+s+sd}{                    be set to the directory specified here!}

\PYG{l+s+sd}{Documentation:}

\PYG{l+s+sd}{    The 'workdir' holds}

\PYG{l+s+sd}{        - configuration files        ({}`*.ini{}`)}
\PYG{l+s+sd}{        - the application database   ({}`rnaseqlyze.db{}`)}
\PYG{l+s+sd}{        - log files                  ({}`*.log{}`)}
\PYG{l+s+sd}{        - shared data                ({}`shared\PYGZus{}data/{}`)}
\PYG{l+s+sd}{        - individual analysis data   ({}`analyses/{}`)}

\PYG{l+s+sd}{    The rnas-init command}

\PYG{l+s+sd}{        - creates the \textless{}workdir\textgreater{} if it does not already exist}
\PYG{l+s+sd}{        - copies default configuration files 'rnaseqlyze.ini', 'web.ini'}
\PYG{l+s+sd}{          and 'worker.ini' into the \textless{}workdir\textgreater{} if they do not already exist.}
\PYG{l+s+sd}{        - initializes the database that is configured in the 'rnaseqlyze.ini'}
\PYG{l+s+sd}{          config file if it doesn't already exist and --recreatedb is not given.}

\PYG{l+s+sd}{    The database to be initialized is configured with "db\PYGZus{}url =" in the}
\PYG{l+s+sd}{    "[rnaseqlyze]" section in 'rnaseqlyze.ini'.  It is expected to be an sqlite}
\PYG{l+s+sd}{    database.  If the command creates the sqlite database file, it changes it's}
\PYG{l+s+sd}{    unix access mode to (octal) 0664 and the group membership is changed to}
\PYG{l+s+sd}{    \textless{}group\textgreater{}.  \textless{}group\textgreater{} can be confgured in 'rnaseqlyze.ini'.  If the command}
\PYG{l+s+sd}{    creates the \textless{}workdir\textgreater{}, it changes it's unix access mode to (octal) 0775 and}
\PYG{l+s+sd}{    the group membership is also changed to \textless{}group\textgreater{}.  The command changes the}
\PYG{l+s+sd}{    unix access mode and group membership of all .log files inside the workdir}
\PYG{l+s+sd}{    to (octal) 0664 and \textless{}group\textgreater{}.}
\PYG{l+s+sd}{"""}

\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{import} \PYG{n+nn}{os}\PYG{o}{,} \PYG{n+nn}{sys}\PYG{o}{,} \PYG{n+nn}{grp}\PYG{o}{,} \PYG{n+nn}{shutil}

\PYG{k+kn}{import} \PYG{n+nn}{pkg\PYGZus{}resources}
\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy} \PYG{k+kn}{import} \PYG{n}{create\PYGZus{}engine}
\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy.orm} \PYG{k+kn}{import} \PYG{n}{sessionmaker}

\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}
\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze.web}
\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze.worker}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core.entities} \PYG{k+kn}{import} \PYG{n}{Entity}

\PYG{n}{Session} \PYG{o}{=} \PYG{n}{sessionmaker}\PYG{p}{(}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{main}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}

    \PYG{k+kn}{import} \PYG{n+nn}{docopt}
    \PYG{n}{opts} \PYG{o}{=} \PYG{n}{docopt}\PYG{o}{.}\PYG{n}{docopt}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}doc\PYGZus{}\PYGZus{}}\PYG{p}{)}

    \PYG{n}{workdir} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{abspath}\PYG{p}{(}\PYG{n}{opts}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{\textless{}workdir\textgreater{}}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} create the workdir if it does not exist}
    \PYG{n}{wd\PYGZus{}created} \PYG{o}{=} \PYG{n+nb+bp}{False}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{isdir}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{error}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{not a directory: }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{workdir}\PYG{p}{)}
            \PYG{n}{sys}\PYG{o}{.}\PYG{n}{exit}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{creating workdir }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{workdir}\PYG{p}{)}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{makedirs}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{)}
        \PYG{n}{wd\PYGZus{}created} \PYG{o}{=} \PYG{n+nb+bp}{True}

    \PYG{c}{\PYGZsh{} create each config file that does not exist}
    \PYG{k}{for} \PYG{n}{pkg} \PYG{o+ow}{in} \PYG{n}{rnaseqlyze}\PYG{p}{,} \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{web}\PYG{p}{,} \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{worker}\PYG{p}{:}

        \PYG{c}{\PYGZsh{} determine the destination file name}
        \PYG{n}{conf\PYGZus{}name} \PYG{o}{=} \PYG{n}{pkg}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{.}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{[}\PYG{o}{-}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{.ini}\PYG{l+s}{"}
        \PYG{n}{conf\PYGZus{}path} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{,} \PYG{n}{conf\PYGZus{}name}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{n}{conf\PYGZus{}path}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{continue}

        \PYG{c}{\PYGZsh{} determine the source file name}
        \PYG{k}{if} \PYG{n}{pkg}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}} \PYG{o}{==} \PYG{l+s}{"}\PYG{l+s}{rnaseqlyze}\PYG{l+s}{"}\PYG{p}{:}
            \PYG{c}{\PYGZsh{} for the core package there is currently}
            \PYG{c}{\PYGZsh{} only one config file template}
            \PYG{n}{ini} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{rnaseqlyze.ini}\PYG{l+s}{'}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{c}{\PYGZsh{} for the non-core packages, take the desired version}
            \PYG{n}{ini} \PYG{o}{=} \PYG{n}{opts}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{--development}\PYG{l+s}{'}\PYG{p}{]} \PYG{o+ow}{and} \PYG{l+s}{"}\PYG{l+s}{development.ini}\PYG{l+s}{"} \PYG{o+ow}{or} \PYG{l+s}{"}\PYG{l+s}{production.ini}\PYG{l+s}{"}
        \PYG{c}{\PYGZsh{} get the file as a resource stream, which works even}
        \PYG{c}{\PYGZsh{} if the distribution if installed as a zipped .egg}
        \PYG{n}{req} \PYG{o}{=} \PYG{n}{pkg\PYGZus{}resources}\PYG{o}{.}\PYG{n}{Requirement}\PYG{o}{.}\PYG{n}{parse}\PYG{p}{(}\PYG{n}{pkg}\PYG{o}{.}\PYG{n}{project\PYGZus{}name}\PYG{p}{)}
        \PYG{n}{res} \PYG{o}{=} \PYG{n}{pkg\PYGZus{}resources}\PYG{o}{.}\PYG{n}{resource\PYGZus{}stream}\PYG{p}{(}\PYG{n}{req}\PYG{p}{,} \PYG{n}{ini}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{creating config file }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{conf\PYGZus{}name}\PYG{p}{)}
        \PYG{n}{shutil}\PYG{o}{.}\PYG{n}{copyfileobj}\PYG{p}{(}\PYG{n}{res}\PYG{p}{,} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{conf\PYGZus{}path}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} init rnaseqlyze configuration -- creates all .log files}
    \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{configure}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} set proper permissions on the log files}
    \PYG{k}{for} \PYG{n}{name} \PYG{o+ow}{in} \PYG{n}{os}\PYG{o}{.}\PYG{n}{listdir}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{name}\PYG{o}{.}\PYG{n}{endswith}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{.log}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{path} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{,} \PYG{n}{name}\PYG{p}{)}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{adjusting permissions on }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{name}\PYG{p}{)}
            \PYG{n}{os}\PYG{o}{.}\PYG{n}{chmod}\PYG{p}{(}\PYG{n}{path}\PYG{p}{,} \PYG{l+m+mo}{0664}\PYG{p}{)}
            \PYG{n}{os}\PYG{o}{.}\PYG{n}{chown}\PYG{p}{(}\PYG{n}{path}\PYG{p}{,} \PYG{o}{-}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{grp}\PYG{o}{.}\PYG{n}{getgrnam}\PYG{p}{(}\PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{group}\PYG{p}{)}\PYG{o}{.}\PYG{n}{gr\PYGZus{}gid}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} delayed because 'rnaseqlyze.group' was}
    \PYG{c}{\PYGZsh{} not known before calling rnaseqlyze.configure() above}
    \PYG{k}{if} \PYG{n}{wd\PYGZus{}created}\PYG{p}{:}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{adjusting permissions on }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{workdir}\PYG{p}{)}
        \PYG{c}{\PYGZsh{} change permission bits}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{chmod}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{,} \PYG{l+m+mo}{0775}\PYG{p}{)}
        \PYG{c}{\PYGZsh{} change group membership}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{chown}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{,} \PYG{o}{-}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{grp}\PYG{o}{.}\PYG{n}{getgrnam}\PYG{p}{(}\PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{group}\PYG{p}{)}\PYG{o}{.}\PYG{n}{gr\PYGZus{}gid}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} get the database file path}
    \PYG{n}{db\PYGZus{}path} \PYG{o}{=} \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{db\PYGZus{}url}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{:}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}

    \PYG{c}{\PYGZsh{} remove the databse file}
    \PYG{c}{\PYGZsh{} if it exists and --recreatedb is given}
    \PYG{k}{if} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{n}{db\PYGZus{}path}\PYG{p}{)} \PYG{o+ow}{and} \PYG{n}{opts}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{--recreatedb}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{:}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{removing existing database file }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}}
                                                   \PYG{n}{db\PYGZus{}path}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{/}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{[}\PYG{o}{-}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{unlink}\PYG{p}{(}\PYG{n}{db\PYGZus{}path}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} create the database if it doesn't exist}
    \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{n}{db\PYGZus{}path}\PYG{p}{)}\PYG{p}{:}

        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{recreating database }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{db\PYGZus{}url}\PYG{p}{)}

        \PYG{c}{\PYGZsh{} create sqlalchemy db engine}
        \PYG{n}{engine} \PYG{o}{=} \PYG{n}{create\PYGZus{}engine}\PYG{p}{(}\PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{db\PYGZus{}url}\PYG{p}{)}

        \PYG{c}{\PYGZsh{} create the file and initialize the schema}
        \PYG{k}{with} \PYG{n}{engine}\PYG{o}{.}\PYG{n}{begin}\PYG{p}{(}\PYG{p}{)} \PYG{k}{as} \PYG{n}{conn}\PYG{p}{:}
            \PYG{n}{Entity}\PYG{o}{.}\PYG{n}{metadata}\PYG{o}{.}\PYG{n}{create\PYGZus{}all}\PYG{p}{(}\PYG{n}{conn}\PYG{p}{)}

        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{adjusting permissions on database file}\PYG{l+s}{"}\PYG{p}{)}

        \PYG{c}{\PYGZsh{} change permission bits}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{chmod}\PYG{p}{(}\PYG{n}{db\PYGZus{}path}\PYG{p}{,} \PYG{l+m+mo}{0664}\PYG{p}{)}
        \PYG{c}{\PYGZsh{} change group membership}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{chown}\PYG{p}{(}\PYG{n}{db\PYGZus{}path}\PYG{p}{,} \PYG{o}{-}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{grp}\PYG{o}{.}\PYG{n}{getgrnam}\PYG{p}{(}\PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{group}\PYG{p}{)}\PYG{o}{.}\PYG{n}{gr\PYGZus{}gid}\PYG{p}{)}

        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{initializing organism cache}\PYG{l+s}{"}\PYG{p}{)}

        \PYG{c}{\PYGZsh{} initialize UCSC Browser list of organisms}
        \PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze} \PYG{k+kn}{import} \PYG{n}{org\PYGZus{}cache}
        \PYG{k}{with} \PYG{n}{engine}\PYG{o}{.}\PYG{n}{begin}\PYG{p}{(}\PYG{p}{)} \PYG{k}{as} \PYG{n}{conn}\PYG{p}{:}
            \PYG{n}{session} \PYG{o}{=} \PYG{n}{Session}\PYG{p}{(}\PYG{n}{bind}\PYG{o}{=}\PYG{n}{conn}\PYG{p}{)}
            \PYG{n}{org\PYGZus{}cache}\PYG{o}{.}\PYG{n}{refresh}\PYG{p}{(}\PYG{n}{session}\PYG{p}{)}
            \PYG{n}{session}\PYG{o}{.}\PYG{n}{commit}\PYG{p}{(}\PYG{p}{)}

    \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{workdir initialized}\PYG{l+s}{"}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.cli.transterm}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-cli-transterm}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""\PYGZbs{}}
\PYG{l+s+sd}{RNA-Seqlyze transterm}

\PYG{l+s+sd}{Calls the transterm program}
\PYG{l+s+sd}{with an additional "-p \textless{}path to\textgreater{}/expterm.dat" argument.}

\PYG{l+s+sd}{Usage:}
\PYG{l+s+sd}{    rnas-transterm [--] \textless{}transterm arguments\textgreater{} ...}
\PYG{l+s+sd}{    rnas-transterm -h\textbar{}--help}
\PYG{l+s+sd}{"""}
\PYG{k+kn}{import} \PYG{n+nn}{sys}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.transterm} \PYG{k+kn}{import} \PYG{n}{run}

\PYG{k}{def} \PYG{n+nf}{main}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}

    \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{)} \PYG{o}{\textgreater{}} \PYG{l+m+mi}{1} \PYG{o+ow}{and} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{--}\PYG{l+s}{'}\PYG{p}{:}
        \PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{o}{.}\PYG{n}{pop}\PYG{p}{(}\PYG{l+m+mi}{1}\PYG{p}{)}
    \PYG{k}{elif} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{)} \PYG{o}{\textless{}} \PYG{l+m+mi}{2} \PYG{o+ow}{or} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o+ow}{in} \PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{-h}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{--help}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{print} \PYG{n}{\PYGZus{}\PYGZus{}doc\PYGZus{}\PYGZus{}}
        \PYG{k}{return}

    \PYG{n}{run}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{:}\PYG{p}{]}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.cli.xmltool}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-cli-xmltool}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""\PYGZbs{}}
\PYG{l+s+sd}{RNA-Seqlyze xmltool}

\PYG{l+s+sd}{XML version of of {}`python -m json.tool{}`.}

\PYG{l+s+sd}{Takes an xml file or stream as input and pretty-prints it.}

\PYG{l+s+sd}{Usage:}
\PYG{l+s+sd}{    rnas-xmltool \textless{}input.xml\textgreater{} \textless{}output.xml\textgreater{}}

\PYG{l+s+sd}{If \textless{}input.xml\textgreater{} is '-', use 'sys.stdin, if \textless{}output.xml\textgreater{} is '-', use 'sys.stdout'.}
\PYG{l+s+sd}{"""}
\PYG{k+kn}{import} \PYG{n+nn}{sys}
\PYG{k+kn}{from} \PYG{n+nn}{lxml} \PYG{k+kn}{import} \PYG{n}{etree}

\PYG{k}{def} \PYG{n+nf}{main}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}

    \PYG{k}{if} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{)} \PYG{o}{\textless{}} \PYG{l+m+mi}{2} \PYG{o+ow}{or} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o+ow}{in} \PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{-h}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{--help}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{print} \PYG{n}{\PYGZus{}\PYGZus{}doc\PYGZus{}\PYGZus{}}
        \PYG{k}{return}

    \PYG{n}{inputfile} \PYG{o}{=} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{-}\PYG{l+s}{'} \PYG{o+ow}{and} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{stdin} \PYG{o+ow}{or} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{outputfile} \PYG{o}{=} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{-}\PYG{l+s}{'} \PYG{o+ow}{and} \PYG{n}{sys}\PYG{o}{.}\PYG{n}{stdout} \PYG{o+ow}{or} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{sys}\PYG{o}{.}\PYG{n}{argv}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w}\PYG{l+s}{"}\PYG{p}{)}

    \PYG{n}{tree} \PYG{o}{=} \PYG{n}{etree}\PYG{o}{.}\PYG{n}{parse}\PYG{p}{(}\PYG{n}{inputfile}\PYG{p}{,}
                       \PYG{n}{etree}\PYG{o}{.}\PYG{n}{XMLParser}\PYG{p}{(}\PYG{n}{remove\PYGZus{}blank\PYGZus{}text}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{print} \PYG{o}{\textgreater{}\textgreater{}} \PYG{n}{outputfile}\PYG{p}{,} \PYG{n}{etree}\PYG{o}{.}\PYG{n}{tostring}\PYG{p}{(}\PYG{n}{tree}\PYG{o}{.}\PYG{n}{getroot}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,} \PYG{n}{pretty\PYGZus{}print}\PYG{o}{=}\PYG{n+nb+bp}{True}\PYG{p}{)}
\end{Verbatim}


\subsubsection{Package \texttt{rnaseqlyze.web}}
\label{rnaseqlyze-pdf:package-rnaseqlyze-web}

\paragraph{Modul \texttt{rnaseqlyze.web}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-web}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{**pyramid.web** is a Pyramid Web Framework Application.}

\PYG{l+s+sd}{To learn more about the applications architecture, head over to the wonderful}
\PYG{l+s+sd}{world of the pyramid web framework at http://www.pylonsproject.org/.}

\PYG{l+s+sd}{This application has been created using the {}`{}`pcreate{}`{}` command with the {}`{}`-s}
\PYG{l+s+sd}{alchemy{}`{}` option to create and sqlalchemy scaffold. There is plenty of {}`very}
\PYG{l+s+sd}{good documentation \textless{}http://docs.pylonsproject.org/projects/pyramid/en/latest/\PYGZbs{}}
\PYG{l+s+sd}{narr/project.html\PYGZsh{}scaffolds-included-with-pyramid\textgreater{}{}`\PYGZus{} available on how to do it.}

\PYG{l+s+sd}{In case you have trouble with anything pyramid-related, use the {}`source code on}
\PYG{l+s+sd}{github \textless{}https://github.com/Pylons/pyramid\textgreater{}{}`\PYGZus{} or ask 'mcdonc' on freenode irc}
\PYG{l+s+sd}{{}`\PYGZsh{}pyramid \textless{}http://webchat.freenode.net/?channels=\PYGZsh{}pyramid\textgreater{}{}`\PYGZus{}.}
\PYG{l+s+sd}{"""}

\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy} \PYG{k+kn}{import} \PYG{n}{create\PYGZus{}engine}
\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy.orm} \PYG{k+kn}{import} \PYG{n}{sessionmaker}\PYG{p}{,} \PYG{n}{scoped\PYGZus{}session}
\PYG{k+kn}{from} \PYG{n+nn}{pyramid.config} \PYG{k+kn}{import} \PYG{n}{Configurator}
\PYG{c}{\PYGZsh{}: the zope transaction extension}
\PYG{k+kn}{from} \PYG{n+nn}{zope.sqlalchemy} \PYG{k+kn}{import} \PYG{n}{ZopeTransactionExtension}

\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.web.jsonx} \PYG{k+kn}{import} \PYG{n}{jsonx}
\PYG{n}{project\PYGZus{}name} \PYG{o}{=} \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{project\PYGZus{}name} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{-web}\PYG{l+s}{"}

\PYG{c}{\PYGZsh{}: a session managed by}
\PYG{c}{\PYGZsh{}: ZopeTransactionExtension}
\PYG{c}{\PYGZsh{}:}
\PYG{c}{\PYGZsh{}: - http://stackoverflow.com/a/6044925}
\PYG{c}{\PYGZsh{}: - pyramid\PYGZus{}tm (transaction manager) is configured}
\PYG{n}{DBSession} \PYG{o}{=} \PYG{n}{scoped\PYGZus{}session}\PYG{p}{(}\PYG{n}{sessionmaker}\PYG{p}{(}\PYG{n}{extension}\PYG{o}{=}\PYG{n}{ZopeTransactionExtension}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

\PYG{c}{\PYGZsh{}: an unmanaged session}
\PYG{c}{\PYGZsh{}:}
\PYG{c}{\PYGZsh{}: used by :meth:{}`rnaseqlyze.web.views.post{}`}
\PYG{c}{\PYGZsh{}: because the session needs to be commited early there}
\PYG{n}{DBSession\PYGZus{}unmanaged} \PYG{o}{=} \PYG{n}{scoped\PYGZus{}session}\PYG{p}{(}\PYG{n}{sessionmaker}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{main}\PYG{p}{(}\PYG{n}{global\PYGZus{}config}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{settings}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Create and return a Pyramid WSGI application.}
\PYG{l+s+sd}{    """}
    \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{rnaseqlyze.web version }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ : main()}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}version\PYGZus{}\PYGZus{}}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} make sure to be able to delete files created by webapp}
    \PYG{c}{\PYGZsh{} as user/group www-data/www-data from the command line}
    \PYG{c}{\PYGZsh{} (as user/group johndoe/www-data)}
    \PYG{k+kn}{import} \PYG{n+nn}{os}
    \PYG{n}{os}\PYG{o}{.}\PYG{n}{umask}\PYG{p}{(}\PYG{l+m+mo}{0002}\PYG{p}{)}

    \PYG{n}{engine} \PYG{o}{=} \PYG{n}{create\PYGZus{}engine}\PYG{p}{(}\PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{db\PYGZus{}url}\PYG{p}{)}
    \PYG{n}{DBSession}\PYG{o}{.}\PYG{n}{configure}\PYG{p}{(}\PYG{n}{bind}\PYG{o}{=}\PYG{n}{engine}\PYG{p}{)}
    \PYG{n}{DBSession\PYGZus{}unmanaged}\PYG{o}{.}\PYG{n}{configure}\PYG{p}{(}\PYG{n}{bind}\PYG{o}{=}\PYG{n}{engine}\PYG{p}{)}

    \PYG{n}{config} \PYG{o}{=} \PYG{n}{Configurator}\PYG{p}{(}\PYG{n}{settings}\PYG{o}{=}\PYG{n}{settings}\PYG{p}{)}

    \PYG{n}{config}\PYG{o}{.}\PYG{n}{add\PYGZus{}renderer}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{jsonx}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{jsonx}\PYG{p}{)}

    \PYG{n}{config}\PYG{o}{.}\PYG{n}{scan}\PYG{p}{(}\PYG{p}{)}

    \PYG{n}{config}\PYG{o}{.}\PYG{n}{add\PYGZus{}route}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{home}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{/}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{n}{config}\PYG{o}{.}\PYG{n}{add\PYGZus{}route}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{upload}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{/upload}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{n}{config}\PYG{o}{.}\PYG{n}{add\PYGZus{}route}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{analyses}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{/analyses}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{n}{config}\PYG{o}{.}\PYG{n}{add\PYGZus{}route}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{analysis}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{/analyses/\PYGZob{}id\PYGZcb{}}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{n}{config}\PYG{o}{.}\PYG{n}{add\PYGZus{}route}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{analysis\PYGZus{}files}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{/analyses/\PYGZob{}id\PYGZcb{}/files*subpath}\PYG{l+s}{'}\PYG{p}{)}

    \PYG{n}{config}\PYG{o}{.}\PYG{n}{add\PYGZus{}route}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{analysis\PYGZus{}rest}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{/rest/analyses/\PYGZob{}id\PYGZcb{}}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{n}{config}\PYG{o}{.}\PYG{n}{add\PYGZus{}route}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{analysis\PYGZus{}logs\PYGZus{}rest}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{/rest/analyses/\PYGZob{}id\PYGZcb{}/logs}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{n}{config}\PYG{o}{.}\PYG{n}{add\PYGZus{}route}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{analysis\PYGZus{}files\PYGZus{}rest}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{/rest/analyses/\PYGZob{}id\PYGZcb{}/files}\PYG{l+s}{'}\PYG{p}{)}

    \PYG{n}{config}\PYG{o}{.}\PYG{n}{add\PYGZus{}route}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{organisms\PYGZus{}rest}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{/rest/organisms}\PYG{l+s}{'}\PYG{p}{)}

    \PYG{k}{for} \PYG{n}{path} \PYG{o+ow}{in} \PYG{l+s}{'}\PYG{l+s}{less}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{css}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{img}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{js}\PYG{l+s}{'}\PYG{p}{:}
        \PYG{n}{config}\PYG{o}{.}\PYG{n}{add\PYGZus{}static\PYGZus{}view}\PYG{p}{(}\PYG{n}{path}\PYG{p}{,} \PYG{n}{path}\PYG{p}{)}

    \PYG{k}{return} \PYG{n}{config}\PYG{o}{.}\PYG{n}{make\PYGZus{}wsgi\PYGZus{}app}\PYG{p}{(}\PYG{p}{)}

\PYG{k+kn}{from} \PYG{n+nn}{pyramid.events} \PYG{k+kn}{import} \PYG{n}{subscriber}
\PYG{k+kn}{from} \PYG{n+nn}{pyramid.events} \PYG{k+kn}{import} \PYG{n}{BeforeRender}
\PYG{k+kn}{from} \PYG{n+nn}{pyramid.renderers} \PYG{k+kn}{import} \PYG{n}{get\PYGZus{}renderer}

\PYG{n+nd}{@subscriber}\PYG{p}{(}\PYG{n}{BeforeRender}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{before\PYGZus{}render}\PYG{p}{(}\PYG{n}{event}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    This function is called by Pyramid after the view callable has returned}
\PYG{l+s+sd}{    and before the renderer (json / chameleon) is called. We inject some}
\PYG{l+s+sd}{    convienience functions and objects that are used in the {}`zope page}
\PYG{l+s+sd}{    templates \textless{}http://pagetemplates.org/docs/latest/reference.html\textgreater{}{}`\PYGZus{}}
\PYG{l+s+sd}{    (.pt files) which {}`the chameleon template engine}
\PYG{l+s+sd}{    \textless{}http://pagetemplates.org/\textgreater{}{}`\PYGZus{} then renders.}
\PYG{l+s+sd}{    """}

    \PYG{n}{base} \PYG{o}{=} \PYG{n}{get\PYGZus{}renderer}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{templates/base.pt}\PYG{l+s}{'}\PYG{p}{)}\PYG{o}{.}\PYG{n}{implementation}\PYG{p}{(}\PYG{p}{)}

    \PYG{n}{rq} \PYG{o}{=} \PYG{n}{event}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{request}\PYG{l+s}{'}\PYG{p}{]}
    \PYG{n}{path} \PYG{o}{=} \PYG{k}{lambda} \PYG{n}{sub}\PYG{p}{:} \PYG{n}{rq}\PYG{o}{.}\PYG{n}{route\PYGZus{}path}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{home}\PYG{l+s}{'}\PYG{p}{)} \PYG{o}{+} \PYG{n}{sub}
    \PYG{n}{relpath} \PYG{o}{=} \PYG{k}{lambda} \PYG{n}{sub}\PYG{p}{:} \PYG{n}{rq}\PYG{o}{.}\PYG{n}{current\PYGZus{}route\PYGZus{}path}\PYG{p}{(}\PYG{p}{)} \PYG{o}{+} \PYG{l+s}{'}\PYG{l+s}{/}\PYG{l+s}{'} \PYG{o}{+} \PYG{n}{sub}

    \PYG{n}{event}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{p}{\PYGZob{}}
        \PYG{l+s}{'}\PYG{l+s}{base}\PYG{l+s}{'}\PYG{p}{:} \PYG{n}{base}\PYG{p}{,}
        \PYG{l+s}{'}\PYG{l+s}{path}\PYG{l+s}{'}\PYG{p}{:} \PYG{n}{path}\PYG{p}{,}
        \PYG{l+s}{'}\PYG{l+s}{relpath}\PYG{l+s}{'}\PYG{p}{:} \PYG{n}{relpath}\PYG{p}{,}
        \PYG{l+s}{'}\PYG{l+s}{version}\PYG{l+s}{'}\PYG{p}{:} \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}version\PYGZus{}\PYGZus{}}\PYG{p}{,}
        \PYG{l+s}{'}\PYG{l+s}{debug}\PYG{l+s}{'}\PYG{p}{:} \PYG{n}{log}\PYG{o}{.}\PYG{n}{getEffectiveLevel}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\textless{}}\PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{DEBUG}\PYG{p}{,}
    \PYG{p}{\PYGZcb{}}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.web.errors}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-web-errors}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{Pyramid Application Custom Error Views}
\PYG{l+s+sd}{"""}

\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{from} \PYG{n+nn}{string} \PYG{k+kn}{import} \PYG{n}{Template}

\PYG{k+kn}{from} \PYG{n+nn}{pyramid.view} \PYG{k+kn}{import} \PYG{n}{view\PYGZus{}config}
\PYG{k+kn}{from} \PYG{n+nn}{pyramid.response} \PYG{k+kn}{import} \PYG{n}{Response}\PYG{p}{,} \PYG{n}{FileResponse}
\PYG{k+kn}{from} \PYG{n+nn}{pyramid.httpexceptions} \PYG{k+kn}{import} \PYG{p}{(}
        \PYG{n}{HTTPFound}\PYG{p}{,} \PYG{n}{HTTPError}\PYG{p}{,} \PYG{n}{HTTPServiceUnavailable}\PYG{p}{,} \PYG{n}{HTTPInternalServerError}
\PYG{p}{)}

\PYG{k+kn}{import} \PYG{n+nn}{transaction}
\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy.exc} \PYG{k+kn}{import} \PYG{n}{DBAPIError}

\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.web} \PYG{k+kn}{import} \PYG{n}{DBSession}\PYG{p}{,} \PYG{n}{DBSession\PYGZus{}unmanaged}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core} \PYG{k+kn}{import} \PYG{n}{service}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core.entities} \PYG{k+kn}{import} \PYG{n}{Analysis}

\PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{context}\PYG{o}{=}\PYG{n+ne}{Exception}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{error}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    **Exception view**}

\PYG{l+s+sd}{    This is a catch-all view that serves up any errors}
\PYG{l+s+sd}{    that have occured while processing the a request.}

\PYG{l+s+sd}{    The view just creates and returns a custom error response object.}
\PYG{l+s+sd}{    """}
    \PYG{k}{return} \PYG{n}{HTTPRNASeqError}\PYG{p}{(}\PYG{n}{request}\PYG{o}{.}\PYG{n}{exc\PYGZus{}info}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{HTTPRNASeqError}\PYG{p}{(}\PYG{n}{HTTPError}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Custom HTTP Error class.}

\PYG{l+s+sd}{    This is a custom HTTP error class that extends}
\PYG{l+s+sd}{    :class:{}`pyramid.httpexceptions.HTTPError{}`, which extends}
\PYG{l+s+sd}{    :class:{}`pyramid.httpexceptions.WSGIHTTPException{}`. Have a look at the}
\PYG{l+s+sd}{    {}`source code \textless{}http://git.io/CqrfOg\PYGZsh{}L157\textgreater{}{}`\PYGZus{} to see how it works.}

\PYG{l+s+sd}{    It's {}`{}`code{}`{}` is 500, which generaly means "Internal Server Error".  If the}
\PYG{l+s+sd}{    application is in debugging mode -- i.e. the log level is DEBUG or less, a}
\PYG{l+s+sd}{    stack trace is added to the generated page as well as the log file.}
\PYG{l+s+sd}{    Otherwise, an informational message is displayed and only one line,}
\PYG{l+s+sd}{    containing the type of the error is logged.}
\PYG{l+s+sd}{    """}
    \PYG{n}{code} \PYG{o}{=} \PYG{l+m+mi}{500}
    \PYG{n}{title} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{RNA-Seqlyze Web Application Error}\PYG{l+s}{"}
    \PYG{n}{explanation} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{An Exception was raised in rnaseqlyze.web}\PYG{l+s}{"}
    \PYG{n}{html\PYGZus{}template\PYGZus{}obj} \PYG{o}{=} \PYG{n}{Template}\PYG{p}{(}\PYG{n}{Template}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{'}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n+nb}{map}\PYG{p}{(}\PYG{k}{lambda} \PYG{n}{s}\PYG{p}{:} \PYG{n}{s}\PYG{p}{[}\PYG{l+m+mi}{8}\PYG{p}{:}\PYG{p}{]}\PYG{p}{,} \PYG{l+s}{"""}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s}{        \textless{}html\textgreater{}}
\PYG{l+s}{        \textless{}head\textgreater{}}
\PYG{l+s}{        \textless{}title\textgreater{}\PYGZdl{}\PYGZob{}title\PYGZcb{}\textless{}/title\textgreater{}}
\PYG{l+s}{        \textless{}/head\textgreater{}}
\PYG{l+s}{        \textless{}body style=}\PYG{l+s}{"}\PYG{l+s}{margin: 20px;}\PYG{l+s}{"}\PYG{l+s}{\textgreater{}}
\PYG{l+s}{        \textless{}h1\textgreater{}\PYGZdl{}\PYGZob{}title\PYGZcb{}\textless{}/h1\textgreater{}}
\PYG{l+s}{        \PYGZdl{}\PYGZob{}body\PYGZcb{}}
\PYG{l+s}{        \textless{}/body\textgreater{}}
\PYG{l+s}{        \textless{}/html\textgreater{}}
\PYG{l+s}{        }\PYG{l+s}{"""}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{safe\PYGZus{}substitute}\PYG{p}{(}\PYG{n}{title}\PYG{o}{=}\PYG{n}{title}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{exc\PYGZus{}info}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{e} \PYG{o}{=} \PYG{n}{exc\PYGZus{}info}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{error}\PYG{p}{(}\PYG{n+nb}{repr}\PYG{p}{(}\PYG{n}{e}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{body\PYGZus{}template} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{\textless{}b\textgreater{}\PYGZdl{}\PYGZob{}explanation\PYGZcb{}\textless{}/b\textgreater{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{\textless{}hr/\textgreater{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{"}
        \PYG{n}{cls} \PYG{o}{=} \PYG{n}{e}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}class\PYGZus{}\PYGZus{}}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{e}\PYG{o}{.}\PYG{n}{args}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{explanation} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{cls}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{explanation} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n}{cls}\PYG{p}{,} \PYG{n}{e}\PYG{o}{.}\PYG{n}{args}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}

        \PYG{k}{if} \PYG{n}{log}\PYG{o}{.}\PYG{n}{getEffectiveLevel}\PYG{p}{(}\PYG{p}{)} \PYG{o}{\textgreater{}} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{DEBUG}\PYG{p}{:}     \PYG{c}{\PYGZsh{} no debug}
            \PYG{n}{detail} \PYG{o}{=} \PYG{n}{production\PYGZus{}error\PYGZus{}msg} \PYG{o}{\PYGZpc{}} \PYGZbs{}
                        \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{admin\PYGZus{}email}
            \PYG{n}{body\PYGZus{}template} \PYG{o}{+}\PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{\PYGZdl{}\PYGZob{}detail\PYGZcb{}}\PYG{l+s}{"}
        \PYG{k}{else}\PYG{p}{:}                                           \PYG{c}{\PYGZsh{} debug}
            \PYG{n}{detail} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{'}
            \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{e}\PYG{p}{,} \PYG{n}{DBAPIError}\PYG{p}{)}\PYG{p}{:}
                \PYG{n}{detail} \PYG{o}{+}\PYG{o}{=} \PYG{n}{dberror\PYGZus{}msg}
            \PYG{k+kn}{import} \PYG{n+nn}{traceback}
            \PYG{n}{detail} \PYG{o}{+}\PYG{o}{=} \PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{Stack trace:}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{'} \PYG{o}{\PYGZpc{}} \PYG{n}{e}
            \PYG{n}{detail} \PYG{o}{+}\PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{'}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{traceback}\PYG{o}{.}\PYG{n}{format\PYGZus{}tb}\PYG{p}{(}\PYG{n}{exc\PYGZus{}info}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}

            \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{n}{detail}\PYG{p}{)}
            \PYG{n}{body\PYGZus{}template} \PYG{o}{+}\PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{\textless{}pre\textgreater{}}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{\PYGZdl{}\PYGZob{}detail\PYGZcb{}\textless{}/pre\textgreater{}}\PYG{l+s}{"}

        \PYG{n}{HTTPError}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{detail}\PYG{p}{,} \PYG{n}{body\PYGZus{}template}\PYG{o}{=}\PYG{n}{body\PYGZus{}template}\PYG{p}{)}

\PYG{n}{dberror\PYGZus{}msg} \PYG{o}{=} \PYG{l+s}{"""}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s}{This is a database related eror.}

\PYG{l+s}{If it is not yet initialized or the schema has changed,}
\PYG{l+s}{just run the }\PYG{l+s}{"}\PYG{l+s}{rnas-dbinit}\PYG{l+s}{"}\PYG{l+s}{ script to (re-)initialize it.}

\PYG{l+s}{Afterwards, restart the Pyramid application, i.e. send a}
\PYG{l+s}{SIG\PYGZus{}INT to the apache mod\PYGZus{}wsgi daemon processes, and try again.}
\PYG{l+s}{"""}

\PYG{n}{production\PYGZus{}error\PYGZus{}msg} \PYG{o}{=} \PYG{l+s}{"""}\PYG{l+s+se}{\PYGZbs{}}
\PYG{l+s}{If you think that this is a bug, please contact the application administrator,}
\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{, and inform him/her of the time the error occurred, and anything you might}
\PYG{l+s}{have done that may have caused the error.}
\PYG{l+s}{Thank You!}
\PYG{l+s}{"""}
\PYG{c}{\PYGZsh{} 'You' is intentionally capitalized! :-) Rule 84: http://goo.gl/BLBwX}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.web.jsonx}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-web-jsonx}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{Pyramid JSON renderer that serializes arbitrary objects}

\PYG{l+s+sd}{Copies the object's \PYGZus{}\PYGZus{}dict\PYGZus{}\PYGZus{}, looks up all attrs}
\PYG{l+s+sd}{in all base classes's \PYGZus{}\PYGZus{}dict\PYGZus{}\PYGZus{}'s on the object}
\PYG{l+s+sd}{and then strips any unknown attribute types.}
\PYG{l+s+sd}{"""}

\PYG{c}{\PYGZsh{}import logging}
\PYG{c}{\PYGZsh{}log = logging.getLogger(\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{})}

\PYG{k+kn}{import} \PYG{n+nn}{json}

\PYG{c}{\PYGZsh{}: a custom json renderer}
\PYG{n}{jsonx} \PYG{o}{=} \PYG{k}{lambda} \PYG{n}{info}\PYG{p}{:} \PYG{n}{render\PYGZus{}json}

\PYG{k}{def} \PYG{n+nf}{render\PYGZus{}json}\PYG{p}{(}\PYG{n}{value}\PYG{p}{,} \PYG{n}{system}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    custom json renderer implementation}

\PYG{l+s+sd}{    based on http://git.io/a6BFGQ\PYGZsh{}L169}
\PYG{l+s+sd}{    """}

    \PYG{n}{request} \PYG{o}{=} \PYG{n}{system}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{request}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{k}{if} \PYG{n}{request} \PYG{o+ow}{is} \PYG{o+ow}{not} \PYG{n+nb+bp}{None}\PYG{p}{:}
        \PYG{n}{response} \PYG{o}{=} \PYG{n}{request}\PYG{o}{.}\PYG{n}{response}
        \PYG{n}{response}\PYG{o}{.}\PYG{n}{content\PYGZus{}type} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{application/json}\PYG{l+s}{'}
    \PYG{k}{return} \PYG{n}{json}\PYG{o}{.}\PYG{n}{dumps}\PYG{p}{(}\PYG{n}{value}\PYG{p}{,} \PYG{n}{default}\PYG{o}{=}\PYG{n}{render\PYGZus{}object}\PYG{p}{,} \PYG{n}{indent}\PYG{o}{=}\PYG{l+m+mi}{4}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{render\PYGZus{}object}\PYG{p}{(}\PYG{n}{obj}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    "default" function for json.dumps()}
\PYG{l+s+sd}{    """}
    \PYG{n}{attrs} \PYG{o}{=} \PYG{n+nb}{dict}\PYG{p}{(}\PYG{p}{(}\PYG{n}{attr}\PYG{p}{,} \PYG{n+nb}{getattr}\PYG{p}{(}\PYG{n}{obj}\PYG{p}{,} \PYG{n}{attr}\PYG{p}{)}\PYG{p}{)}
                    \PYG{k}{for} \PYG{n}{base} \PYG{o+ow}{in} \PYG{n}{obj}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}class\PYGZus{}\PYGZus{}}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}mro\PYGZus{}\PYGZus{}}
                    \PYG{k}{for} \PYG{n}{attr} \PYG{o+ow}{in} \PYG{n}{base}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}dict\PYGZus{}\PYGZus{}}
                    \PYG{k}{if} \PYG{n}{attr}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{!=} \PYG{l+s}{'}\PYG{l+s}{\PYGZus{}}\PYG{l+s}{'}\PYG{p}{)}

    \PYG{n}{attrs}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{n}{obj}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}dict\PYGZus{}\PYGZus{}}\PYG{p}{)}
\PYG{c}{\PYGZsh{}    log.debug(attrs)}
    \PYG{k}{return} \PYG{n+nb}{dict}\PYG{p}{(}\PYG{n+nb}{filter}\PYG{p}{(}\PYG{n}{filter\PYGZus{}attributes}\PYG{p}{,} \PYG{n}{attrs}\PYG{o}{.}\PYG{n}{iteritems}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

\PYG{n}{none\PYGZus{}type} \PYG{o}{=} \PYG{n+nb}{type}\PYG{p}{(}\PYG{n+nb+bp}{None}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{filter\PYGZus{}attributes}\PYG{p}{(}\PYG{n}{kv}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Helper function for render\PYGZus{}object}
\PYG{l+s+sd}{    """}
    \PYG{k}{if} \PYG{n}{kv}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{!=} \PYG{l+s}{'}\PYG{l+s}{\PYGZus{}}\PYG{l+s}{'} \PYG{o+ow}{and} \PYGZbs{}
       \PYG{n+nb}{type}\PYG{p}{(}\PYG{n}{kv}\PYG{p}{[}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{)} \PYG{o+ow}{in} \PYG{p}{(}\PYG{n}{none\PYGZus{}type}\PYG{p}{,} \PYG{n+nb}{bool}\PYG{p}{,} \PYG{n+nb}{int}\PYG{p}{,} \PYG{n+nb}{long}\PYG{p}{,} \PYG{n+nb}{float}\PYG{p}{,} \PYG{n+nb}{str}\PYG{p}{,} \PYG{n+nb}{unicode}\PYG{p}{,} \PYG{n+nb}{list}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{True}
    \PYG{k}{return} \PYG{n+nb+bp}{False}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.web.rest}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-web-rest}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{Pyramid REST Views}
\PYG{l+s+sd}{"""}
\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{import} \PYG{n+nn}{os}

\PYG{k+kn}{from} \PYG{n+nn}{pyramid.view} \PYG{k+kn}{import} \PYG{n}{view\PYGZus{}config}

\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.web} \PYG{k+kn}{import} \PYG{n}{DBSession}\PYG{p}{,} \PYG{n}{DBSession\PYGZus{}unmanaged}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core} \PYG{k+kn}{import} \PYG{n}{service}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core.entities} \PYG{k+kn}{import} \PYG{n}{Analysis}\PYG{p}{,} \PYG{n}{StageLog}\PYG{p}{,} \PYG{n}{UCSCOrganism}

\PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{route\PYGZus{}name}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{analysis\PYGZus{}rest}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{renderer}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{jsonx}\PYG{l+s}{'}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{display}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    **REST Analysis View**}
\PYG{l+s+sd}{    """}
    \PYG{n}{analysis} \PYG{o}{=} \PYG{n}{DBSession}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{Analysis}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{request}\PYG{o}{.}\PYG{n}{matchdict}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{id}\PYG{l+s}{"}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{first} \PYG{o}{=} \PYG{n}{DBSession}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{UCSCOrganism}\PYG{p}{)} \PYGZbs{}
                \PYG{o}{.}\PYG{n}{filter}\PYG{p}{(}\PYG{n}{UCSCOrganism}\PYG{o}{.}\PYG{n}{acc}\PYG{o}{.}\PYG{n}{like}\PYG{p}{(}
                    \PYG{n}{analysis}\PYG{o}{.}\PYG{n}{org\PYGZus{}accession} \PYG{o}{+} \PYG{l+s}{'}\PYG{l+s}{\PYGZpc{}}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{)}\PYG{o}{.}\PYG{n}{first}\PYG{p}{(}\PYG{p}{)}
    \PYG{n}{org\PYGZus{}db} \PYG{o}{=} \PYG{n}{first} \PYG{o+ow}{and} \PYG{n}{first}\PYG{o}{.}\PYG{n}{db}
    \PYG{n}{analysis}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}dict\PYGZus{}\PYGZus{}}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{p}{\PYGZob{}}
        \PYG{l+s}{'}\PYG{l+s}{org\PYGZus{}db}\PYG{l+s}{'}\PYG{p}{:} \PYG{n}{org\PYGZus{}db}\PYG{p}{,}
        \PYG{l+s}{'}\PYG{l+s}{hg\PYGZus{}url}\PYG{l+s}{'}\PYG{p}{:} \PYG{n}{analysis}\PYG{o}{.}\PYG{n}{get\PYGZus{}hg\PYGZus{}url}\PYG{p}{(}\PYG{n}{org\PYGZus{}db}\PYG{p}{)}\PYG{p}{\PYGZcb{}}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{analysis}

\PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{route\PYGZus{}name}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{analysis\PYGZus{}logs\PYGZus{}rest}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{renderer}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{jsonx}\PYG{l+s}{'}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{analysis\PYGZus{}stage\PYGZus{}logs}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    ***REST Stage Logs View***}
\PYG{l+s+sd}{    """}
    \PYG{n}{criterion} \PYG{o}{=} \PYG{n}{StageLog}\PYG{o}{.}\PYG{n}{analysis\PYGZus{}id} \PYG{o}{==} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{request}\PYG{o}{.}\PYG{n}{matchdict}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{id}\PYG{l+s}{"}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{logs} \PYG{o}{=} \PYG{n}{DBSession}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{StageLog}\PYG{p}{)}\PYG{o}{.}\PYG{n}{filter}\PYG{p}{(}\PYG{n}{criterion}\PYG{p}{)}\PYG{o}{.}\PYG{n}{all}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n+nb}{sorted}\PYG{p}{(}\PYG{n}{logs}\PYG{p}{,} \PYG{n}{key}\PYG{o}{=}\PYG{k}{lambda} \PYG{n}{log}\PYG{p}{:} \PYG{n}{log}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}

\PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{route\PYGZus{}name}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{analysis\PYGZus{}files\PYGZus{}rest}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{renderer}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{jsonx}\PYG{l+s}{'}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{analysis\PYGZus{}files}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    **REST Files View**}

\PYG{l+s+sd}{    This view provides a (minimalistic, only GET is}
\PYG{l+s+sd}{    implemented) REST interface to '/analysis/\PYGZob{}id\PYGZcb{}/files'.}
\PYG{l+s+sd}{    """}
    \PYG{n}{files} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
    \PYG{n}{analysis} \PYG{o}{=} \PYG{n}{DBSession}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{Analysis}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{request}\PYG{o}{.}\PYG{n}{matchdict}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{id}\PYG{l+s}{"}\PYG{p}{]}\PYG{p}{)}\PYG{p}{)}
    \PYG{n}{os}\PYG{o}{.}\PYG{n}{chdir}\PYG{p}{(}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{)}
    \PYG{k}{for} \PYG{n}{dirpath}\PYG{p}{,} \PYG{n}{dirnames}\PYG{p}{,} \PYG{n}{filenames} \PYG{o+ow}{in} \PYG{n}{os}\PYG{o}{.}\PYG{n}{walk}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{.}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{dir} \PYG{o}{=} \PYG{n}{dirpath}\PYG{p}{[}\PYG{l+m+mi}{2}\PYG{p}{:}\PYG{p}{]}
        \PYG{k}{for} \PYG{n}{fn} \PYG{o+ow}{in} \PYG{n}{filenames}\PYG{p}{:}
            \PYG{n}{files}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{l+s}{'}\PYG{l+s}{path}\PYG{l+s}{'}\PYG{p}{:} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n+nb}{dir}\PYG{p}{,} \PYG{n}{fn}\PYG{p}{)}\PYG{p}{\PYGZcb{}}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{files}

\PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{route\PYGZus{}name}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{organisms\PYGZus{}rest}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{renderer}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{jsonx}\PYG{l+s}{'}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{organisms}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    ***REST Organisms View***}

\PYG{l+s+sd}{    Displays the list of organism titles}
\PYG{l+s+sd}{    along with their UCSC db and NCBI RefSeq accession identifiers}
\PYG{l+s+sd}{    """}
    \PYG{k}{return} \PYG{n}{DBSession}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{UCSCOrganism}\PYG{p}{)}\PYG{o}{.}\PYG{n}{all}\PYG{p}{(}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.web.upload}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-web-upload}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{Pyramid Application Upload View}

\PYG{l+s+sd}{This module handles the upload of analysis files.}

\PYG{l+s+sd}{The upload interface consists of {}`plupload{}`}
\PYG{l+s+sd}{(from http://www.plupload.com/) on the client}
\PYG{l+s+sd}{and this hack on the server side. Combining the}
\PYG{l+s+sd}{two and creating a working solution was not trivial.}

\PYG{l+s+sd}{Documentation and inspiration to create this}
\PYG{l+s+sd}{was, amongst others, taken from the following documents:}

\PYG{l+s+sd}{ - http://www.plupload.com/documentation.php}
\PYG{l+s+sd}{ - http://hg.python.org/cpython/file/2.7/Lib/cgi.py\PYGZsh{}l353}
\PYG{l+s+sd}{ - https://raw.github.com/moxiecode/plupload/master/examples/upload.php}
\PYG{l+s+sd}{ - https://github.com/hcwebdev/plupload/blob/master/examples/server.py}
\PYG{l+s+sd}{ - https://github.com/Pylons/webob/blob/master/webob/request.py\PYGZsh{}L102}
\PYG{l+s+sd}{ - https://hg.gawel.org/gp.fileupload/file/default/gp/fileupload/storage.py\PYGZsh{}l97}
\PYG{l+s+sd}{"""}

\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{import} \PYG{n+nn}{transaction}
\PYG{k+kn}{from} \PYG{n+nn}{pyramid.view} \PYG{k+kn}{import} \PYG{n}{view\PYGZus{}config}

\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.web} \PYG{k+kn}{import} \PYG{n}{DBSession}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core} \PYG{k+kn}{import} \PYG{n}{service}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core.entities} \PYG{k+kn}{import} \PYG{n}{UploadSession}

\PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{route\PYGZus{}name}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{upload}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{request\PYGZus{}method}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{POST}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{renderer}\PYG{o}{=}\PYG{l+s}{"}\PYG{l+s}{json}\PYG{l+s}{"}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{upload}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{upload(): content-type }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{request}\PYG{o}{.}\PYG{n}{content\PYGZus{}type}\PYG{p}{)}
    \PYG{n}{fs} \PYG{o}{=} \PYG{n}{FieldStoragx}\PYG{p}{(}\PYG{n}{fp}\PYG{o}{=}\PYG{n}{request}\PYG{o}{.}\PYG{n}{environ}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{wsgi.input}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{,} \PYG{n}{environ}\PYG{o}{=}\PYG{n}{request}\PYG{o}{.}\PYG{n}{environ}\PYG{p}{)}
    \PYG{k}{return} \PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{jsonrpc}\PYG{o}{=}\PYG{l+s}{"}\PYG{l+s}{2.0}\PYG{l+s}{"}\PYG{p}{,} \PYG{n}{result}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{,} \PYG{n+nb}{id}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{)}

\PYG{k+kn}{import} \PYG{n+nn}{cgi}
\PYG{k}{class} \PYG{n+nc}{FieldStoragx}\PYG{p}{(}\PYG{n}{cgi}\PYG{o}{.}\PYG{n}{FieldStorage}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{fp}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{,} \PYG{n}{headers}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{,} \PYG{n}{outerboundary}\PYG{o}{=}\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{,}
                 \PYG{n}{environ}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{,} \PYG{n}{keep\PYGZus{}blank\PYGZus{}values}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{strict\PYGZus{}parsing}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{environ} \PYG{o}{=} \PYG{n}{environ}
        \PYG{n}{cgi}\PYG{o}{.}\PYG{n}{FieldStorage}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{fp}\PYG{p}{,} \PYG{n}{headers}\PYG{p}{,} \PYG{n}{outerboundary}\PYG{p}{,}
                                  \PYG{n}{environ}\PYG{p}{,} \PYG{n}{keep\PYGZus{}blank\PYGZus{}values}\PYG{p}{,} \PYG{n}{strict\PYGZus{}parsing}\PYG{p}{)}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{filename}\PYG{p}{:}
            \PYG{k}{return}
        \PYG{k}{assert} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{value}\PYG{p}{)} \PYG{o}{\textless{}} \PYG{l+m+mi}{1000}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{name} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{session}\PYG{l+s}{'}\PYG{p}{:}
            \PYG{n}{environ}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{rnaseqlyse.upload\PYGZus{}session}\PYG{l+s}{'}\PYG{p}{]} \PYG{o}{=} \PYGZbs{}
                   \PYG{n}{DBSession}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{UploadSession}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n+nb}{int}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{value}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{elif} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{name} \PYG{o+ow}{in} \PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{name}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{type}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{environ}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{rnaseqlyse.upload\PYGZus{}}\PYG{l+s}{'} \PYG{o}{+} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{name}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{value}
        \PYG{k}{else}\PYG{p}{:}
            \PYG{k}{return}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{FieldStoragx(}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ -\textgreater{} }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{)}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{name}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{value}\PYG{p}{)}\PYG{p}{)}

    \PYG{k}{def} \PYG{n+nf}{make\PYGZus{}file}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{binary}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{)}\PYG{p}{:}

        \PYG{k}{assert} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{filename}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{FieldStoragx.make\PYGZus{}file(}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{)}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{filename}\PYG{p}{)}

        \PYG{n}{args} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
        \PYG{k}{for} \PYG{n}{kw} \PYG{o+ow}{in} \PYG{l+s}{'}\PYG{l+s}{session}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{name}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{type}\PYG{l+s}{'}\PYG{p}{:}
            \PYG{n}{args}\PYG{p}{[}\PYG{n}{kw}\PYG{p}{]} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{environ}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{rnaseqlyse.upload\PYGZus{}}\PYG{l+s}{'} \PYG{o}{+} \PYG{n}{kw}\PYG{p}{]}

        \PYG{n}{fd} \PYG{o}{=} \PYG{n}{service}\PYG{o}{.}\PYG{n}{get\PYGZus{}uploadfile}\PYG{p}{(}\PYG{n}{DBSession}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{args}\PYG{p}{)}
        \PYG{c}{\PYGZsh{} commit the (managed) session early here, so later}
        \PYG{c}{\PYGZsh{} requests can re-use the Analysis object that the}
        \PYG{c}{\PYGZsh{} first one has implicitly created by calling}
        \PYG{c}{\PYGZsh{} service.get\PYGZus{}uploadfile}
        \PYG{k+kn}{import} \PYG{n+nn}{transaction}
        \PYG{n}{transaction}\PYG{o}{.}\PYG{n}{commit}\PYG{p}{(}\PYG{p}{)}

        \PYG{k}{return} \PYG{n}{fd}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.web.views}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-web-views}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{Pyramid Application User Views}
\PYG{l+s+sd}{"""}

\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{import} \PYG{n+nn}{re}
\PYG{k+kn}{from} \PYG{n+nn}{os.path} \PYG{k+kn}{import} \PYG{n}{join}

\PYG{k+kn}{from} \PYG{n+nn}{pyramid.view} \PYG{k+kn}{import} \PYG{n}{view\PYGZus{}config}
\PYG{k+kn}{from} \PYG{n+nn}{pyramid.response} \PYG{k+kn}{import} \PYG{n}{FileResponse}
\PYG{k+kn}{from} \PYG{n+nn}{pyramid.httpexceptions} \PYG{k+kn}{import} \PYG{n}{HTTPFound}

\PYG{k+kn}{import} \PYG{n+nn}{transaction}
\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy.exc} \PYG{k+kn}{import} \PYG{n}{DBAPIError}

\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze} \PYG{k+kn}{import} \PYG{n}{galaxy}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.web} \PYG{k+kn}{import} \PYG{n}{DBSession}\PYG{p}{,} \PYG{n}{DBSession\PYGZus{}unmanaged}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core} \PYG{k+kn}{import} \PYG{n}{service}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core.entities} \PYG{k+kn}{import} \PYG{n}{Analysis}\PYG{p}{,} \PYG{n}{UCSCOrganism}

\PYG{n}{autocomplete\PYGZus{}re} \PYG{o}{=} \PYG{n}{re}\PYG{o}{.}\PYG{n}{compile}\PYG{p}{(}\PYG{l+s}{r"}\PYG{l+s}{\PYGZca{}[\PYGZca{}(]+}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{([\PYGZca{}/]+/([\PYGZca{})]+)}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{).*\PYGZdl{}}\PYG{l+s}{"}\PYG{p}{)}

\PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{route\PYGZus{}name}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{home}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{renderer}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{templates/home.pt}\PYG{l+s}{'}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{home}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    **Home Page**}

\PYG{l+s+sd}{    This is the main entry point to the application. I.e. the landing page,}
\PYG{l+s+sd}{    the page that users see first.}
\PYG{l+s+sd}{    """}
    \PYG{k}{return} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}

\PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{route\PYGZus{}name}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{analyses}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{renderer}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{templates/create.pt}\PYG{l+s}{'}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{create}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    **Create Page**}

\PYG{l+s+sd}{    This page is shown when the "New Analysis" button is clicked.}
\PYG{l+s+sd}{    """}
    \PYG{n}{sess} \PYG{o}{=} \PYG{n}{service}\PYG{o}{.}\PYG{n}{get\PYGZus{}upload\PYGZus{}session}\PYG{p}{(}\PYG{n}{DBSession}\PYG{p}{)}
    \PYG{k}{return} \PYG{p}{\PYGZob{}} \PYG{l+s}{'}\PYG{l+s}{upload\PYGZus{}session}\PYG{l+s}{'}\PYG{p}{:} \PYG{n}{sess}\PYG{o}{.}\PYG{n}{id} \PYG{p}{\PYGZcb{}}

\PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{route\PYGZus{}name}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{analysis}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{renderer}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{templates/analysis.pt}\PYG{l+s}{'}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{display}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    **Analysis Page**}

\PYG{l+s+sd}{    This page is displayed after the the anaysis has been created.}
\PYG{l+s+sd}{    When the user clicks "Submit" on the 'create' page, after}
\PYG{l+s+sd}{    the files are uploaded and the form information is submitted}
\PYG{l+s+sd}{    to the :func:{}`\PYGZti{}post{}` view, the browser is redirected here.}

\PYG{l+s+sd}{    The page can also be viewed any time later on, no matter}
\PYG{l+s+sd}{    weather the analysis has already been completed or not.}

\PYG{l+s+sd}{    In case it is not yet completed, the page is constantly}
\PYG{l+s+sd}{    updated via XMLHTTPRequests to reflect the current status.}
\PYG{l+s+sd}{    """}
    
    \PYG{n+nb}{id} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{request}\PYG{o}{.}\PYG{n}{matchdict}\PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{id}\PYG{l+s}{"}\PYG{p}{]}\PYG{p}{)}
    \PYG{k}{return} \PYG{p}{\PYGZob{}}
        \PYG{l+s}{'}\PYG{l+s}{analysis}\PYG{l+s}{'}\PYG{p}{:} \PYG{n}{DBSession}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{Analysis}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n+nb}{id}\PYG{p}{)}\PYG{p}{,}
        \PYG{l+s}{'}\PYG{l+s}{galaxy\PYGZus{}history\PYGZus{}url}\PYG{l+s}{'}\PYG{p}{:} \PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{default\PYGZus{}history\PYGZus{}url}\PYG{p}{,}
    \PYG{p}{\PYGZcb{}}

\PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{route\PYGZus{}name}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{analysis\PYGZus{}files}\PYG{l+s}{'}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{analysis\PYGZus{}files}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    **Files View**}

\PYG{l+s+sd}{    This view serves up the files associated with}
\PYG{l+s+sd}{    an analysis on 'http://\textless{}rnaseqlyze\textgreater{}/analysis/\PYGZob{}id\PYGZcb{}/files'.}
\PYG{l+s+sd}{    """}
    \PYG{k}{return} \PYG{n}{FileResponse}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{analyses\PYGZus{}path}\PYG{p}{,}
                \PYG{n}{request}\PYG{o}{.}\PYG{n}{matchdict}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{id}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{,} \PYG{o}{*}\PYG{n}{request}\PYG{o}{.}\PYG{n}{subpath}\PYG{p}{)}\PYG{p}{)}

\PYG{k+kn}{import} \PYG{n+nn}{mimetypes}
\PYG{c}{\PYGZsh{}mimetypes.add\PYGZus{}type("text/plain", ".")}
\PYG{c}{\PYGZsh{}mimetypes.add\PYGZus{}type("text/plain", ".")}
\PYG{c}{\PYGZsh{}mimetypes.add\PYGZus{}type("text/plain", ".")}
\PYG{c}{\PYGZsh{}mimetypes.add\PYGZus{}type("text/plain", ".")}
\PYG{n}{mimetypes}\PYG{o}{.}\PYG{n}{add\PYGZus{}type}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{text/plain}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{.gb}\PYG{l+s}{"}\PYG{p}{)}
\PYG{n}{mimetypes}\PYG{o}{.}\PYG{n}{add\PYGZus{}type}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{text/plain}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{.log}\PYG{l+s}{"}\PYG{p}{)}
\PYG{n}{mimetypes}\PYG{o}{.}\PYG{n}{add\PYGZus{}type}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{text/plain}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{.log0}\PYG{l+s}{"}\PYG{p}{)}
\PYG{n}{mimetypes}\PYG{o}{.}\PYG{n}{add\PYGZus{}type}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{text/plain}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{.info}\PYG{l+s}{"}\PYG{p}{)}
\PYG{c}{\PYGZsh{} FileResponse automatically sets the Content-Type header based on this}

\PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{route\PYGZus{}name}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{analyses}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{request\PYGZus{}method}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{POST}\PYG{l+s}{'}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{post}\PYG{p}{(}\PYG{n}{request}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    **Create-Form Action**}

\PYG{l+s+sd}{    This view just redirects the client to the created analysis page.}
\PYG{l+s+sd}{    Before it is actually called, the files to be analyzed, are uploaded}
\PYG{l+s+sd}{    using the :func:{}`\PYGZti{}.upload.upload{}` view callable.}
\PYG{l+s+sd}{    """}
    \PYG{c}{\PYGZsh{} for documentation on the documentation reference syntax, see}
    \PYG{c}{\PYGZsh{} http://sphinx.pocoo.org/domains.html\PYGZsh{}cross-referencing-python-objects}

    \PYG{c}{\PYGZsh{} TODO: csrf security checks}
    \PYG{c}{\PYGZsh{}       see "shootout" pyramid demo app}

    \PYG{c}{\PYGZsh{} note:}
    \PYG{c}{\PYGZsh{}  when using the "DBSession" (managed), the}
    \PYG{c}{\PYGZsh{}  try:/except: rollback construct is not needed}
    \PYG{c}{\PYGZsh{}  because the session is automatically rolled back}
    \PYG{c}{\PYGZsh{}  otoh, if the \PYGZus{}unmanaged session is used, it \PYGZus{}has\PYGZus{} to}
    \PYG{c}{\PYGZsh{}  be manually commited or rolled back if objects are modified}

    \PYG{k}{if} \PYG{l+s}{'}\PYG{l+s}{org\PYGZus{}accession}\PYG{l+s}{'} \PYG{o+ow}{in} \PYG{n}{request}\PYG{o}{.}\PYG{n}{POST}\PYG{p}{:}
        \PYG{n}{request}\PYG{o}{.}\PYG{n}{POST}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{org\PYGZus{}accession}\PYG{l+s}{'}\PYG{p}{]} \PYG{o}{=} \PYGZbs{}
                \PYG{n}{autocomplete\PYGZus{}re}\PYG{o}{.}\PYG{n}{sub}\PYG{p}{(}\PYG{l+s}{r"}\PYG{l+s}{\PYGZbs{}}\PYG{l+s}{1}\PYG{l+s}{"}\PYG{p}{,} \PYG{n}{request}\PYG{o}{.}\PYG{n}{POST}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{org\PYGZus{}accession}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{)}
    \PYG{k}{try}\PYG{p}{:}
        \PYG{n}{analysis} \PYG{o}{=} \PYG{n}{service}\PYG{o}{.}\PYG{n}{get\PYGZus{}analysis}\PYG{p}{(}
                    \PYG{n}{DBSession\PYGZus{}unmanaged}\PYG{p}{,} \PYG{n}{attributes}\PYG{o}{=}\PYG{n}{request}\PYG{o}{.}\PYG{n}{POST}\PYG{p}{)}

        \PYG{c}{\PYGZsh{} the analysis must exist in the database}
        \PYG{c}{\PYGZsh{} so the worker can find it and start working}
        \PYG{n}{DBSession\PYGZus{}unmanaged}\PYG{o}{.}\PYG{n}{commit}\PYG{p}{(}\PYG{p}{)}

        \PYG{n}{service}\PYG{o}{.}\PYG{n}{start\PYGZus{}analysis}\PYG{p}{(}\PYG{n}{analysis}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{started analysis \PYGZsh{}}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{ by }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}
                            \PYG{n}{analysis}\PYG{o}{.}\PYG{n}{id}\PYG{p}{,} \PYG{n}{analysis}\PYG{o}{.}\PYG{n}{owner}\PYG{o}{.}\PYG{n}{name}\PYG{p}{)}\PYG{p}{)}

        \PYG{k}{return} \PYG{n}{HTTPFound}\PYG{p}{(}\PYG{n}{request}\PYG{o}{.}\PYG{n}{route\PYGZus{}path}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{analysis}\PYG{l+s}{'}\PYG{p}{,} \PYG{n+nb}{id}\PYG{o}{=}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}\PYG{p}{)}
    \PYG{k}{except}\PYG{p}{:}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{abort}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{n}{DBSession\PYGZus{}unmanaged}\PYG{o}{.}\PYG{n}{rollback}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{rollback complete}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{k}{raise}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.web.wsgi}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-web-wsgi}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{RNA-Seqlyze WSGI Apllication}

\PYG{l+s+sd}{Provides the get\PYGZus{}app(workdir) function,}
\PYG{l+s+sd}{which returns a wsgi application callable.}
\PYG{l+s+sd}{"""}

\PYG{k}{def} \PYG{n+nf}{get\PYGZus{}app}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Basically returns wrapper around paster.get\PYGZus{}app}
\PYG{l+s+sd}{    that strips the ".wsgi" extension from SCRIPT\PYGZus{}NAME}
\PYG{l+s+sd}{    """}

    \PYG{c}{\PYGZsh{} configure the core package}
    \PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}
    \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{configure}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} default configuraion file name}
    \PYG{k+kn}{import} \PYG{n+nn}{os.path}
    \PYG{n}{web\PYGZus{}ini} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{web.ini}\PYG{l+s}{'}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} configure logging}
    \PYG{k+kn}{import} \PYG{n+nn}{logging.config}
    \PYG{n}{logging}\PYG{o}{.}\PYG{n}{config}\PYG{o}{.}\PYG{n}{fileConfig}\PYG{p}{(}\PYG{n}{web\PYGZus{}ini}\PYG{p}{,} \PYG{n+nb}{dict}\PYG{p}{(}\PYG{n}{here}\PYG{o}{=}\PYG{n}{workdir}\PYG{p}{)}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} create the pyramid wsgi app}
    \PYG{k+kn}{import} \PYG{n+nn}{pyramid.paster}
    \PYG{n}{pyramid\PYGZus{}app} \PYG{o}{=} \PYG{n}{pyramid}\PYG{o}{.}\PYG{n}{paster}\PYG{o}{.}\PYG{n}{get\PYGZus{}app}\PYG{p}{(}\PYG{n}{web\PYGZus{}ini}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{main}\PYG{l+s}{'}\PYG{p}{)}

    \PYG{c}{\PYGZsh{} return a wrapper that adjusts SCRIPT\PYGZus{}NAME}
    \PYG{k}{def} \PYG{n+nf}{app}\PYG{p}{(}\PYG{n}{environ}\PYG{p}{,} \PYG{n}{start\PYGZus{}request}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{environ}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{SCRIPT\PYGZus{}NAME}\PYG{l+s}{'}\PYG{p}{]} \PYG{o}{=} \PYGZbs{}
                \PYG{n}{environ}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{SCRIPT\PYGZus{}NAME}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{[}\PYG{p}{:}\PYG{o}{-}\PYG{l+m+mi}{5}\PYG{p}{]}
        \PYG{k}{return} \PYG{n}{pyramid\PYGZus{}app}\PYG{p}{(}\PYG{n}{environ}\PYG{p}{,} \PYG{n}{start\PYGZus{}request}\PYG{p}{)}

    \PYG{k}{return} \PYG{n}{app}
\end{Verbatim}


\subsubsection{Package \texttt{rnaseqlyze.worker}}
\label{rnaseqlyze-pdf:package-rnaseqlyze-worker}

\paragraph{Modul \texttt{rnaseqlyze.worker}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-worker}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{**pyramid.worker** is a Pyramid Web Framework Application.}

\PYG{l+s+sd}{The framework is used here to keep things simple. Even thought not many of the}
\PYG{l+s+sd}{frameworks features are used, building this "-worker" part of the project as a}
\PYG{l+s+sd}{Pyramid Web Framework Application, just like the "-web" part, hopefullly makes}
\PYG{l+s+sd}{it easy to understand for anybody already understanding the "-web" part.}

\PYG{l+s+sd}{The key features from then Pyramid Web Framework used here, are}

\PYG{l+s+sd}{ 1) The "pserve" command, which makes running the application as a unix daemon}
\PYG{l+s+sd}{    process very simple. It's direct use has actually been depreciated during}
\PYG{l+s+sd}{    the development and a custom command, "rnas-worker", has been created,}
\PYG{l+s+sd}{    which uses the same python functions and modules like "pserve".}

\PYG{l+s+sd}{ 2) The pyramid.config.Configurator class, that is used to define the}
\PYG{l+s+sd}{    applications "routes" and "view callables". These "views" provide the}
\PYG{l+s+sd}{    applications interface.  They are served on a tcp port bound to localhost}
\PYG{l+s+sd}{    (127.0.0.1) and are therefore only available to processes running on the}
\PYG{l+s+sd}{    same host.}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{The "-worker" applications interface has "HTTP-like" semantics.}

\PYG{l+s+sd}{The following commands are accepted:}

\PYG{l+s+sd}{ - {}`{}`GET /analyses/\PYGZob{}id\PYGZcb{}{}`{}`:      Show the current status.}
\PYG{l+s+sd}{ - {}`{}`START /analyses/\PYGZob{}id\PYGZcb{}{}`{}`:    Start processing an analysis.}

\PYG{l+s+sd}{Only for development purposes, one additional command exists:}

\PYG{l+s+sd}{ - {}`{}`RESTART /analyses/\PYGZob{}id\PYGZcb{}{}`{}`:  Restart an analysis}
\PYG{l+s+sd}{                                that has already been started.}

\PYG{l+s+sd}{The commands are executed by the "-web" part of the application by subclassing}
\PYG{l+s+sd}{HTTPRequest and coverriding the get\PYGZus{}method() function. They can also be executed}
\PYG{l+s+sd}{from the command line however, using the popular "curl" binary with the "-X"}
\PYG{l+s+sd}{option, e.g.}

\PYG{l+s+sd}{ - {}`{}`curl -X GET localhost:/analyses/3{}`{}`}
\PYG{l+s+sd}{ - {}`{}`curl -X START localhost:/analyses/3{}`{}`}
\PYG{l+s+sd}{ - {}`{}`curl -X RESTART localhost:/analyses/3{}`{}`}

\PYG{l+s+sd}{"""}

\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{from} \PYG{n+nn}{pyramid.view} \PYG{k+kn}{import} \PYG{n}{view\PYGZus{}config}
\PYG{k+kn}{from} \PYG{n+nn}{pyramid.view} \PYG{k+kn}{import} \PYG{n}{view\PYGZus{}defaults}
\PYG{k+kn}{from} \PYG{n+nn}{pyramid.config} \PYG{k+kn}{import} \PYG{n}{Configurator}
\PYG{k+kn}{from} \PYG{n+nn}{pyramid.response} \PYG{k+kn}{import} \PYG{n}{Response}
\PYG{k+kn}{from} \PYG{n+nn}{pyramid.httpexceptions} \PYG{k+kn}{import} \PYG{p}{(}
        \PYG{n}{HTTPError}\PYG{p}{,}
        \PYG{n}{HTTPBadRequest}\PYG{p}{,}
        \PYG{n}{HTTPInternalServerError}\PYG{p}{,}
\PYG{p}{)}

\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy} \PYG{k+kn}{import} \PYG{n}{create\PYGZus{}engine}
\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy.orm} \PYG{k+kn}{import} \PYG{n}{sessionmaker}\PYG{p}{,} \PYG{n}{scoped\PYGZus{}session}
\PYG{k+kn}{from} \PYG{n+nn}{zope.sqlalchemy} \PYG{k+kn}{import} \PYG{n}{ZopeTransactionExtension}

\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}
\PYG{n}{project\PYGZus{}name} \PYG{o}{=} \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{project\PYGZus{}name} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{-worker}\PYG{l+s}{"}

\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core.entities} \PYG{k+kn}{import} \PYG{n}{Analysis}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.worker.core} \PYG{k+kn}{import} \PYG{p}{(}
        \PYG{n}{Manager}\PYG{p}{,}
        \PYG{n}{ManagerBusyException}\PYG{p}{,}
        \PYG{n}{AnalysisAlreadyStartedException}\PYG{p}{,}
\PYG{p}{)}

\PYG{n}{DBSession} \PYG{o}{=} \PYG{n}{scoped\PYGZus{}session}\PYG{p}{(}\PYG{n}{sessionmaker}\PYG{p}{(}\PYG{n}{extension}\PYG{o}{=}\PYG{n}{ZopeTransactionExtension}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

\PYG{k}{def} \PYG{n+nf}{main}\PYG{p}{(}\PYG{n}{global\PYGZus{}config}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{settings}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Return a Pyramid(!) WSGI application.}
\PYG{l+s+sd}{    """}

    \PYG{c}{\PYGZsh{} make sure to be able to delete files created by webapp}
    \PYG{c}{\PYGZsh{} as user/group www-data/www-data from the command line}
    \PYG{c}{\PYGZsh{} (as user/group johndoe/www-data)}
    \PYG{k+kn}{import} \PYG{n+nn}{os}
    \PYG{n}{os}\PYG{o}{.}\PYG{n}{umask}\PYG{p}{(}\PYG{l+m+mo}{0002}\PYG{p}{)}

    \PYG{n}{engine} \PYG{o}{=} \PYG{n}{create\PYGZus{}engine}\PYG{p}{(}\PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{db\PYGZus{}url}\PYG{p}{)}
    \PYG{n}{DBSession}\PYG{o}{.}\PYG{n}{configure}\PYG{p}{(}\PYG{n}{bind}\PYG{o}{=}\PYG{n}{engine}\PYG{p}{)}

    \PYG{n}{Waitress}\PYG{o}{.}\PYG{n}{manager} \PYG{o}{=} \PYG{n}{Manager}\PYG{p}{(}\PYG{p}{)}

    \PYG{n}{config} \PYG{o}{=} \PYG{n}{Configurator}\PYG{p}{(}\PYG{n}{settings}\PYG{o}{=}\PYG{n}{settings}\PYG{p}{)}
    \PYG{n}{config}\PYG{o}{.}\PYG{n}{add\PYGZus{}route}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{analyses}\PYG{l+s}{'}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{/analyses/\PYGZob{}id\PYGZcb{}}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{n}{config}\PYG{o}{.}\PYG{n}{scan}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{config}\PYG{o}{.}\PYG{n}{make\PYGZus{}wsgi\PYGZus{}app}\PYG{p}{(}\PYG{p}{)}


\PYG{n+nd}{@view\PYGZus{}defaults}\PYG{p}{(}\PYG{n}{route\PYGZus{}name}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{analyses}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{renderer}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{string}\PYG{l+s}{'}\PYG{p}{)}
\PYG{k}{class} \PYG{n+nc}{Waitress}\PYG{p}{(}\PYG{n+nb}{object}\PYG{p}{)}\PYG{p}{:}

    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{request}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb}{id} \PYG{o}{=} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{request}\PYG{o}{.}\PYG{n}{matchdict}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{id}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis} \PYG{o}{=} \PYG{n}{DBSession}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{Analysis}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n+nb}{id}\PYG{p}{)}

    \PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{request\PYGZus{}method}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{GET}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{k}{def} \PYG{n+nf}{status}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k+kn}{import} \PYG{n+nn}{pprint}
        \PYG{k}{return} \PYG{n}{pprint}\PYG{o}{.}\PYG{n}{pformat}\PYG{p}{(}\PYG{p}{\PYGZob{}}
            \PYG{l+s}{'}\PYG{l+s}{context}\PYG{l+s}{'}\PYG{p}{:} \PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{c}{\PYGZsh{} Waitress}
            \PYG{l+s}{'}\PYG{l+s}{manager}\PYG{l+s}{'}\PYG{p}{:} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{manager}\PYG{p}{,} \PYG{c}{\PYGZsh{} Manager}
            \PYG{l+s}{'}\PYG{l+s}{analysis}\PYG{l+s}{'}\PYG{p}{:} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{p}{,} \PYG{c}{\PYGZsh{} Analysis}
        \PYG{p}{\PYGZcb{}}\PYG{p}{)}

    \PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{request\PYGZus{}method}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{START}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{k}{def} \PYG{n+nf}{start}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{manager}\PYG{o}{.}\PYG{n}{analysis\PYGZus{}requested}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{p}{)}
        \PYG{k}{return} \PYG{l+s}{"}\PYG{l+s}{started analysis \PYGZsh{}}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{id}

    \PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{request\PYGZus{}method}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{RESTART}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{k}{def} \PYG{n+nf}{restart}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{manager}\PYG{o}{.}\PYG{n}{analysis\PYGZus{}requested}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{p}{,} \PYG{n+nb+bp}{True}\PYG{p}{)}
        \PYG{k}{return} \PYG{l+s}{"}\PYG{l+s}{restarted analysis \PYGZsh{}}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{id}


\PYG{n+nd}{@view\PYGZus{}config}\PYG{p}{(}\PYG{n}{context}\PYG{o}{=}\PYG{n+ne}{Exception}\PYG{p}{)}
\PYG{k}{def} \PYG{n+nf}{error\PYGZus{}view}\PYG{p}{(}\PYG{n}{error}\PYG{p}{,} \PYG{n}{request}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{errdict} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{n}{AnalysisAlreadyStartedException}\PYG{p}{:}    \PYG{n}{HTTPBadRequest}\PYG{p}{,}
        \PYG{n}{ManagerBusyException}\PYG{p}{:}               \PYG{n}{HTTPInternalServerError}\PYG{p}{,}
    \PYG{p}{\PYGZcb{}}
    \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{error}\PYG{p}{,} \PYG{n}{HTTPError}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{error}
    \PYG{k}{elif} \PYG{n+nb}{type}\PYG{p}{(}\PYG{n}{error}\PYG{p}{)} \PYG{o+ow}{in} \PYG{n}{errdict}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{errdict}\PYG{p}{[}\PYG{n+nb}{type}\PYG{p}{(}\PYG{n}{error}\PYG{p}{)}\PYG{p}{]}\PYG{p}{(}\PYG{n}{error}\PYG{p}{)}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{k}{return} \PYG{n}{HTTPInternalServerError}\PYG{p}{(}\PYG{n}{error}\PYG{p}{)}


\PYG{c}{\PYGZsh{} monkey-patch some HTTPException classes to get simpler error messages}

\PYG{k+kn}{from} \PYG{n+nn}{pyramid.response} \PYG{k+kn}{import} \PYG{n}{Response}
\PYG{k}{def} \PYG{n+nf}{\PYGZus{}WHE\PYGZus{}init}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{arg}\PYG{o}{=}\PYG{n+nb+bp}{None}\PYG{p}{)}\PYG{p}{:}
    \PYG{n+ne}{Exception}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{arg}\PYG{p}{)}
    \PYG{k}{if} \PYG{n+nb}{isinstance}\PYG{p}{(}\PYG{n}{arg}\PYG{p}{,} \PYG{n+ne}{Exception}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n+nb+bp}{False}\PYG{p}{:} \PYG{c}{\PYGZsh{} production}
            \PYG{n}{e}\PYG{p}{,} \PYG{n}{t} \PYG{o}{=} \PYG{n}{arg}\PYG{p}{,} \PYG{n+nb}{type}\PYG{p}{(}\PYG{n}{arg}\PYG{p}{)}
            \PYG{n}{arg} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n}{t}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{,} \PYG{n}{e}\PYG{o}{.}\PYG{n}{args}\PYG{p}{)}
        \PYG{k}{else}\PYG{p}{:} \PYG{c}{\PYGZsh{} debug}
            \PYG{k+kn}{import} \PYG{n+nn}{traceback}
            \PYG{n}{arg} \PYG{o}{=} \PYG{n}{traceback}\PYG{o}{.}\PYG{n}{format\PYGZus{}exc}\PYG{p}{(}\PYG{l+m+mi}{999}\PYG{p}{)}
    \PYG{n}{Response}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,}
        \PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{code}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{title}\PYG{p}{,} \PYG{n}{arg}\PYG{p}{)}\PYG{p}{,}
        \PYG{n}{content\PYGZus{}type}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{text/plain}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{status}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{code}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{title}\PYG{p}{)}\PYG{p}{)}

\PYG{k+kn}{from} \PYG{n+nn}{pyramid.httpexceptions} \PYG{k+kn}{import} \PYG{n}{WSGIHTTPException}
\PYG{n}{WSGIHTTPException}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}} \PYG{o}{=} \PYG{n}{\PYGZus{}WHE\PYGZus{}init}
\PYG{k}{del} \PYG{n}{WSGIHTTPException}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}call\PYGZus{}\PYGZus{}}
\PYG{k}{del} \PYG{n}{WSGIHTTPException}\PYG{o}{.}\PYG{n}{prepare}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.worker.core}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-worker-core}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{RNA-Seqlyze Worker Daemon Core}

\PYG{l+s+sd}{Worker parent class with basic infrastructure to run the}
\PYG{l+s+sd}{various analysis steps defined in :class:{}`\PYGZti{}.WorkerStages{}`.}
\PYG{l+s+sd}{"""}

\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}
\PYG{n}{root\PYGZus{}logger} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{p}{)}

\PYG{k+kn}{from} \PYG{n+nn}{threading} \PYG{k+kn}{import} \PYG{n}{Thread}
\PYG{k+kn}{from} \PYG{n+nn}{logging} \PYG{k+kn}{import} \PYG{n}{Formatter}
\PYG{k+kn}{from} \PYG{n+nn}{logging} \PYG{k+kn}{import} \PYG{n}{StreamHandler}
\PYG{k+kn}{from} \PYG{n+nn}{StringIO} \PYG{k+kn}{import} \PYG{n}{StringIO}
\PYG{k+kn}{from} \PYG{n+nn}{contextlib} \PYG{k+kn}{import} \PYG{n}{contextmanager}

\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy} \PYG{k+kn}{import} \PYG{n}{create\PYGZus{}engine}
\PYG{k+kn}{from} \PYG{n+nn}{sqlalchemy.orm} \PYG{k+kn}{import} \PYG{n}{sessionmaker}

\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze} \PYG{k+kn}{import} \PYG{n}{efetch}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core.entities} \PYG{k+kn}{import} \PYG{n}{Analysis}\PYG{p}{,} \PYG{n}{StageLog}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.worker.stages} \PYG{k+kn}{import} \PYG{n}{WorkerStages}

\PYG{n}{DBSession} \PYG{o}{=} \PYG{n}{sessionmaker}\PYG{p}{(}\PYG{p}{)}

\PYG{n}{log\PYGZus{}format} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}(levelname)-5.5s}\PYG{l+s}{ [}\PYG{l+s+si}{\PYGZpc{}(name)s}\PYG{l+s}{] }\PYG{l+s+si}{\PYGZpc{}(message)s}\PYG{l+s}{"}

\PYG{k}{class} \PYG{n+nc}{Manager}\PYG{p}{(}\PYG{n+nb}{object}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{worker} \PYG{o}{=} \PYG{n}{Thread}\PYG{p}{(}\PYG{p}{)}

    \PYG{k}{def} \PYG{n+nf}{analysis\PYGZus{}requested}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{analysis}\PYG{p}{,} \PYG{n}{re}\PYG{o}{=}\PYG{n+nb+bp}{False}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{analysis}\PYG{o}{.}\PYG{n}{started} \PYG{o+ow}{and} \PYG{o+ow}{not} \PYG{n}{re}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n}{AnalysisAlreadyStartedException}
        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{worker}\PYG{o}{.}\PYG{n}{is\PYGZus{}alive}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n}{ManagerBusyException}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{worker} \PYG{o}{=} \PYG{n}{Worker}\PYG{p}{(}\PYG{n}{analysis}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{worker}\PYG{o}{.}\PYG{n}{start}\PYG{p}{(}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{StageLogStream}\PYG{p}{(}\PYG{n+nb}{object}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{analysis}\PYG{p}{,} \PYG{n}{stage}\PYG{p}{,} \PYG{n}{session}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{stage\PYGZus{}log} \PYG{o}{=} \PYG{n}{StageLog}\PYG{p}{(}\PYG{n}{analysis}\PYG{o}{=}\PYG{n}{analysis}\PYG{p}{,} \PYG{n}{stage}\PYG{o}{=}\PYG{n}{stage}\PYG{p}{,} \PYG{n}{text}\PYG{o}{=}\PYG{l+s}{"}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{session} \PYG{o}{=} \PYG{n}{session}
        \PYG{n}{session}\PYG{o}{.}\PYG{n}{add}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{stage\PYGZus{}log}\PYG{p}{)}
        \PYG{n}{session}\PYG{o}{.}\PYG{n}{commit}\PYG{p}{(}\PYG{p}{)}
    \PYG{k}{def} \PYG{n+nf}{write}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{data}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{stage\PYGZus{}log}\PYG{o}{.}\PYG{n}{text} \PYG{o}{+}\PYG{o}{=} \PYG{n}{data}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{session}\PYG{o}{.}\PYG{n}{commit}\PYG{p}{(}\PYG{p}{)}

\PYG{k}{class} \PYG{n+nc}{AnalysisAlreadyStartedException}\PYG{p}{(}\PYG{n+ne}{Exception}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{pass}

\PYG{k}{class} \PYG{n+nc}{ManagerBusyException}\PYG{p}{(}\PYG{n+ne}{Exception}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{pass}

\PYG{k}{class} \PYG{n+nc}{Worker}\PYG{p}{(}\PYG{n}{Thread}\PYG{p}{,} \PYG{n}{WorkerStages}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    The Worker}
\PYG{l+s+sd}{    """}

    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{analysis}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{Thread}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis\PYGZus{}id} \PYG{o}{=} \PYG{n}{analysis}\PYG{o}{.}\PYG{n}{id}

    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}thread\PYGZus{}init}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k+kn}{from} \PYG{n+nn}{os} \PYG{k+kn}{import} \PYG{n}{path}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{session} \PYG{o}{=} \PYG{n}{DBSession}\PYG{p}{(}\PYG{n}{bind}\PYG{o}{=}\PYG{n}{create\PYGZus{}engine}\PYG{p}{(}\PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{db\PYGZus{}url}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{session}\PYG{o}{.}\PYG{n}{query}\PYG{p}{(}\PYG{n}{Analysis}\PYG{p}{)}\PYG{o}{.}\PYG{n}{get}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis\PYGZus{}id}\PYG{p}{)}

        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{logfile} \PYG{o}{=} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{path}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{rna-seqlyze-worker.log}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{log\PYGZus{}handler} \PYG{o}{=} \PYG{n}{StreamHandler}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{logfile}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{log\PYGZus{}handler}\PYG{o}{.}\PYG{n}{setFormatter}\PYG{p}{(}\PYG{n}{Formatter}\PYG{p}{(}\PYG{n}{log\PYGZus{}format}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{root\PYGZus{}logger}\PYG{o}{.}\PYG{n}{addHandler}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{log\PYGZus{}handler}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{starting work on analysis \PYGZsh{}}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis\PYGZus{}id}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{finished} \PYG{o}{=} \PYG{n+nb+bp}{False}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{started} \PYG{o}{=} \PYG{n+nb+bp}{True}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{error} \PYG{o}{=} \PYG{n+nb+bp}{None}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{session}\PYG{o}{.}\PYG{n}{commit}\PYG{p}{(}\PYG{p}{)}

    \PYG{n+nd}{@contextmanager}
    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}stage\PYGZus{}log\PYGZus{}manager}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{n}{stage}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{handler} \PYG{o}{=} \PYG{n}{StreamHandler}\PYG{p}{(}
                    \PYG{n}{StageLogStream}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{p}{,} \PYG{n}{stage}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{session}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{root\PYGZus{}logger}\PYG{o}{.}\PYG{n}{addHandler}\PYG{p}{(}\PYG{n}{handler}\PYG{p}{)}
        \PYG{k}{yield}
        \PYG{n}{root\PYGZus{}logger}\PYG{o}{.}\PYG{n}{removeHandler}\PYG{p}{(}\PYG{n}{handler}\PYG{p}{)}

    \PYG{k}{def} \PYG{n+nf}{run}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}

        \PYG{c}{\PYGZsh{} TODO: invent a way to avoid calling stages that won't do anything}
        \PYG{c}{\PYGZsh{}       maybe @stages -\textgreater{} @stages(condition) something ...}

        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}thread\PYGZus{}init}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{try}\PYG{p}{:}
            \PYG{k}{for} \PYG{n}{stage} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{stages}\PYG{p}{:}
                \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{stage}\PYG{o}{.}\PYG{n}{should\PYGZus{}run}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
                    \PYG{k}{continue}
                \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{=== }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ ===}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{stage}\PYG{o}{.}\PYG{n}{func\PYGZus{}name}\PYG{p}{)}
                \PYG{k}{with} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}stage\PYGZus{}log\PYGZus{}manager}\PYG{p}{(}\PYG{n}{stage}\PYG{o}{.}\PYG{n}{func\PYGZus{}name}\PYG{p}{)}\PYG{p}{:}
                    \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{stage} \PYG{o}{=} \PYG{n}{stage}\PYG{o}{.}\PYG{n}{func\PYGZus{}name}
                    \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{session}\PYG{o}{.}\PYG{n}{commit}\PYG{p}{(}\PYG{p}{)}
                    \PYG{n}{stage}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}
        \PYG{k}{except} \PYG{n+ne}{Exception}\PYG{p}{,} \PYG{n}{e}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{error} \PYG{o}{=} \PYG{n+nb}{repr}\PYG{p}{(}\PYG{n}{e}\PYG{p}{)}
            \PYG{k}{raise}
        \PYG{k}{finally}\PYG{p}{:}
            \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{error}\PYG{p}{:}
                \PYG{n}{log}\PYG{o}{.}\PYG{n}{error}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{error}\PYG{p}{)}
            \PYG{k}{else}\PYG{p}{:}
                \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{analysis finished}\PYG{l+s}{"}\PYG{p}{)}

            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{finished} \PYG{o}{=} \PYG{n+nb+bp}{True}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{session}\PYG{o}{.}\PYG{n}{commit}\PYG{p}{(}\PYG{p}{)}
            \PYG{n}{root\PYGZus{}logger}\PYG{o}{.}\PYG{n}{removeHandler}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{log\PYGZus{}handler}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{logfile}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.worker.daemon}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-worker-daemon}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{RNA-Seqlyze Worker}

\PYG{l+s+sd}{Start, stop or restart the worker daemon}
\PYG{l+s+sd}{or run it in the foreground, in development mode.}

\PYG{l+s+sd}{Usage:}
\PYG{l+s+sd}{    rnas-worker \textless{}workdir\textgreater{} (start\textbar{}stop\textbar{}restart)}
\PYG{l+s+sd}{    rnas-worker \textless{}workdir\textgreater{} --development}
\PYG{l+s+sd}{    rnas-worker -h\textbar{}--help}

\PYG{l+s+sd}{Arguments:}

\PYG{l+s+sd}{    \textless{}workdir\textgreater{} The path to the workers 'workdir'.}
\PYG{l+s+sd}{              The 'workdir' is where the configuration, the}
\PYG{l+s+sd}{              application database and all analysis data are stored.}

\PYG{l+s+sd}{    start\textbar{}stop\textbar{}restart}

\PYG{l+s+sd}{              If one of those arguments is given, the daemon is}
\PYG{l+s+sd}{              run in the background. It will write it's PID to the}
\PYG{l+s+sd}{              file \textless{}workdir\textgreater{}/worker-daemon.pid and its output will be logged}
\PYG{l+s+sd}{              to \textless{}workdir\textgreater{}/worker-daemon.log. This is not the "log file"}
\PYG{l+s+sd}{              however. The "log file" path can be configured}
\PYG{l+s+sd}{              in \textless{}workdir\textgreater{}/worker.ini.}

\PYG{l+s+sd}{    --development}

\PYG{l+s+sd}{              If this argument is present, the worker daemon is run in}
\PYG{l+s+sd}{              development mode, which means that it will no fork to the}
\PYG{l+s+sd}{              background. If any source files (.py) are changed when the}
\PYG{l+s+sd}{              daemon is running in development mode, it will be}
\PYG{l+s+sd}{              automatically restarted.}

\PYG{l+s+sd}{"""}

\PYG{k+kn}{from} \PYG{n+nn}{os.path} \PYG{k+kn}{import} \PYG{n}{abspath}\PYG{p}{,} \PYG{n}{join}

\PYG{k+kn}{from} \PYG{n+nn}{paste.script} \PYG{k+kn}{import} \PYG{n}{serve}
\PYG{k+kn}{import} \PYG{n+nn}{docopt}

\PYG{k+kn}{import} \PYG{n+nn}{rnaseqlyze}

\PYG{k}{def} \PYG{n+nf}{main}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
    \PYG{n}{opts} \PYG{o}{=} \PYG{n}{docopt}\PYG{o}{.}\PYG{n}{docopt}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}doc\PYGZus{}\PYGZus{}}\PYG{p}{)}

    \PYG{k}{for} \PYG{n}{command} \PYG{o+ow}{in} \PYG{l+s}{"}\PYG{l+s}{start\textbar{}stop\textbar{}restart}\PYG{l+s}{"}\PYG{o}{.}\PYG{n}{split}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s}{\textbar{}}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{n}{opts}\PYG{p}{[}\PYG{n}{command}\PYG{p}{]}\PYG{p}{:}
            \PYG{n}{mode} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{production}\PYG{l+s}{"}
            \PYG{n}{args} \PYG{o}{=} \PYG{p}{[}\PYG{n}{command}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{--daemon}\PYG{l+s}{"}\PYG{p}{]}
            \PYG{k}{break}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{mode} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{development}\PYG{l+s}{"}
        \PYG{n}{args} \PYG{o}{=} \PYG{p}{[}\PYG{l+s}{"}\PYG{l+s}{--reload}\PYG{l+s}{"}\PYG{p}{]}

    \PYG{n}{workdir} \PYG{o}{=} \PYG{n}{abspath}\PYG{p}{(}\PYG{n}{opts}\PYG{p}{[}\PYG{l+s}{'}\PYG{l+s}{\textless{}workdir\textgreater{}}\PYG{l+s}{'}\PYG{p}{]}\PYG{p}{)}
    \PYG{n}{rnaseqlyze}\PYG{o}{.}\PYG{n}{configure}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{)}

    \PYG{k}{if} \PYG{n}{mode} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{production}\PYG{l+s}{'}\PYG{p}{:}
        \PYG{n}{args}\PYG{o}{.}\PYG{n}{extend}\PYG{p}{(}\PYG{p}{[}
\PYG{c}{\PYGZsh{}            "--user=" + rnaseqlyze.worker\PYGZus{}user,}
\PYG{c}{\PYGZsh{}            "--group=" + rnaseqlyze.group,}
            \PYG{l+s}{"}\PYG{l+s}{--log-file=}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{join}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{worker-daemon.log}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{,}
            \PYG{l+s}{"}\PYG{l+s}{--pid-file=}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{join}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{worker-daemon.pid}\PYG{l+s}{'}\PYG{p}{)}\PYG{p}{,}
        \PYG{p}{]}\PYG{p}{)}

    \PYG{n}{conf\PYGZus{}file} \PYG{o}{=} \PYG{n}{join}\PYG{p}{(}\PYG{n}{workdir}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s}{worker.ini}\PYG{l+s}{'}\PYG{p}{)}
    \PYG{n}{serve}\PYG{o}{.}\PYG{n}{ServeCommand}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{serve}\PYG{l+s}{"}\PYG{p}{)}\PYG{o}{.}\PYG{n}{run}\PYG{p}{(}\PYG{p}{[}\PYG{n}{conf\PYGZus{}file}\PYG{p}{]} \PYG{o}{+} \PYG{n}{args}\PYG{p}{)}
\end{Verbatim}


\paragraph{Modul \texttt{rnaseqlyze.worker.stages}}
\label{rnaseqlyze-pdf:modul-rnaseqlyze-worker-stages}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{l+s+sd}{"""}
\PYG{l+s+sd}{RNA-Seqlyze Worker Stages}

\PYG{l+s+sd}{    -- **this** is where things are actually getting done! :-)}
\PYG{l+s+sd}{"""}
\PYG{k+kn}{import} \PYG{n+nn}{logging}
\PYG{n}{log} \PYG{o}{=} \PYG{n}{logging}\PYG{o}{.}\PYG{n}{getLogger}\PYG{p}{(}\PYG{n}{\PYGZus{}\PYGZus{}name\PYGZus{}\PYGZus{}}\PYG{p}{)}

\PYG{k+kn}{import} \PYG{n+nn}{os}
\PYG{k+kn}{from} \PYG{n+nn}{os.path} \PYG{k+kn}{import} \PYG{n}{join}\PYG{p}{,} \PYG{n}{exists}\PYG{p}{,} \PYG{n}{isdir}\PYG{p}{,} \PYG{n}{relpath}
\PYG{k+kn}{from} \PYG{n+nn}{subprocess} \PYG{k+kn}{import} \PYG{n}{Popen}\PYG{p}{,} \PYG{n}{PIPE}
\PYG{k+kn}{from} \PYG{n+nn}{StringIO} \PYG{k+kn}{import} \PYG{n}{StringIO}
\PYG{k+kn}{from} \PYG{n+nn}{threading} \PYG{k+kn}{import} \PYG{n}{Thread}
\PYG{k+kn}{from} \PYG{n+nn}{urllib} \PYG{k+kn}{import} \PYG{n}{quote}

\PYG{k+kn}{import} \PYG{n+nn}{pysam}

\PYG{k+kn}{from} \PYG{n+nn}{Bio} \PYG{k+kn}{import} \PYG{n}{SeqIO}
\PYG{k+kn}{from} \PYG{n+nn}{Bio.SeqFeature} \PYG{k+kn}{import} \PYGZbs{}
        \PYG{n}{SeqFeature}\PYG{p}{,} \PYG{n}{FeatureLocation}\PYG{p}{,} \PYG{n}{ExactPosition}

\PYG{k+kn}{from} \PYG{n+nn}{psutil} \PYG{k+kn}{import} \PYG{n}{cpu\PYGZus{}percent}

\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze} \PYG{k+kn}{import} \PYG{n}{efetch}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze} \PYG{k+kn}{import} \PYG{n}{galaxy}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze} \PYG{k+kn}{import} \PYG{n}{ucscbrowser}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze} \PYG{k+kn}{import} \PYG{n}{transterm}\PYG{p}{,} \PYG{n}{gb2ptt}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.ucscbrowser} \PYG{k+kn}{import} \PYG{n}{BAMTrack}\PYG{p}{,} \PYG{n}{BigWigTrack}\PYG{p}{,} \PYG{n}{BigBedTrack}
\PYG{k+kn}{from} \PYG{n+nn}{rnaseqlyze.core.entities} \PYG{k+kn}{import} \PYG{n}{GalaxyDataset}


\PYG{k}{class} \PYG{n+nc}{Operon}\PYG{p}{(}\PYG{n+nb}{object}\PYG{p}{)}\PYG{p}{:}
    \PYG{k}{def} \PYG{n+nf}{\PYGZus{}\PYGZus{}init\PYGZus{}\PYGZus{}}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{o}{*}\PYG{o}{*}\PYG{n}{kwargs}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{\PYGZus{}\PYGZus{}dict\PYGZus{}\PYGZus{}}\PYG{o}{.}\PYG{n}{update}\PYG{p}{(}\PYG{n}{kwargs}\PYG{p}{)}

\PYG{n}{\PYGZus{}stages} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}
\PYG{n}{\PYGZus{}stage\PYGZus{}conds} \PYG{o}{=} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
\PYG{k}{def} \PYG{n+nf}{stage}\PYG{p}{(}\PYG{n}{method}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Just a small helper to collect the stages in the order defined.}

\PYG{l+s+sd}{    To add a new stage, simply add a method to :class:{}`\PYGZti{}WorkerStages{}`.}
\PYG{l+s+sd}{    It will be automatically executed for all new analyses.}
\PYG{l+s+sd}{    """}
    \PYG{k}{if} \PYG{n}{method}\PYG{o}{.}\PYG{n}{func\PYGZus{}name} \PYG{o+ow}{in} \PYG{n}{\PYGZus{}stage\PYGZus{}conds}\PYG{p}{:}
        \PYG{n}{method}\PYG{o}{.}\PYG{n}{should\PYGZus{}run} \PYG{o}{=} \PYG{n}{\PYGZus{}stage\PYGZus{}conds}\PYG{p}{[}\PYG{n}{method}\PYG{o}{.}\PYG{n}{func\PYGZus{}name}\PYG{p}{]}
        \PYG{k}{del} \PYG{n}{\PYGZus{}stage\PYGZus{}conds}\PYG{p}{[}\PYG{n}{method}\PYG{o}{.}\PYG{n}{func\PYGZus{}name}\PYG{p}{]}
    \PYG{k}{else}\PYG{p}{:}
        \PYG{n}{method}\PYG{o}{.}\PYG{n}{should\PYGZus{}run} \PYG{o}{=} \PYG{k}{lambda} \PYG{n+nb+bp}{self}\PYG{p}{:} \PYG{n+nb+bp}{True}
    \PYG{n}{\PYGZus{}stages}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{method}\PYG{p}{)}
    \PYG{k}{return} \PYG{n}{method}

\PYG{k}{def} \PYG{n+nf}{stage\PYGZus{}cond}\PYG{p}{(}\PYG{n}{method}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Stage Condition}
\PYG{l+s+sd}{    }
\PYG{l+s+sd}{     - must be declared before @stage}
\PYG{l+s+sd}{     - must return true for the @stage of the same name to run}
\PYG{l+s+sd}{    """}
    \PYG{n}{\PYGZus{}stage\PYGZus{}conds}\PYG{p}{[}\PYG{n}{method}\PYG{o}{.}\PYG{n}{func\PYGZus{}name}\PYG{p}{]} \PYG{o}{=} \PYG{n}{method}

\PYG{k}{class} \PYG{n+nc}{WorkerStages}\PYG{p}{(}\PYG{n+nb}{object}\PYG{p}{)}\PYG{p}{:}
    \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{    Available attributes:}

\PYG{l+s+sd}{        - self.analysis}
\PYG{l+s+sd}{        - self.session = DBSession(bind=create\PYGZus{}engine(rnaseqlyze.db\PYGZus{}url))}

\PYG{l+s+sd}{    .. note::}
\PYG{l+s+sd}{        After changing one of the attributes of the self.analysis object,}
\PYG{l+s+sd}{        **allways** **immediately** call self.session.commit(). Otherwise}
\PYG{l+s+sd}{        the database will stay locked and the web frontend can't update the ui.}

\PYG{l+s+sd}{    """}

    \PYG{c}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
    \PYG{c}{\PYGZsh{} Utility Methods \& Properties}


    \PYG{k}{def} \PYG{n+nf}{log\PYGZus{}cmd}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{,} \PYG{o}{*}\PYG{n}{cmd}\PYG{p}{)}\PYG{p}{:}
        \PYG{c}{\PYGZsh{} can't wait() on subprocess with a timeout, alas start up}
        \PYG{c}{\PYGZsh{} a 2nd thread to do it and join() on that one with a timeout}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{forking subprocess: \PYGZdl{} }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{l+s}{'}\PYG{l+s}{ }\PYG{l+s}{'}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n+nb}{map}\PYG{p}{(}\PYG{n+nb}{repr}\PYG{p}{,} \PYG{n}{cmd}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{proc} \PYG{o}{=} \PYG{n}{Popen}\PYG{p}{(}\PYG{n}{cmd}\PYG{p}{,} \PYG{n}{stdout}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{logfile}\PYG{p}{,} \PYG{n}{stderr}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{logfile}\PYG{p}{)}
        \PYG{n}{waiter} \PYG{o}{=} \PYG{n}{Thread}\PYG{p}{(}\PYG{n}{target}\PYG{o}{=}\PYG{n}{proc}\PYG{o}{.}\PYG{n}{wait}\PYG{p}{)}
        \PYG{n}{cpu\PYGZus{}percent}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb+bp}{True}\PYG{p}{)}
        \PYG{n}{waiter}\PYG{o}{.}\PYG{n}{start}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{waiter}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{)}
        \PYG{k}{while} \PYG{n}{waiter}\PYG{o}{.}\PYG{n}{is\PYGZus{}alive}\PYG{p}{(}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{subprocess still running - system load: }\PYG{l+s}{"} \PYG{o}{+}
                     \PYG{l+s}{"}\PYG{l+s}{ / }\PYG{l+s}{"}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+si}{\PYGZpc{}\PYGZpc{}}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{p} \PYG{k}{for} \PYG{n}{p} \PYG{o+ow}{in} \PYG{n}{cpu\PYGZus{}percent}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n+nb+bp}{True}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{waiter}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{l+m+mi}{15}\PYG{p}{)}
        \PYG{k}{if} \PYG{n}{proc}\PYG{o}{.}\PYG{n}{returncode} \PYG{o}{!=} \PYG{l+m+mi}{0}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ failed}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n}{cmd}\PYG{p}{,}\PYG{p}{)}\PYG{p}{)}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{srr\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}base\PYGZus{}name}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{bam\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ Mapping}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}\PYG{o}{.}\PYG{n}{id}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{srr\PYGZus{}name}\PYG{p}{)}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{coverage\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ Coverage}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}\PYG{o}{.}\PYG{n}{id}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{srr\PYGZus{}name}\PYG{p}{)}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{hp\PYGZus{}terms\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ Hairpin Terminators}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}\PYG{o}{.}\PYG{n}{id}\PYG{p}{,}\PYG{p}{)}

    \PYG{n+nd}{@property}
    \PYG{k}{def} \PYG{n+nf}{pr\PYGZus{}operons\PYGZus{}name}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{l+s}{"}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ Predicted Operons}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}\PYG{o}{.}\PYG{n}{id}\PYG{p}{,}\PYG{p}{)}

    \PYG{c}{\PYGZsh{}}
    \PYG{c}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}
    \PYG{c}{\PYGZsh{} Stages}

    \PYG{n+nd}{@stage\PYGZus{}cond}
    \PYG{k}{def} \PYG{n+nf}{determine\PYGZus{}inputfile\PYGZus{}type}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}uploaded}
    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{determine\PYGZus{}inputfile\PYGZus{}type}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{\PYGZus{}8bytes} \PYG{o}{=} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}path}\PYG{p}{)}\PYG{o}{.}\PYG{n}{read}\PYG{p}{(}\PYG{l+m+mi}{8}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{first 8 bytes of input data: }\PYG{l+s+si}{\PYGZpc{}r}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{\PYGZus{}8bytes}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}type} \PYG{o}{=} \PYG{p}{(}
                     \PYG{l+s}{'}\PYG{l+s}{fastq}\PYG{l+s}{'} \PYG{k}{if} \PYG{n}{\PYGZus{}8bytes}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{@}\PYG{l+s}{'}
                \PYG{k}{else} \PYG{l+s}{'}\PYG{l+s}{sra}\PYG{l+s}{'}   \PYG{k}{if} \PYG{n}{\PYGZus{}8bytes}    \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{NCBI.sra}\PYG{l+s}{'} \PYG{k}{else} \PYG{n+nb+bp}{None}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{session}\PYG{o}{.}\PYG{n}{commit}\PYG{p}{(}\PYG{p}{)}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}type}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Unknown input data type}\PYG{l+s}{"}\PYG{p}{)}

    \PYG{n+nd}{@stage\PYGZus{}cond}
    \PYG{k}{def} \PYG{n+nf}{fetch\PYGZus{}srr}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{c}{\PYGZsh{} don't download if private}
        \PYG{c}{\PYGZsh{} file uploaded or srr already in cache}
        \PYG{k}{return} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}uploaded} \PYGZbs{}
               \PYG{o+ow}{and} \PYG{o+ow}{not} \PYG{n}{os}\PYG{o}{.}\PYG{n}{path}\PYG{o}{.}\PYG{n}{exists}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{rnaseq\PYGZus{}run}\PYG{o}{.}\PYG{n}{sra\PYGZus{}path}\PYG{p}{)}
    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{fetch\PYGZus{}srr}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{rnaseq\PYGZus{}run}\PYG{o}{.}\PYG{n}{download}\PYG{p}{(}\PYG{p}{)}

    \PYG{n+nd}{@stage\PYGZus{}cond}
    \PYG{k}{def} \PYG{n+nf}{convert\PYGZus{}input\PYGZus{}file}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{o+ow}{not} \PYG{n}{exists}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}fq\PYGZus{}path}\PYG{p}{)}
    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{convert\PYGZus{}input\PYGZus{}file}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{chdir}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{input\PYGZus{}data\PYGZus{}dir}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{log\PYGZus{}cmd}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{fastq-dump}\PYG{l+s}{"}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}name}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{created }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}fq\PYGZus{}path}\PYG{p}{)}

    \PYG{n+nd}{@stage\PYGZus{}cond}
    \PYG{k}{def} \PYG{n+nf}{fetch\PYGZus{}genbank\PYGZus{}file}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{o+ow}{not} \PYG{n}{exists}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}path}\PYG{p}{)}
    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{fetch\PYGZus{}genbank\PYGZus{}file}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{exists}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}data\PYGZus{}dir}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{os}\PYG{o}{.}\PYG{n}{makedirs}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}data\PYGZus{}dir}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Fetching }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{ from entrez...}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}}
                                 \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{org\PYGZus{}accession}\PYG{p}{)}
        \PYG{n}{gb\PYGZus{}id} \PYG{o}{=} \PYG{n}{efetch}\PYG{o}{.}\PYG{n}{get\PYGZus{}nc\PYGZus{}id}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{org\PYGZus{}accession}\PYG{p}{)}
        \PYG{n}{efetch}\PYG{o}{.}\PYG{n}{fetch\PYGZus{}nc\PYGZus{}gb}\PYG{p}{(}\PYG{n}{gb\PYGZus{}id}\PYG{p}{,} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}path}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{...done}\PYG{l+s}{"}\PYG{p}{)}

    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{read\PYGZus{}genbank\PYGZus{}file}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record} \PYG{o}{=} \PYG{n}{SeqIO}\PYG{o}{.}\PYG{n}{parse}\PYG{p}{(}\PYG{n+nb}{open}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis} \PYGZbs{}
                                    \PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}path}\PYG{p}{)}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{genbank}\PYG{l+s}{"}\PYG{p}{)}\PYG{o}{.}\PYG{n}{next}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{ngenes} \PYG{o}{=} \PYG{n+nb}{sum}\PYG{p}{(}\PYG{l+m+mi}{1} \PYG{k}{for} \PYG{n}{f} \PYG{o+ow}{in} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}\PYG{o}{.}\PYG{n}{features}
                       \PYG{k}{if} \PYG{n}{f}\PYG{o}{.}\PYG{n}{type} \PYG{o}{==} \PYG{l+s}{'}\PYG{l+s}{gene}\PYG{l+s}{'}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{genbank file lists }\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{ genes}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{ngenes}\PYG{p}{)}

    \PYG{n+nd}{@stage\PYGZus{}cond}
    \PYG{k}{def} \PYG{n+nf}{genbank\PYGZus{}to\PYGZus{}fasta}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{o+ow}{not} \PYG{n}{exists}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}fa\PYGZus{}path}\PYG{p}{)}
    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{genbank\PYGZus{}to\PYGZus{}fasta}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Converting }\PYG{l+s}{'}\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{'}\PYG{l+s}{ to fasta format}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}}
                                           \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}name}\PYG{p}{)}
        \PYG{n}{record} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}
        \PYG{n}{saved\PYGZus{}id} \PYG{o}{=} \PYG{n}{record}\PYG{o}{.}\PYG{n}{id}
        \PYG{n}{record}\PYG{o}{.}\PYG{n}{id} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{chr}\PYG{l+s}{"} \PYG{c}{\PYGZsh{} make ucsc browser custom tracks work}
        \PYG{n}{SeqIO}\PYG{o}{.}\PYG{n}{write}\PYG{p}{(}\PYG{n}{record}\PYG{p}{,} \PYG{n+nb}{open}\PYG{p}{(}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}fa\PYGZus{}path}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{fasta}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{n}{record}\PYG{o}{.}\PYG{n}{id} \PYG{o}{=} \PYG{n}{saved\PYGZus{}id}

    \PYG{n+nd}{@stage\PYGZus{}cond}
    \PYG{k}{def} \PYG{n+nf}{bowtie\PYGZus{}build}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{o+ow}{not} \PYG{n}{exists}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}data\PYGZus{}dir}\PYG{p}{,}
                               \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}base\PYGZus{}name} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{.1.bt2}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}
    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{bowtie\PYGZus{}build}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{chdir}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}data\PYGZus{}dir}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{log\PYGZus{}cmd}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{bowtie2-build}\PYG{l+s}{"}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}fa\PYGZus{}name}\PYG{p}{,}
                                      \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}base\PYGZus{}name}\PYG{p}{)}

    \PYG{n+nd}{@stage\PYGZus{}cond}
    \PYG{k}{def} \PYG{n+nf}{tophat}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{o+ow}{not} \PYG{n}{exists}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{,}
                               \PYG{l+s}{"}\PYG{l+s}{tophat-output}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{accepted\PYGZus{}hits.bam}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}
    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{tophat}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{chdir}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{)}
        \PYG{n}{n\PYGZus{}cpus} \PYG{o}{=} \PYG{n}{os}\PYG{o}{.}\PYG{n}{sysconf}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{SC\PYGZus{}NPROCESSORS\PYGZus{}ONLN}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{n}{fq} \PYG{o}{=} \PYG{n}{relpath}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{inputfile\PYGZus{}fq\PYGZus{}path}\PYG{p}{)}
        \PYG{n}{gb} \PYG{o}{=} \PYG{n}{relpath}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}data\PYGZus{}dir}\PYG{p}{,}
                          \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}base\PYGZus{}name}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{log\PYGZus{}cmd}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{tophat}\PYG{l+s}{"}\PYG{p}{,}
                        \PYG{l+s}{"}\PYG{l+s}{-p}\PYG{l+s}{"}\PYG{p}{,} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{n\PYGZus{}cpus}\PYG{p}{)}\PYG{p}{,}
                        \PYG{l+s}{"}\PYG{l+s}{-o}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{tophat-output}\PYG{l+s}{"}\PYG{p}{,}
                        \PYG{l+s}{"}\PYG{l+s}{--segment-length}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{999999999}\PYG{l+s}{"}\PYG{p}{,}
                        \PYG{l+s}{"}\PYG{l+s}{--no-coverage-search}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{--no-novel-juncs}\PYG{l+s}{"}\PYG{p}{,} \PYG{n}{gb}\PYG{p}{,} \PYG{n}{fq}\PYG{p}{)}

    \PYG{n+nd}{@stage\PYGZus{}cond}
    \PYG{k}{def} \PYG{n+nf}{create\PYGZus{}coverage\PYGZus{}track}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{o+ow}{not} \PYG{n}{exists}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{coverage.bigwig}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}
    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{create\PYGZus{}coverage\PYGZus{}track}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{chdir}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{)}
        \PYG{c}{\PYGZsh{} the script automatically converts it's}
        \PYG{c}{\PYGZsh{} output to bigwig if it finds kent's wigToBigWig}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{log\PYGZus{}cmd}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{bam\PYGZus{}to\PYGZus{}wiggle.py}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{-o}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{coverage.bigwig}\PYG{l+s}{"}\PYG{p}{,}
                                    \PYG{l+s}{"}\PYG{l+s}{tophat-output/accepted\PYGZus{}hits.bam}\PYG{l+s}{"}\PYG{p}{)}

    \PYG{n+nd}{@stage\PYGZus{}cond}
    \PYG{k}{def} \PYG{n+nf}{genbank\PYGZus{}to\PYGZus{}ptt}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{o+ow}{not} \PYG{n}{exists}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}data\PYGZus{}dir}\PYG{p}{,}
                               \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}\PYG{o}{.}\PYG{n}{id} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{.ptt}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}
    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{genbank\PYGZus{}to\PYGZus{}ptt}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{ptt\PYGZus{}name} \PYG{o}{=} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}\PYG{o}{.}\PYG{n}{id} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{.ptt}\PYG{l+s}{"}
        \PYG{n}{ptt\PYGZus{}path} \PYG{o}{=} \PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}data\PYGZus{}dir}\PYG{p}{,} \PYG{n}{ptt\PYGZus{}name}\PYG{p}{)}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{symlink}\PYG{p}{(}\PYG{n}{ptt\PYGZus{}name}\PYG{p}{,} \PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}data\PYGZus{}dir}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{chr.ptt}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{converting }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ to ptt}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}name}\PYG{p}{)}
        \PYG{n}{ptt\PYGZus{}file} \PYG{o}{=} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{ptt\PYGZus{}path}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{n}{gb\PYGZus{}file} \PYG{o}{=} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}path}\PYG{p}{)}
        \PYG{n}{gb2ptt}\PYG{o}{.}\PYG{n}{gb2ptt}\PYG{p}{(}\PYG{n}{gb\PYGZus{}file}\PYG{p}{,} \PYG{n}{ptt\PYGZus{}file}\PYG{p}{)}
        \PYG{n}{ptt\PYGZus{}file}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{gb\PYGZus{}file}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}

    \PYG{n+nd}{@stage\PYGZus{}cond}
    \PYG{k}{def} \PYG{n+nf}{transterm\PYGZus{}hp}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{k}{return} \PYG{o+ow}{not} \PYG{n}{exists}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{,}
                               \PYG{l+s}{"}\PYG{l+s}{hp\PYGZus{}terminators.bigbed}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}
    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{transterm\PYGZus{}hp}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{chdir}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{running transterm}\PYG{l+s}{"}\PYG{p}{)}

        \PYG{n}{tt\PYGZus{}out} \PYG{o}{=} \PYG{n+nb}{open}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{transterm\PYGZus{}hp.out}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w+}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{c}{\PYGZsh{} --min-conf=n n is the cut-off confidence value,}
        \PYG{c}{\PYGZsh{}              between 0 and 100, the default is 76}
        \PYG{n}{tt\PYGZus{}args} \PYG{o}{=} \PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{--min-conf=47}\PYG{l+s}{"}\PYG{p}{,}
                   \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}fa\PYGZus{}path}\PYG{p}{,}
                   \PYG{n}{relpath}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}data\PYGZus{}dir}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{chr.ptt}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{transterm}\PYG{o}{.}\PYG{n}{run}\PYG{p}{(}\PYG{n}{tt\PYGZus{}args}\PYG{p}{,} \PYG{n}{out}\PYG{o}{=}\PYG{n}{tt\PYGZus{}out}\PYG{p}{,} \PYG{n}{err}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{logfile}\PYG{p}{)}
        \PYG{n}{tt\PYGZus{}out}\PYG{o}{.}\PYG{n}{seek}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{c}{\PYGZsh{} keep a copy in memory}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hp\PYGZus{}terminators} \PYG{o}{=} \PYG{n+nb}{list}\PYG{p}{(}\PYG{n}{transterm}\PYG{o}{.}\PYG{n}{iterator}\PYG{p}{(}\PYG{n}{tt\PYGZus{}out}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{tt\PYGZus{}out}\PYG{o}{.}\PYG{n}{seek}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{found \PYGZob{}0\PYGZcb{} possible hairpin terminators}\PYG{l+s}{"}
                                 \PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hp\PYGZus{}terminators}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}
        \PYG{c}{\PYGZsh{} create a bed track}
        \PYG{n}{bed\PYGZus{}file} \PYG{o}{=} \PYG{n+nb}{open}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{hp\PYGZus{}terminators.bed}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{n}{transterm}\PYG{o}{.}\PYG{n}{tt2bed}\PYG{p}{(}\PYG{n}{tt\PYGZus{}out}\PYG{p}{,} \PYG{n}{bed\PYGZus{}file}\PYG{p}{)}
        \PYG{n}{bed\PYGZus{}file}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{tt\PYGZus{}out}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}

        \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{running bedToBigBed}\PYG{l+s}{"}\PYG{p}{)}

        \PYG{c}{\PYGZsh{} convert it to bigBed}
        \PYG{n}{chrs} \PYG{o}{=} \PYG{n+nb}{open}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{chrom.sizes}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{n}{chrs}\PYG{o}{.}\PYG{n}{write}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{chr }\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}\PYG{o}{.}\PYG{n}{seq}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{chrs}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{log\PYGZus{}cmd}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{bedToBigBed}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{hp\PYGZus{}terminators.bed}\PYG{l+s}{"}\PYG{p}{,}
                         \PYG{l+s}{"}\PYG{l+s}{chrom.sizes}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{hp\PYGZus{}terminators.bigbed}\PYG{l+s}{"}\PYG{p}{)}

    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{predict\PYGZus{}operons}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}

        \PYG{c}{\PYGZsh{} extract the coverage data from the bam track created by tophat}
        \PYG{n}{bam\PYGZus{}path} \PYG{o}{=} \PYG{n}{join}\PYG{p}{(}\PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{,}
                        \PYG{l+s}{"}\PYG{l+s}{tophat-output}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{accepted\PYGZus{}hits.bam}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{)}
        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n}{exists}\PYG{p}{(}\PYG{n}{bam\PYGZus{}path} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{.bai}\PYG{l+s}{"}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{pysam}\PYG{o}{.}\PYG{n}{index}\PYG{p}{(}\PYG{n}{bam\PYGZus{}file}\PYG{p}{)}

        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{covered} \PYG{o}{=} \PYG{l+m+mi}{0}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{coverage} \PYG{o}{=} \PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]} \PYG{o}{*} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}\PYG{o}{.}\PYG{n}{seq}\PYG{p}{)}

        \PYG{n}{sam\PYGZus{}reader} \PYG{o}{=} \PYG{n}{pysam}\PYG{o}{.}\PYG{n}{Samfile}\PYG{p}{(}\PYG{n}{bam\PYGZus{}path}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{rb}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{n}{chrom}\PYG{p}{,} \PYG{n}{length} \PYG{o}{=} \PYG{n}{sam\PYGZus{}reader}\PYG{o}{.}\PYG{n}{references}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,} \PYG{n}{sam\PYGZus{}reader}\PYG{o}{.}\PYG{n}{lengths}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}

        \PYG{k}{assert} \PYG{n}{chrom} \PYG{o}{==} \PYG{l+s}{"}\PYG{l+s}{chr}\PYG{l+s}{"} \PYG{o+ow}{and} \PYG{n}{length} \PYG{o}{==} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}\PYG{o}{.}\PYG{n}{seq}\PYG{p}{)}\PYG{p}{,} \PYG{p}{(}
                \PYG{l+s}{"}\PYG{l+s}{Something went badly wrong}\PYG{l+s}{"}
                \PYG{l+s}{"}\PYG{l+s}{ -- the bam track or genbank file cold be corrupted...}\PYG{l+s}{"}\PYG{p}{)}

        \PYG{k}{for} \PYG{n}{base} \PYG{o+ow}{in} \PYG{n}{sam\PYGZus{}reader}\PYG{o}{.}\PYG{n}{pileup}\PYG{p}{(}\PYG{n}{chrom}\PYG{p}{,} \PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{length}\PYG{p}{)}\PYG{p}{:}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{covered} \PYG{o}{+}\PYG{o}{=} \PYG{l+m+mi}{1}
            \PYG{k}{if} \PYG{n}{base}\PYG{o}{.}\PYG{n}{n} \PYG{o}{\textgreater{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max}\PYG{p}{:}
                \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max} \PYG{o}{=} \PYG{n}{base}\PYG{o}{.}\PYG{n}{n}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{coverage}\PYG{p}{[}\PYG{n}{base}\PYG{o}{.}\PYG{n}{pos}\PYG{p}{]} \PYG{o}{=} \PYG{n}{base}\PYG{o}{.}\PYG{n}{n}

        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{covered}\PYG{p}{:}
            \PYG{k}{raise} \PYG{n+ne}{Exception}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{Not a valid bam file}\PYG{l+s}{"}\PYG{p}{)}

        \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{maximum coverage: }\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{max}\PYG{p}{)}
        \PYG{n}{log}\PYG{o}{.}\PYG{n}{debug}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{number of bases covered by short reads: }\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{/}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{p}{(}
                                    \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{covered}\PYG{p}{,} \PYG{n+nb}{len}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}\PYG{o}{.}\PYG{n}{seq}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

        \PYG{c}{\PYGZsh{} available objects at this point}
        \PYG{c}{\PYGZsh{} -------------------------------}
        \PYG{c}{\PYGZsh{}}
        \PYG{c}{\PYGZsh{} - self.genbank\PYGZus{}record: Biopython SeqIO.parse()d genbank file}
        \PYG{c}{\PYGZsh{}}
        \PYG{c}{\PYGZsh{} - self.coverage: [n,n,n,n,...] / len = len(self.genbank\PYGZus{}record.seq)}
        \PYG{c}{\PYGZsh{}}
        \PYG{c}{\PYGZsh{} - self.max: max(n)}
        \PYG{c}{\PYGZsh{}}
        \PYG{c}{\PYGZsh{} - self.hpterminators: ((id, begin, end, strand, confidence), ...)}
        \PYG{c}{\PYGZsh{}                         str, str, str, str (1/-), int}
        \PYG{c}{\PYGZsh{}}

        \PYG{c}{\PYGZsh{} FIXME: do some magic here}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{operons} \PYG{o}{=} \PYG{n}{Operon}\PYG{p}{(}\PYG{n}{begin}\PYG{o}{=}\PYG{l+m+mi}{0}\PYG{p}{,} \PYG{n}{end}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{,} \PYG{n}{strand}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{confidence}\PYG{o}{=}\PYG{l+m+mi}{10}\PYG{p}{)}\PYG{p}{,}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{operons} \PYG{o}{=} \PYG{n}{Operon}\PYG{p}{(}\PYG{n}{begin}\PYG{o}{=}\PYG{l+m+mi}{200}\PYG{p}{,} \PYG{n}{end}\PYG{o}{=}\PYG{l+m+mi}{300}\PYG{p}{,} \PYG{n}{strand}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{confidence}\PYG{o}{=}\PYG{l+m+mi}{50}\PYG{p}{)}\PYG{p}{,}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{operons} \PYG{o}{=} \PYG{n}{Operon}\PYG{p}{(}\PYG{n}{begin}\PYG{o}{=}\PYG{l+m+mi}{400}\PYG{p}{,} \PYG{n}{end}\PYG{o}{=}\PYG{l+m+mi}{500}\PYG{p}{,} \PYG{n}{strand}\PYG{o}{=}\PYG{l+m+mi}{1}\PYG{p}{,} \PYG{n}{confidence}\PYG{o}{=}\PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{,}

        \PYG{c}{\PYGZsh{} create a bed track}
        \PYG{n}{track\PYGZus{}name} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{rna-seqlyze-operon\PYGZus{}predictions}\PYG{l+s}{"}
        \PYG{n}{os}\PYG{o}{.}\PYG{n}{chdir}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{)}
        \PYG{n}{bed\PYGZus{}file} \PYG{o}{=} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{track\PYGZus{}name} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{.bed}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w}\PYG{l+s}{"}\PYG{p}{)}
        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{o} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{operons}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{begin}\PYG{p}{,} \PYG{n}{end} \PYG{o}{=} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{o}\PYG{o}{.}\PYG{n}{begin}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{o}\PYG{o}{.}\PYG{n}{end}\PYG{p}{)}
            \PYG{n}{rgb\PYGZus{}color} \PYG{o}{=} \PYG{l+s}{'}\PYG{l+s}{,}\PYG{l+s}{'}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{p}{(}\PYG{n+nb}{str}\PYG{p}{(}\PYG{l+m+mi}{100} \PYG{o}{-} \PYG{n+nb}{int}\PYG{p}{(}\PYG{n}{o}\PYG{o}{.}\PYG{n}{confidence}\PYG{p}{)}\PYG{p}{)}\PYG{p}{,}\PYG{p}{)}\PYG{o}{*}\PYG{l+m+mi}{3}\PYG{p}{)}
            \PYG{k}{print} \PYG{o}{\textgreater{}\textgreater{}} \PYG{n}{bed\PYGZus{}file}\PYG{p}{,} \PYG{l+s}{'}\PYG{l+s+se}{\PYGZbs{}t}\PYG{l+s}{'}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{p}{(}
                \PYG{l+s}{'}\PYG{l+s}{chr}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{begin}\PYG{p}{,} \PYG{n}{end}\PYG{p}{,}
                \PYG{l+s}{'}\PYG{l+s}{OPERON\PYGZus{}}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{'} \PYG{o}{\PYGZpc{}} \PYG{n}{i}\PYG{p}{,} \PYG{n+nb}{str}\PYG{p}{(}\PYG{n}{o}\PYG{o}{.}\PYG{n}{confidence}\PYG{p}{)}\PYG{p}{,}
                \PYG{l+s}{'}\PYG{l+s}{+}\PYG{l+s}{'} \PYG{k}{if} \PYG{n}{o}\PYG{o}{.}\PYG{n}{strand} \PYG{o}{\textgreater{}} \PYG{l+m+mi}{0} \PYG{k}{else} \PYG{l+s}{'}\PYG{l+s}{-}\PYG{l+s}{'}\PYG{p}{,} \PYG{n}{begin}\PYG{p}{,} \PYG{n}{end}\PYG{p}{,} \PYG{n}{rgb\PYGZus{}color}
            \PYG{p}{)}\PYG{p}{)}
        \PYG{n}{bed\PYGZus{}file}\PYG{o}{.}\PYG{n}{close}\PYG{p}{(}\PYG{p}{)}

        \PYG{c}{\PYGZsh{} convert it to bigBed}
        \PYG{c}{\PYGZsh{} chrom\PYGZus{}sizes already generated during "transterm\PYGZus{}hp"}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{log\PYGZus{}cmd}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{bedToBigBed}\PYG{l+s}{"}\PYG{p}{,} \PYG{n}{track\PYGZus{}name} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{.bed}\PYG{l+s}{"}\PYG{p}{,}
                         \PYG{l+s}{"}\PYG{l+s}{chrom.sizes}\PYG{l+s}{"}\PYG{p}{,} \PYG{n}{track\PYGZus{}name} \PYG{o}{+} \PYG{l+s}{"}\PYG{l+s}{.bigbed}\PYG{l+s}{"}\PYG{p}{)}

    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{upload\PYGZus{}track\PYGZus{}data}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}

        \PYG{c}{\PYGZsh{} FIXME: names are not unique on galaxy:}
        \PYG{c}{\PYGZsh{} is "\PYGZpc{}s\PYGZus{}\PYGZpc{}s" \PYGZpc{} (srr\PYGZus{}name, self.analysis.org\PYGZus{}accession) good enough ?}

        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}bam}\PYG{p}{:}
            \PYG{n}{bam\PYGZus{}path} \PYG{o}{=} \PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{,} 
                             \PYG{l+s}{"}\PYG{l+s}{tophat-output}\PYG{l+s}{"}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{accepted\PYGZus{}hits.bam}\PYG{l+s}{"}\PYG{p}{)}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{uploading accepted\PYGZus{}hits.bam to galaxy}\PYG{l+s}{"}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}bam} \PYG{o}{=} \PYG{n}{GalaxyDataset}\PYG{p}{(}
                \PYG{n+nb}{id}\PYG{o}{=}\PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{upload}\PYG{p}{(}\PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{bam\PYGZus{}path}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bam\PYGZus{}name}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{...done - id: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}bam}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{session}\PYG{o}{.}\PYG{n}{commit}\PYG{p}{(}\PYG{p}{)}

        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}coverage}\PYG{p}{:}
            \PYG{n}{coverage\PYGZus{}path} \PYG{o}{=} \PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{coverage.bigwig}\PYG{l+s}{"}\PYG{p}{)}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{uploading coverage.bigwig to galaxy}\PYG{l+s}{"}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}coverage} \PYG{o}{=} \PYG{n}{GalaxyDataset}\PYG{p}{(}
                \PYG{n+nb}{id}\PYG{o}{=}\PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{upload}\PYG{p}{(}\PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{coverage\PYGZus{}path}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{coverage\PYGZus{}name}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{...done - id: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}coverage}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{session}\PYG{o}{.}\PYG{n}{commit}\PYG{p}{(}\PYG{p}{)}

        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}hp\PYGZus{}terms}\PYG{p}{:}
            \PYG{n}{hp\PYGZus{}terms\PYGZus{}path} \PYG{o}{=} \PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{,}
                                 \PYG{l+s}{"}\PYG{l+s}{hp\PYGZus{}terminators.bigbed}\PYG{l+s}{"}\PYG{p}{)}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{uploading hp\PYGZus{}terminators.bigbed to galaxy}\PYG{l+s}{"}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}hp\PYGZus{}terms} \PYG{o}{=} \PYG{n}{GalaxyDataset}\PYG{p}{(}
                \PYG{n+nb}{id}\PYG{o}{=}\PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{upload}\PYG{p}{(}\PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{hp\PYGZus{}terms\PYGZus{}path}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hp\PYGZus{}terms\PYGZus{}name}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{...done - id: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}hp\PYGZus{}terms}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{session}\PYG{o}{.}\PYG{n}{commit}\PYG{p}{(}\PYG{p}{)}

        \PYG{k}{if} \PYG{o+ow}{not} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}pr\PYGZus{}operons}\PYG{p}{:}
            \PYG{n}{track\PYGZus{}filename} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{rna-seqlyze-operon\PYGZus{}predictions.bigbed}\PYG{l+s}{"}
            \PYG{n}{pr\PYGZus{}operons\PYGZus{}path} \PYG{o}{=} \PYG{n}{join}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{data\PYGZus{}dir}\PYG{p}{,} \PYG{n}{track\PYGZus{}filename}\PYG{p}{)}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{uploading }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ to galaxy}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n}{track\PYGZus{}filename}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}pr\PYGZus{}operons} \PYG{o}{=} \PYG{n}{GalaxyDataset}\PYG{p}{(}
                \PYG{n+nb}{id}\PYG{o}{=}\PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{upload}\PYG{p}{(}\PYG{n+nb}{open}\PYG{p}{(}\PYG{n}{pr\PYGZus{}operons\PYGZus{}path}\PYG{p}{)}\PYG{p}{,} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pr\PYGZus{}operons\PYGZus{}name}\PYG{p}{)}\PYG{p}{)}
            \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{...done - id: }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}}
                                         \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}pr\PYGZus{}operons}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{session}\PYG{o}{.}\PYG{n}{commit}\PYG{p}{(}\PYG{p}{)}

    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{create\PYGZus{}and\PYGZus{}upload\PYGZus{}hg\PYGZus{}text}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{        {}`{}`hgt.customText{}`{}` is a paremeter of the UCSC}
\PYG{l+s+sd}{        "hgTracks" genome browser application that makes it}
\PYG{l+s+sd}{        possible to share "cutom tracks" via a url.}

\PYG{l+s+sd}{        The value of the {}`{}`hgt.customText{}`{}` parameter is itself}
\PYG{l+s+sd}{        an URL. The shareable "custom tracks url" is therefore an}
\PYG{l+s+sd}{        URL that containes another URL. The other url must be "escaped"}
\PYG{l+s+sd}{        for this to work. That actually happens in}
\PYG{l+s+sd}{        :meth:{}`\PYGZti{}rnaseqlyze.core.analysis.AnalysisMixins.hg\PYGZus{}url{}`.}
\PYG{l+s+sd}{        }
\PYG{l+s+sd}{        The details are explained here:}
\PYG{l+s+sd}{        http://genome.ucsc.edu/goldenPath/help/customTrack.html\PYGZsh{}SHARE}
\PYG{l+s+sd}{        """}

        \PYG{k}{if} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}hg\PYGZus{}text}\PYG{p}{:}
            \PYG{k}{return}

        \PYG{n}{tracks} \PYG{o}{=} \PYG{p}{[}\PYG{p}{]}

        \PYG{c}{\PYGZsh{} FIXME: this cries for refactoring -- with logging!}

        \PYG{c}{\PYGZsh{} bam track (mapping)}
        \PYG{n}{bam\PYGZus{}url} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{https://}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{hostname} \PYGZbs{}
                    \PYG{o}{+} \PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{ucsc\PYGZus{}bam\PYGZus{}path\PYGZus{}template} \PYGZbs{}
                        \PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{dataset}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}bam}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}
        \PYG{n}{tracks}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{BAMTrack}\PYG{p}{(}\PYG{n}{url}\PYG{o}{=}\PYG{n}{bam\PYGZus{}url}\PYG{p}{,}
                               \PYG{n}{name}\PYG{o}{=}\PYG{l+s}{"}\PYG{l+s}{RNA-Seqlyze \textbar{} }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{bam\PYGZus{}name}\PYG{p}{)}\PYG{p}{)}

        \PYG{c}{\PYGZsh{} bigwig track (coverage)}
        \PYG{n}{coverage\PYGZus{}url} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{https://}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{hostname} \PYGZbs{}
                        \PYG{o}{+} \PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{dataset\PYGZus{}display\PYGZus{}url\PYGZus{}template} \PYGZbs{}
                            \PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{dataset}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}coverage}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}
        \PYG{n}{tracks}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{BigWigTrack}\PYG{p}{(}\PYG{n}{url}\PYG{o}{=}\PYG{n}{coverage\PYGZus{}url}\PYG{p}{,}
                                  \PYG{n}{name}\PYG{o}{=}\PYG{l+s}{"}\PYG{l+s}{RNA-Seqlyze \textbar{} }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{coverage\PYGZus{}name}\PYG{p}{)}\PYG{p}{)}

        \PYG{c}{\PYGZsh{} bigbed track (terminators)}
        \PYG{n}{hp\PYGZus{}terms\PYGZus{}url} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{https://}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{hostname} \PYGZbs{}
                        \PYG{o}{+} \PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{dataset\PYGZus{}display\PYGZus{}url\PYGZus{}template} \PYGZbs{}
                            \PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{dataset}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}hp\PYGZus{}terms}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}
        \PYG{n}{tracks}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{BigBedTrack}\PYG{p}{(}\PYG{n}{url}\PYG{o}{=}\PYG{n}{hp\PYGZus{}terms\PYGZus{}url}\PYG{p}{,}
                                  \PYG{n}{name}\PYG{o}{=}\PYG{l+s}{"}\PYG{l+s}{RNA-Seqlyze \textbar{} }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}} \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{hp\PYGZus{}terms\PYGZus{}name}\PYG{p}{)}\PYG{p}{)}

        \PYG{c}{\PYGZsh{} bigbed track (predicted operons)}
        \PYG{n}{pr\PYGZus{}operons\PYGZus{}url} \PYG{o}{=} \PYG{l+s}{"}\PYG{l+s}{https://}\PYG{l+s}{"} \PYG{o}{+} \PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{hostname} \PYGZbs{}
                        \PYG{o}{+} \PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{dataset\PYGZus{}display\PYGZus{}url\PYGZus{}template} \PYGZbs{}
                            \PYG{o}{.}\PYG{n}{format}\PYG{p}{(}\PYG{n}{dataset}\PYG{o}{=}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}pr\PYGZus{}operons}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}
        \PYG{n}{tracks}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}\PYG{n}{BigBedTrack}\PYG{p}{(}\PYG{n}{url}\PYG{o}{=}\PYG{n}{pr\PYGZus{}operons\PYGZus{}url}\PYG{p}{,}
                                  \PYG{n}{name}\PYG{o}{=}\PYG{l+s}{"}\PYG{l+s}{RNA-Seqlyze \textbar{} }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}}
                                                      \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{pr\PYGZus{}operons\PYGZus{}name}\PYG{p}{)}\PYG{p}{)}

        \PYG{n}{track\PYGZus{}file} \PYG{o}{=} \PYG{n}{StringIO}\PYG{p}{(}\PYG{p}{)}
        \PYG{n}{track\PYGZus{}file}\PYG{o}{.}\PYG{n}{write}\PYG{p}{(}\PYG{l+s}{'}\PYG{l+s+se}{\PYGZbs{}n}\PYG{l+s}{'}\PYG{o}{.}\PYG{n}{join}\PYG{p}{(}\PYG{n}{tracks}\PYG{p}{)}\PYG{p}{)}
        \PYG{n}{track\PYGZus{}file}\PYG{o}{.}\PYG{n}{seek}\PYG{p}{(}\PYG{l+m+mi}{0}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{galaxy\PYGZus{}hg\PYGZus{}text} \PYG{o}{=} \PYG{n}{GalaxyDataset}\PYG{p}{(}
                    \PYG{n+nb}{id}\PYG{o}{=}\PYG{n}{galaxy}\PYG{o}{.}\PYG{n}{upload}\PYG{p}{(}\PYG{n}{track\PYGZus{}file}\PYG{p}{,}
                                     \PYG{l+s}{"}\PYG{l+s}{UCSC Tracks Analysis}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{.txt}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}}
                                                          \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{id}\PYG{p}{)}\PYG{p}{)}
        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{session}\PYG{o}{.}\PYG{n}{commit}\PYG{p}{(}\PYG{p}{)}

    \PYG{n+nd}{@stage}
    \PYG{k}{def} \PYG{n+nf}{create\PYGZus{}genbank\PYGZus{}file}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{p}{)}\PYG{p}{:}
        \PYG{l+s+sd}{"""}
\PYG{l+s+sd}{        Greate a genbank file containing}

\PYG{l+s+sd}{        For more documentation on how to create new features, visit}

\PYG{l+s+sd}{         - http://biopython.org/\PYGZbs{}\PYGZbs{}}
\PYG{l+s+sd}{                 DIST/docs/api/Bio.SeqRecord.SeqRecord-class.html\PYGZsh{}\PYGZus{}\PYGZus{}getitem\PYGZus{}\PYGZus{}}
\PYG{l+s+sd}{         - http://biopython.org/\PYGZbs{}\PYGZbs{}}
\PYG{l+s+sd}{                 DIST/docs/api/Bio.SeqFeature.SeqFeature-class.html}

\PYG{l+s+sd}{         - http://www.ebi.ac.uk/\PYGZbs{}\PYGZbs{}}
\PYG{l+s+sd}{                 embl/Documentation/FT\PYGZus{}definitions/feature\PYGZus{}table.html}
\PYG{l+s+sd}{        """}

        \PYG{n}{log}\PYG{o}{.}\PYG{n}{info}\PYG{p}{(}\PYG{l+s}{"}\PYG{l+s}{augmenting genbank file }\PYG{l+s+si}{\PYGZpc{}s}\PYG{l+s}{ with putative operons}\PYG{l+s}{"} \PYG{o}{\PYGZpc{}}
                                          \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{genbankfile\PYGZus{}name}\PYG{p}{)}

        \PYG{k}{for} \PYG{n}{i}\PYG{p}{,} \PYG{n}{o} \PYG{o+ow}{in} \PYG{n+nb}{enumerate}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{operons}\PYG{p}{)}\PYG{p}{:}
            \PYG{n}{location} \PYG{o}{=} \PYG{n}{FeatureLocation}\PYG{p}{(}\PYG{n}{ExactPosition}\PYG{p}{(}\PYG{n}{o}\PYG{o}{.}\PYG{n}{begin}\PYG{p}{)}\PYG{p}{,}
                                       \PYG{n}{ExactPosition}\PYG{p}{(}\PYG{n}{o}\PYG{o}{.}\PYG{n}{end}\PYG{p}{)}\PYG{p}{)}
            \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}\PYG{o}{.}\PYG{n}{features}\PYG{o}{.}\PYG{n}{append}\PYG{p}{(}
                \PYG{n}{SeqFeature}\PYG{p}{(}\PYG{n}{location}\PYG{p}{,}
                    \PYG{n+nb}{type}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{mRNA}\PYG{l+s}{'}\PYG{p}{,}
                    \PYG{n}{strand}\PYG{o}{=}\PYG{n}{o}\PYG{o}{.}\PYG{n}{strand}\PYG{p}{,}
                    \PYG{n}{qualifiers}\PYG{o}{=}\PYG{n+nb}{dict}\PYG{p}{(}
                        \PYG{n}{note}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{putative, confidence }\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s+si}{\PYGZpc{}\PYGZpc{}}\PYG{l+s}{'} \PYG{o}{\PYGZpc{}} \PYG{n}{o}\PYG{o}{.}\PYG{n}{confidence}\PYG{p}{,}
                        \PYG{n}{operon}\PYG{o}{=}\PYG{l+s}{'}\PYG{l+s}{rnas-}\PYG{l+s+si}{\PYGZpc{}d}\PYG{l+s}{'} \PYG{o}{\PYGZpc{}} \PYG{n}{i}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}

        \PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}\PYG{o}{.}\PYG{n}{features}\PYG{o}{.}\PYG{n}{sort}\PYG{p}{(}
                \PYG{n}{key}\PYG{o}{=}\PYG{k}{lambda} \PYG{n}{f}\PYG{p}{:} \PYG{n}{f}\PYG{o}{.}\PYG{n}{location}\PYG{o}{.}\PYG{n}{start}\PYG{o}{.}\PYG{n}{position}\PYG{p}{)}

        \PYG{n}{xgb\PYGZus{}file} \PYG{o}{=} \PYG{n+nb}{open}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{analysis}\PYG{o}{.}\PYG{n}{xgenbankfile\PYGZus{}path}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{w}\PYG{l+s}{"}\PYG{p}{)}

        \PYG{n}{SeqIO}\PYG{o}{.}\PYG{n}{write}\PYG{p}{(}\PYG{n+nb+bp}{self}\PYG{o}{.}\PYG{n}{genbank\PYGZus{}record}\PYG{p}{,} \PYG{n}{xgb\PYGZus{}file}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{genbank}\PYG{l+s}{"}\PYG{p}{)}
    \PYG{c}{\PYGZsh{}}
    \PYG{c}{\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}\PYGZsh{}}

\PYG{k}{assert} \PYG{o+ow}{not} \PYG{n}{\PYGZus{}stage\PYGZus{}conds}\PYG{p}{,} \PYG{l+s}{"}\PYG{l+s}{@stage\PYGZus{}cond}\PYG{l+s}{'}\PYG{l+s}{s must be declared before @stage}\PYG{l+s}{'}\PYG{l+s}{s}\PYG{l+s}{"}
\PYG{n}{WorkerStages}\PYG{o}{.}\PYG{n}{stages} \PYG{o}{=} \PYG{n}{\PYGZus{}stages}
\PYG{k}{del} \PYG{n}{\PYGZus{}stages}\PYG{p}{,} \PYG{n}{\PYGZus{}stage\PYGZus{}conds}
\end{Verbatim}


\subsubsection{Javascript Code}
\label{rnaseqlyze-pdf:javascript-code}

\paragraph{File \emph{rnaseqlyze.js}}
\label{rnaseqlyze-pdf:file-rnaseqlyze-js}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{c+cm}{/*}
\PYG{c+cm}{ * RNA-seqlyze javascript routines}
\PYG{c+cm}{ */}

\PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{k+kd}{function}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}

    \PYG{c+c1}{// global variables and helpers}
    \PYG{c+c1}{// ----------------------------}

    \PYG{c+c1}{// \PYGZus{}\PYGZus{}\PYGZus{} el \PYGZus{}\PYGZus{}\PYGZus{}}
    \PYG{c+c1}{//  from http://joestelmach.github.com/laconic/}
    \PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{el} \PYG{o}{=} \PYG{n+nx}{\PYGZdl{}}\PYG{p}{.}\PYG{n+nx}{el}\PYG{p}{;}

    \PYG{c+c1}{// log.info() and log.debug()}
    \PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{log} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{'info'}\PYG{o}{:} \PYG{k+kd}{function}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{n+nx}{console}\PYG{p}{.}\PYG{n+nx}{log}\PYG{p}{.}\PYG{n+nx}{apply}\PYG{p}{(}\PYG{n+nx}{console}\PYG{p}{,} \PYG{n+nx}{arguments}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s1}{'debug'}\PYG{o}{:} \PYG{k+kd}{function}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}
    \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{rnaseqlyze\PYGZus{}debug}\PYG{p}{)}
        \PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{log}\PYG{p}{.}\PYG{n+nx}{debug} \PYG{o}{=} \PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{log}\PYG{p}{.}\PYG{n+nx}{info}\PYG{p}{;}

    \PYG{c+c1}{// page initializaion}
    \PYG{c+c1}{// ------------------}

    \PYG{c+c1}{// use bootstrap's}
    \PYG{c+c1}{// "scrollspy" plugin}
    \PYG{c+c1}{//  -- patched version - see https://github.com/twitter/bootstrap/pull/3829}
    \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nb}{window}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{scrollspy}\PYG{p}{(}\PYG{p}{\PYGZob{}}
\PYG{c+c1}{//            offset: 200,}
            \PYG{n+nx}{wrap}\PYG{o}{:} \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}wrap'}\PYG{p}{)}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{,}
    \PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}


    \PYG{c+c1}{// Generally useful stuff}
    \PYG{c+c1}{// ----------------------}

    \PYG{c+c1}{// based on http://stackoverflow.com/a/4673436}

    \PYG{n+nb}{String}\PYG{p}{.}\PYG{n+nx}{prototype}\PYG{p}{.}\PYG{n+nx}{format} \PYG{o}{=} \PYG{k+kd}{function}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k+kd}{var} \PYG{n+nx}{i} \PYG{o}{=} \PYG{l+m+mi}{0}\PYG{p}{;} \PYG{n+nx}{args} \PYG{o}{=} \PYG{n+nx}{arguments}\PYG{p}{;}
        \PYG{k}{return} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{replace}\PYG{p}{(}\PYG{l+s+sr}{/\PYGZob{}\PYGZcb{}/g}\PYG{p}{,} \PYG{k+kd}{function}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{k}{return} \PYG{n+nx}{args}\PYG{p}{[}\PYG{n+nx}{i}\PYG{o}{++}\PYG{p}{]}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{;}

\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

\PYG{c+c1}{// http://stackoverflow.com/a/7531350}
\PYG{n+nx}{jQuery}\PYG{p}{.}\PYG{n+nx}{fn}\PYG{p}{.}\PYG{n+nx}{extend}\PYG{p}{(}\PYG{p}{\PYGZob{}}
    \PYG{n+nx}{scrollToBottom}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k+kd}{var} \PYG{n+nx}{top} \PYG{o}{=} \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{k}{this}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{offset}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{top}\PYG{p}{;}
        \PYG{k+kd}{var} \PYG{n+nx}{offtop} \PYG{o}{=} \PYG{n+nx}{top} \PYG{o}{-} \PYG{l+m+mi}{250} \PYG{o}{+} \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{k}{this}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{height}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nx}{jQuery}\PYG{p}{(}\PYG{l+s+s1}{'html,body'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{animate}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{n+nx}{scrollTop}\PYG{o}{:} \PYG{n+nx}{offtop}\PYG{p}{\PYGZcb{}}\PYG{p}{,} \PYG{l+m+mi}{100}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\end{Verbatim}


\paragraph{File \emph{rnaseqlyze-create.js}}
\label{rnaseqlyze-pdf:file-rnaseqlyze-create-js}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{c+cm}{/*}
\PYG{c+cm}{ * RNA-seqlyze javascript routines}
\PYG{c+cm}{ *}
\PYG{c+cm}{ *     for the "create" page}
\PYG{c+cm}{ */}

\PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nb}{document}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{ready}\PYG{p}{(}\PYG{k+kd}{function}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}

    \PYG{c+cm}{/*}
\PYG{c+cm}{     * Toggle input type}
\PYG{c+cm}{     */}

    \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}input\PYGZus{}type\PYGZus{}radio'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{click}\PYG{p}{(}\PYG{k+kd}{function}\PYG{p}{(}\PYG{n+nx}{event}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nx}{event}\PYG{p}{.}\PYG{n+nx}{target}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{hasClass}\PYG{p}{(}\PYG{l+s+s2}{"srr"}\PYG{p}{)}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{c+c1}{// user chose the "Data File" option}
            \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}sra-controls'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{hide}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
            \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}srr-controls'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{show}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}} \PYG{k}{else} \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nx}{event}\PYG{p}{.}\PYG{n+nx}{target}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{hasClass}\PYG{p}{(}\PYG{l+s+s2}{"sra"}\PYG{p}{)}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{c+c1}{// user chose the "SRR Identifier" option}
            \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}srr-controls'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{hide}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
            \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}sra-controls'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{show}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}} \PYG{c+c1}{// else}
            \PYG{c+c1}{// what the...}
    \PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
    \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}input\PYGZus{}type\PYGZus{}radio .srr'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{click}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

    \PYG{c+cm}{/*}
\PYG{c+cm}{     * discretionary \PYGZsh{}pairendlenControls}
\PYG{c+cm}{     */}

    \PYG{k+kd}{function} \PYG{n+nx}{maybe\PYGZus{}show\PYGZus{}pairendlen\PYGZus{}controls}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}pairendedInput'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{attr}\PYG{p}{(}\PYG{l+s+s1}{'checked'}\PYG{p}{)}\PYG{p}{)}
            \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}pairendlenControls'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{show}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{else}
            \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}pairendlenControls'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{hide}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}

    \PYG{n+nx}{maybe\PYGZus{}show\PYGZus{}pairendlen\PYGZus{}controls}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
    \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}pairendedInput'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{change}\PYG{p}{(}\PYG{n+nx}{maybe\PYGZus{}show\PYGZus{}pairendlen\PYGZus{}controls}\PYG{p}{)}\PYG{p}{;}


    \PYG{c+cm}{/*}
\PYG{c+cm}{     * Toggle organism input type}
\PYG{c+cm}{     */}

    \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}org\PYGZus{}type\PYGZus{}radio'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{click}\PYG{p}{(}\PYG{k+kd}{function}\PYG{p}{(}\PYG{n+nx}{event}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nx}{event}\PYG{p}{.}\PYG{n+nx}{target}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{hasClass}\PYG{p}{(}\PYG{l+s+s2}{"title"}\PYG{p}{)}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{c+c1}{// user chose "Title"}
            \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}genbankfile-controls'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{hide}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
            \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}org\PYGZus{}title-controls'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{show}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}} \PYG{k}{else} \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nx}{event}\PYG{p}{.}\PYG{n+nx}{target}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{hasClass}\PYG{p}{(}\PYG{l+s+s2}{"file"}\PYG{p}{)}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{c+c1}{// user chose "Genbank File"}
            \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}org\PYGZus{}title-controls'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{hide}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
            \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}genbankfile-controls'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{show}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}} \PYG{c+c1}{// else}
            \PYG{c+c1}{// what the ...}
    \PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
    \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}org\PYGZus{}type\PYGZus{}radio .title'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{click}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

    \PYG{c+cm}{/*}
\PYG{c+cm}{     * Organism input autocompletion}
\PYG{c+cm}{     */}

    \PYG{k+kd}{var} \PYG{n+nx}{organisms} \PYG{o}{=} \PYG{k}{new} \PYG{n+nb}{Array}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

    \PYG{n+nx}{\PYGZdl{}}\PYG{p}{.}\PYG{n+nx}{ajax}\PYG{p}{(}\PYG{p}{\PYGZob{}}
        \PYG{n+nx}{url}\PYG{o}{:} \PYG{l+s+s2}{"rest/organisms"}\PYG{p}{,}
        \PYG{n+nx}{dataType}\PYG{o}{:} \PYG{l+s+s2}{"json"}\PYG{p}{,}
        \PYG{n+nx}{success}\PYG{o}{:} \PYG{k+kd}{function}\PYG{p}{(}\PYG{n+nx}{data}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{c+c1}{// No idea yet what to do with those that have multiple}
            \PYG{c+c1}{// accessions listed in 'genome' -- filter them out here for now}
            \PYG{c+c1}{//}
            \PYG{c+c1}{// see ftp://ftp.ncbi.nih.gov/genomes/GENOME\PYGZus{}REPORTS/prokaryotes.txt}
            \PYG{c+c1}{//}
            \PYG{n+nx}{\PYGZus{}}\PYG{p}{(}\PYG{n+nx}{data}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{each}\PYG{p}{(}\PYG{k+kd}{function}\PYG{p}{(}\PYG{n+nx}{org}\PYG{p}{)} \PYG{p}{\PYGZob{}}
                \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{org}\PYG{p}{.}\PYG{n+nx}{acc}\PYG{p}{.}\PYG{n+nx}{indexOf}\PYG{p}{(}\PYG{l+s+s2}{","}\PYG{p}{)} \PYG{o}{\textgreater{}=} \PYG{l+m+mi}{0}\PYG{p}{)}
                    \PYG{k}{return}\PYG{p}{;}
                \PYG{n+nx}{organisms}\PYG{p}{.}\PYG{n+nx}{push}\PYG{p}{(}\PYG{l+s+s2}{"\PYGZob{}\PYGZcb{} (\PYGZob{}\PYGZcb{}/\PYGZob{}\PYGZcb{})"}\PYG{p}{.}\PYG{n+nx}{format}\PYG{p}{(}
                                \PYG{n+nx}{org}\PYG{p}{.}\PYG{n+nx}{title}\PYG{p}{,} \PYG{n+nx}{org}\PYG{p}{.}\PYG{n+nx}{db}\PYG{p}{,} \PYG{n+nx}{org}\PYG{p}{.}\PYG{n+nx}{acc}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;} \PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;} \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

    \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}organismInput'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{typeahead}\PYG{p}{(}\PYG{p}{\PYGZob{}}
        \PYG{n+nx}{source}\PYG{o}{:} \PYG{n+nx}{organisms}\PYG{p}{,}
    \PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

    \PYG{c+cm}{/*}
\PYG{c+cm}{     * plupload -- from src/plupload/examples/custom.html}
\PYG{c+cm}{     */}

    \PYG{k+kd}{var} \PYG{n+nx}{uploads} \PYG{o}{=} \PYG{p}{\PYGZob{}}
        \PYG{l+s+s1}{'inputfile'}\PYG{o}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{l+s+s1}{'genbankfile'}\PYG{o}{:} \PYG{p}{\PYGZob{}}\PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}\PYG{p}{;}

    \PYG{k+kd}{var} \PYG{n+nx}{context} \PYG{o}{=} \PYG{k+kd}{function}\PYG{p}{(}\PYG{n+nx}{name}\PYG{p}{)} \PYG{p}{\PYGZob{}}

        \PYG{k+kd}{var} \PYG{n+nx}{self} \PYG{o}{=} \PYG{k}{this}\PYG{p}{;}

        \PYG{k+kd}{var} \PYG{n+nx}{options} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{n+nx}{url}\PYG{o}{:}      \PYG{l+s+s1}{'upload'}\PYG{p}{,}
            \PYG{n+nx}{runtimes}\PYG{o}{:}      \PYG{l+s+s1}{'html5,gears,flash,silverlight,browserplus,html4'}\PYG{p}{,}
            \PYG{n+nx}{browse\PYGZus{}button}\PYG{o}{:}    \PYG{n+nx}{name} \PYG{o}{+} \PYG{l+s+s1}{'\PYGZus{}browse'}\PYG{p}{,}
            \PYG{n+nx}{drop\PYGZus{}element}\PYG{o}{:}       \PYG{n+nx}{name} \PYG{o}{+} \PYG{l+s+s1}{'\PYGZus{}progress'}\PYG{p}{,}
            \PYG{n+nx}{multipart\PYGZus{}params}\PYG{o}{:}     \PYG{p}{\PYGZob{}} \PYG{l+s+s1}{'type'}\PYG{o}{:} \PYG{n+nx}{name}\PYG{p}{,}
                                      \PYG{l+s+s1}{'session'}\PYG{o}{:} \PYG{n+nx}{upload\PYGZus{}session} \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{n+nx}{flash\PYGZus{}swf\PYGZus{}url}\PYG{o}{:}          \PYG{n+nx}{path\PYGZus{}js} \PYG{o}{+} \PYG{l+s+s1}{'/plupload.flash.swf'}\PYG{p}{,}
            \PYG{n+nx}{silverlight\PYGZus{}xap\PYGZus{}url}\PYG{o}{:}      \PYG{n+nx}{path\PYGZus{}js} \PYG{o}{+} \PYG{l+s+s1}{'/plupload.silverlight.xap'}\PYG{p}{,}
        \PYG{p}{\PYGZcb{}}\PYG{p}{;}

        \PYG{k+kd}{var} \PYG{n+nx}{events} \PYG{o}{=} \PYG{p}{\PYGZob{}}
            \PYG{c+c1}{// 'Init': function(up, params) \PYGZob{}}
            \PYG{c+c1}{//     \PYGZdl{}('\PYGZsh{}' + name + '\PYGZus{}progress .filestatus').text(}
            \PYG{c+c1}{//                     "Current runtime: " + params.runtime);}
            \PYG{c+c1}{// \PYGZcb{},}
            \PYG{l+s+s1}{'FilesAdded'}\PYG{o}{:} \PYG{k+kd}{function}\PYG{p}{(}\PYG{n+nx}{up}\PYG{p}{,} \PYG{n+nx}{up\PYGZus{}files}\PYG{p}{)} \PYG{p}{\PYGZob{}}
                \PYG{c+c1}{// remove all other files already present}
                \PYG{c+c1}{// plupload features multiple files in one widget}
                \PYG{c+c1}{// we have two widgets and one name per widget}
                \PYG{n+nx}{up}\PYG{p}{.}\PYG{n+nx}{splice}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
                \PYG{n+nx}{self}\PYG{p}{.}\PYG{n+nx}{active} \PYG{o}{=} \PYG{k+kc}{true}\PYG{p}{;}
                \PYG{n+nx}{log}\PYG{p}{.}\PYG{n+nx}{debug}\PYG{p}{(}\PYG{l+s+s2}{"FilesAdded"}\PYG{p}{,} \PYG{n+nx}{up}\PYG{p}{.}\PYG{n+nx}{files}\PYG{p}{,} \PYG{n+nx}{up\PYGZus{}files}\PYG{p}{)}\PYG{p}{;}
                \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}'} \PYG{o}{+} \PYG{n+nx}{name} \PYG{o}{+} \PYG{l+s+s1}{'\PYGZus{}progress .filestatus'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{text}\PYG{p}{(}
                    \PYG{n+nx}{up\PYGZus{}files}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{.}\PYG{n+nx}{name} \PYG{o}{+}
                        \PYG{l+s+s1}{' ('} \PYG{o}{+} \PYG{n+nx}{plupload}\PYG{p}{.}\PYG{n+nx}{formatSize}\PYG{p}{(}\PYG{n+nx}{up\PYGZus{}files}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{.}\PYG{n+nx}{size}\PYG{p}{)} \PYG{o}{+} \PYG{l+s+s1}{')'}\PYG{p}{)}\PYG{p}{;}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s1}{'UploadComplete'}\PYG{o}{:} \PYG{k+kd}{function}\PYG{p}{(}\PYG{n+nx}{up}\PYG{p}{,} \PYG{n+nx}{up\PYGZus{}files}\PYG{p}{)} \PYG{p}{\PYGZob{}}
                \PYG{n+nx}{self}\PYG{p}{.}\PYG{n+nx}{complete} \PYG{o}{=} \PYG{k+kc}{true}\PYG{p}{;}
                \PYG{k}{for} \PYG{p}{(}\PYG{n+nx}{nam} \PYG{k}{in} \PYG{n+nx}{uploads}\PYG{p}{)}
                    \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{uploads}\PYG{p}{[}\PYG{n+nx}{nam}\PYG{p}{]}\PYG{p}{.}\PYG{n+nx}{active}\PYG{p}{)}
                        \PYG{k}{if}\PYG{p}{(}\PYG{o}{!}\PYG{n+nx}{uploads}\PYG{p}{[}\PYG{n+nx}{nam}\PYG{p}{]}\PYG{p}{.}\PYG{n+nx}{complete}\PYG{p}{)}
                            \PYG{k}{return}\PYG{p}{;}
                \PYG{n+nx}{log}\PYG{p}{.}\PYG{n+nx}{debug}\PYG{p}{(}\PYG{l+s+s2}{"UploadComplete"}\PYG{p}{,} \PYG{l+s+s2}{"go"}\PYG{p}{)}\PYG{p}{;}
                \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}create\PYGZus{}form'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{submit}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{l+s+s1}{'UploadProgress'}\PYG{o}{:} \PYG{k+kd}{function}\PYG{p}{(}\PYG{n+nx}{up}\PYG{p}{,} \PYG{n+nx}{up\PYGZus{}file}\PYG{p}{)} \PYG{p}{\PYGZob{}}
                \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}'} \PYG{o}{+} \PYG{n+nx}{name} \PYG{o}{+} \PYG{l+s+s1}{'\PYGZus{}progress .bar'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{css}\PYG{p}{(}
                            \PYG{l+s+s2}{"width"}\PYG{p}{,} \PYG{n+nx}{up\PYGZus{}file}\PYG{p}{.}\PYG{n+nx}{percent} \PYG{o}{+} \PYG{l+s+s1}{'\PYGZpc{}'}\PYG{p}{)}\PYG{p}{;}
                \PYG{c+c1}{// \PYGZdl{}('\PYGZsh{}' + name + '\PYGZus{}progress .filestatus').text(}
                \PYG{c+c1}{//                             up\PYGZus{}file.percent + '\PYGZpc{}');}
            \PYG{p}{\PYGZcb{}}\PYG{p}{,}
        \PYG{p}{\PYGZcb{}}\PYG{p}{;}

        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{active} \PYG{o}{=} \PYG{k+kc}{false}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{complete} \PYG{o}{=} \PYG{k+kc}{false}\PYG{p}{;}

        \PYG{k+kd}{var} \PYG{n+nx}{up} \PYG{o}{=} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{up} \PYG{o}{=} \PYG{k}{new} \PYG{n+nx}{plupload}\PYG{p}{.}\PYG{n+nx}{Uploader}\PYG{p}{(}\PYG{n+nx}{options}\PYG{p}{)}\PYG{p}{;}

        \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}'} \PYG{o}{+} \PYG{n+nx}{name} \PYG{o}{+} \PYG{l+s+s1}{'\PYGZus{}progress'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{click}\PYG{p}{(}\PYG{k+kd}{function}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}'} \PYG{o}{+} \PYG{n+nx}{name} \PYG{o}{+} \PYG{l+s+s1}{'\PYGZus{}browse'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{click}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

        \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}create\PYGZus{}form\PYGZus{}submit'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{click}\PYG{p}{(}\PYG{k+kd}{function}\PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{k}{for} \PYG{p}{(}\PYG{n+nx}{nam} \PYG{k}{in} \PYG{n+nx}{uploads}\PYG{p}{)}
                \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{uploads}\PYG{p}{[}\PYG{n+nx}{nam}\PYG{p}{]}\PYG{p}{.}\PYG{n+nx}{active}\PYG{p}{)}
                    \PYG{p}{\PYGZob{}} \PYG{n+nx}{up}\PYG{p}{.}\PYG{n+nx}{start}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;} \PYG{k}{return} \PYG{k+kc}{false}\PYG{p}{;} \PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

        \PYG{k}{for} \PYG{p}{(}\PYG{n+nx}{x} \PYG{k}{in} \PYG{n+nx}{events}\PYG{p}{)}
            \PYG{n+nx}{up}\PYG{p}{.}\PYG{n+nx}{bind}\PYG{p}{(}\PYG{n+nx}{x}\PYG{p}{,} \PYG{n+nx}{events}\PYG{p}{[}\PYG{n+nx}{x}\PYG{p}{]}\PYG{p}{)}\PYG{p}{;}

        \PYG{n+nx}{log}\PYG{p}{.}\PYG{n+nx}{debug}\PYG{p}{(}\PYG{l+s+s2}{"debug"}\PYG{p}{)}\PYG{p}{;}

        \PYG{n+nx}{up}\PYG{p}{.}\PYG{n+nx}{init}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{;}

    \PYG{k}{for} \PYG{p}{(}\PYG{n+nx}{name} \PYG{k}{in} \PYG{n+nx}{uploads}\PYG{p}{)}
        \PYG{n+nx}{uploads}\PYG{p}{[}\PYG{n+nx}{name}\PYG{p}{]} \PYG{o}{=} \PYG{k}{new} \PYG{n+nx}{context}\PYG{p}{(}\PYG{n+nx}{name}\PYG{p}{)}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

\PYG{c+c1}{// vim: et:sw=4}
\end{Verbatim}


\paragraph{File \emph{rnaseqlyze-analysis.js}}
\label{rnaseqlyze-pdf:file-rnaseqlyze-analysis-js}
\begin{Verbatim}[commandchars=\\\{\},numbers=left,firstnumber=1,stepnumber=5]
\PYG{c+cm}{/*}
\PYG{c+cm}{ * RNA-seqlyze 'analysis' view javascript}
\PYG{c+cm}{ */}

\PYG{c+c1}{// backbone.js Models}
\PYG{c+c1}{// ------------------}
\PYG{c+c1}{//}
\PYG{c+c1}{// -\textgreater{} http://backbonejs.org/\PYGZsh{}Model}

\PYG{c+c1}{// The Analysis}
\PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{Analysis} \PYG{o}{=} \PYG{n+nx}{Backbone}\PYG{p}{.}\PYG{n+nx}{Model}\PYG{p}{.}\PYG{n+nx}{extend}\PYG{p}{(}\PYG{p}{\PYGZob{}}
    \PYG{n+nx}{urlRoot}\PYG{o}{:} \PYG{l+s+s2}{"../rest/analyses"}\PYG{p}{,}
    \PYG{n+nx}{initialize}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{files} \PYG{o}{=} \PYG{k}{new} \PYG{n+nx}{DataDirListing}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{files}\PYG{p}{.}\PYG{n+nx}{analysis} \PYG{o}{=} \PYG{k}{this}\PYG{p}{;}

        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{stage\PYGZus{}logs} \PYG{o}{=} \PYG{k}{new} \PYG{n+nx}{StageLogList}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{stage\PYGZus{}logs}\PYG{p}{.}\PYG{n+nx}{analysis} \PYG{o}{=} \PYG{k}{this}\PYG{p}{;}

        \PYG{c+c1}{// "cascade": update files list}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{bind}\PYG{p}{(}\PYG{l+s+s2}{"change:data\PYGZus{}dir\PYGZus{}state"}\PYG{p}{,} \PYG{k+kd}{function} \PYG{p}{(}\PYG{n+nx}{self}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{n+nx}{self}\PYG{p}{.}\PYG{n+nx}{files}\PYG{p}{.}\PYG{n+nx}{fetch}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{n+nx}{add}\PYG{o}{:} \PYG{k+kc}{true}\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
        \PYG{c+c1}{// "cascade": update stage\PYGZus{}logs}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{bind}\PYG{p}{(}\PYG{l+s+s2}{"change:stage\PYGZus{}logs\PYGZus{}state"}\PYG{p}{,} \PYG{k+kd}{function} \PYG{p}{(}\PYG{n+nx}{self}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{k+kd}{var} \PYG{n+nx}{len} \PYG{o}{=} \PYG{n+nx}{self}\PYG{p}{.}\PYG{n+nx}{stage\PYGZus{}logs}\PYG{p}{.}\PYG{n+nx}{size}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
            \PYG{n+nx}{self}\PYG{p}{.}\PYG{n+nx}{stage\PYGZus{}logs}\PYG{p}{.}\PYG{n+nx}{fetch}\PYG{p}{(}\PYG{p}{\PYGZob{}}
                \PYG{n+nx}{add}\PYG{o}{:} \PYG{k+kc}{true}\PYG{p}{,}
                \PYG{c+c1}{// The last stage\PYGZus{}log is the current one and updates frequently.}
                \PYG{c+c1}{// It's id stays the same though and which causes backbone.js}
                \PYG{c+c1}{// to regard it as a duplicate and drop it. But a copy of the}
                \PYG{c+c1}{// ajax response is passed to the success callback. So we pick}
                \PYG{c+c1}{// the changed log text from there and fire a "change" event}
                \PYG{c+c1}{// by set()ting the 'text' attribute of the affected model.}
                \PYG{n+nx}{success}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{n+nx}{stage\PYGZus{}logs}\PYG{p}{,} \PYG{n+nx}{rsp}\PYG{p}{)} \PYG{p}{\PYGZob{}}
                    \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{len}\PYG{p}{)}
                        \PYG{n+nx}{stage\PYGZus{}logs}\PYG{p}{.}\PYG{n+nx}{at}\PYG{p}{(}\PYG{n+nx}{len}\PYG{o}{-}\PYG{l+m+mi}{1}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{set}\PYG{p}{(}\PYG{l+s+s1}{'text'}\PYG{p}{,} \PYG{n+nx}{rsp}\PYG{p}{[}\PYG{n+nx}{len}\PYG{o}{-}\PYG{l+m+mi}{1}\PYG{p}{]}\PYG{p}{.}\PYG{n+nx}{text}\PYG{p}{)}\PYG{p}{;}
                \PYG{p}{\PYGZcb{}}\PYG{p}{,}
            \PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{c+c1}{// log output of one stage}
\PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{StageLog} \PYG{o}{=} \PYG{n+nx}{Backbone}\PYG{p}{.}\PYG{n+nx}{Model}\PYG{p}{.}\PYG{n+nx}{extend}\PYG{p}{(}\PYG{p}{\PYGZob{}}
    \PYG{n+nx}{defaults}\PYG{o}{:} \PYG{p}{\PYGZob{}}
        \PYG{n+nx}{stage}\PYG{o}{:} \PYG{k+kc}{null}\PYG{p}{,}
        \PYG{n+nx}{text}\PYG{o}{:} \PYG{k+kc}{null}\PYG{p}{,}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nx}{idAttribute}\PYG{o}{:} \PYG{l+s+s2}{"id"}\PYG{p}{,}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{c+c1}{// log output of all stages}
\PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{StageLogList} \PYG{o}{=} \PYG{n+nx}{Backbone}\PYG{p}{.}\PYG{n+nx}{Collection}\PYG{p}{.}\PYG{n+nx}{extend}\PYG{p}{(}\PYG{p}{\PYGZob{}}
    \PYG{n+nx}{model}\PYG{o}{:} \PYG{n+nx}{StageLog}\PYG{p}{,}
    \PYG{n+nx}{url}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{return} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{url}\PYG{p}{(}\PYG{p}{)} \PYG{o}{+} \PYG{l+s+s2}{"/logs"}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{c+c1}{// a model for the files}
\PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{DataDirFile} \PYG{o}{=} \PYG{n+nx}{Backbone}\PYG{p}{.}\PYG{n+nx}{Model}\PYG{p}{.}\PYG{n+nx}{extend}\PYG{p}{(}\PYG{p}{\PYGZob{}}
    \PYG{n+nx}{defaults}\PYG{o}{:} \PYG{p}{\PYGZob{}}
        \PYG{n+nx}{path}\PYG{o}{:} \PYG{k+kc}{null}\PYG{p}{,}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nx}{idAttribute}\PYG{o}{:} \PYG{l+s+s2}{"path"}\PYG{p}{,}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{c+c1}{// and for a collection of files}
\PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{DataDirListing} \PYG{o}{=} \PYG{n+nx}{Backbone}\PYG{p}{.}\PYG{n+nx}{Collection}\PYG{p}{.}\PYG{n+nx}{extend}\PYG{p}{(}\PYG{p}{\PYGZob{}}
    \PYG{n+nx}{model}\PYG{o}{:} \PYG{n+nx}{DataDirFile}\PYG{p}{,}
    \PYG{n+nx}{url}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{return} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{url}\PYG{p}{(}\PYG{p}{)} \PYG{o}{+} \PYG{l+s+s2}{"/files"}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

\PYG{c+c1}{// note1:}
\PYG{c+c1}{//}
\PYG{c+c1}{//  Concerning the above code:}
\PYG{c+c1}{//  It might have been simpler to work the files list right into the}
\PYG{c+c1}{//  analysis model on the server and stick to one model here.}
\PYG{c+c1}{//  But then again, there is no harm in doing it like this, because}
\PYG{c+c1}{//  now the files list is more independent and could for}
\PYG{c+c1}{//  example also be displayed on a page of its own.}


\PYG{c+cm}{/* note2:}
\PYG{c+cm}{ *}
\PYG{c+cm}{ *  In the code below,}
\PYG{c+cm}{ *}
\PYG{c+cm}{ *  "el"           is defined in rnaseqlyze.js as "\PYGZdl{}.el", which is defined}
\PYG{c+cm}{ *                 in laconic.js - see  http://joestelmach.github.com/laconic/}
\PYG{c+cm}{ *}
\PYG{c+cm}{ *  "this.\PYGZdl{}el"}
\PYG{c+cm}{ *  "this.el"      are the view's (jQuery wrapped) DOM element in the}
\PYG{c+cm}{ *                 backbone.js architecture - see http://backbonejs.org/\PYGZsh{}View-el}
\PYG{c+cm}{ *}
\PYG{c+cm}{ *  "render().el"  is also the view's "el" and works because we always}
\PYG{c+cm}{ *                 "return this;" from render() - see http://backbonejs.org/\PYGZsh{}View-render}
\PYG{c+cm}{ */}

\PYG{c+c1}{// Two Views showing different details about the analysis}
\PYG{c+c1}{// ------------------------------------------------------}

\PYG{c+c1}{// These render the "Processing" and "Results" section on the}
\PYG{c+c1}{// analysis page. The Processing view is displayed above the Results view.}
\PYG{c+c1}{//}
\PYG{c+c1}{// -\textgreater{} http://backbonejs.org/\PYGZsh{}View}

\PYG{c+c1}{// The "Processing" section}
\PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{ProcessingView} \PYG{o}{=} \PYG{n+nx}{Backbone}\PYG{p}{.}\PYG{n+nx}{View}\PYG{p}{.}\PYG{n+nx}{extend}\PYG{p}{(}\PYG{p}{\PYGZob{}}

    \PYG{n+nx}{initialize}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{bind}\PYG{p}{(}\PYG{l+s+s2}{"change"}\PYG{p}{,} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{change}\PYG{p}{,} \PYG{k}{this}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{stage\PYGZus{}logs} \PYG{o}{=} \PYG{p}{(}
            \PYG{k}{new} \PYG{n+nx}{StageLogListView}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{n+nx}{model}\PYG{o}{:} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{stage\PYGZus{}logs}\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{render}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{el}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nx}{change}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{n+nx}{model}\PYG{p}{,} \PYG{n+nx}{value}\PYG{p}{,} \PYG{n+nx}{options}\PYG{p}{)} \PYG{p}{\PYGZob{}}

        \PYG{c+c1}{// just re-render the whole thing for now}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{empty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{render}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

        \PYG{c+c1}{// remove the busy indicator when finished}
        \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{get}\PYG{p}{(}\PYG{l+s+s1}{'finished'}\PYG{p}{)}\PYG{p}{)}
            \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}spinner'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{remove}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

        \PYG{c+c1}{// make scrollspy refresh it's coordinates}
        \PYG{c+c1}{// because the page size has likely changed}
        \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nb}{window}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{scrollspy}\PYG{p}{(}\PYG{l+s+s1}{'refresh'}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nx}{render}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{c+c1}{// toJSON doesn't really do much besides turning}
        \PYG{c+c1}{// the model.attributes into a useable object}
        \PYG{c+c1}{// see http://backbonejs.org/\PYGZsh{}Model-toJSON}
        \PYG{k+kd}{var} \PYG{n+nx}{analysis} \PYG{o}{=} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{toJSON}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{append}\PYG{p}{(}
            \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{h2}\PYG{p}{(}\PYG{l+s+s2}{"Processing"}\PYG{p}{)}
        \PYG{p}{)}\PYG{p}{;}

        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{append}\PYG{p}{(}\PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{div}\PYG{p}{(}
            \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{h3}\PYG{p}{(}\PYG{l+s+s2}{"Input Check"}\PYG{p}{)}
        \PYG{p}{,}
            \PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{inputfile\PYGZus{}uploaded} \PYG{o}{?}
                \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{p}\PYG{p}{(}\PYG{l+s+s2}{"Type of input: "}\PYG{p}{,}
                     \PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{inputfile\PYGZus{}type} \PYG{o}{?}
                        \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{strong}\PYG{p}{(}\PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{inputfile\PYGZus{}type}\PYG{p}{)} \PYG{o}{:}
                        \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{span}\PYG{p}{(}\PYG{l+s+s2}{"not detected"}\PYG{p}{)}\PYG{p}{)}
                \PYG{o}{:}
                \PYG{k+kc}{null}
        \PYG{p}{,}
            \PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{inputfile\PYGZus{}header} \PYG{o}{?}
                \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{p}\PYG{p}{(}\PYG{l+s+s2}{"First read in input data: "}\PYG{p}{,}
                     \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{pre}\PYG{p}{(}\PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{inputfile\PYGZus{}header}\PYG{p}{)}\PYG{p}{)}
                \PYG{o}{:}
                \PYG{k+kc}{null}

        \PYG{p}{)}\PYG{p}{)}\PYG{p}{;}

        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{append}\PYG{p}{(}\PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{div}\PYG{p}{(}
            \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{h3}\PYG{p}{(}\PYG{l+s+s2}{"Stage Logs"}\PYG{p}{)}
        \PYG{p}{,}
            \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{stage\PYGZus{}logs}
        \PYG{p}{)}\PYG{p}{)}\PYG{p}{;}

        \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{error}\PYG{p}{)}
            \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{append}\PYG{p}{(}
                \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{div}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{k+kr}{class}\PYG{o}{:} \PYG{l+s+s2}{"alert alert-error"}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
                       \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{h4}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{k+kr}{class}\PYG{o}{:} \PYG{l+s+s2}{"alert-heading"}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
                             \PYG{l+s+s2}{"An error occured while analyzing the data"}\PYG{p}{)}\PYG{p}{,}
                       \PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{error}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}

        \PYG{k}{return} \PYG{k}{this}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

\PYG{c+c1}{// The monospaced stage log blocks}
\PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{StageLogListView} \PYG{o}{=} \PYG{n+nx}{Backbone}\PYG{p}{.}\PYG{n+nx}{View}\PYG{p}{.}\PYG{n+nx}{extend}\PYG{p}{(}\PYG{p}{\PYGZob{}}
    \PYG{n+nx}{initialize}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{bind}\PYG{p}{(}\PYG{l+s+s2}{"add"}\PYG{p}{,} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{add}\PYG{p}{,} \PYG{k}{this}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nx}{add}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{n+nx}{model}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{append}\PYG{p}{(}
            \PYG{k}{new} \PYG{n+nx}{StageLogView}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{n+nx}{model}\PYG{o}{:} \PYG{n+nx}{model}\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{render}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{el}
        \PYG{p}{)}\PYG{p}{;}
        \PYG{k}{if} \PYG{p}{(}\PYG{o}{!}\PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{get}\PYG{p}{(}\PYG{l+s+s1}{'finished'}\PYG{p}{)}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{contents}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{find}\PYG{p}{(}\PYG{l+s+s2}{"pre"}\PYG{p}{)}
                \PYG{p}{.}\PYG{n+nx}{not}\PYG{p}{(}\PYG{l+s+s1}{':last'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{css}\PYG{p}{(}\PYG{l+s+s1}{'background-color'}\PYG{p}{,} \PYG{l+s+s1}{''}\PYG{p}{)}
                \PYG{p}{.}\PYG{n+nx}{prevObject}\PYG{p}{.}\PYG{n+nx}{last}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{css}\PYG{p}{(}\PYG{l+s+s1}{'background-color'}\PYG{p}{,} \PYG{l+s+s1}{'\PYGZsh{}ddf'}\PYG{p}{)}\PYG{p}{;}
            \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{contents}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{last}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{scrollToBottom}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}}
        \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nb}{window}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{scrollspy}\PYG{p}{(}\PYG{l+s+s1}{'refresh'}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

\PYG{c+c1}{// \PYGZus{}One\PYGZus{} monospaced stage log block}
\PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{StageLogView} \PYG{o}{=} \PYG{n+nx}{Backbone}\PYG{p}{.}\PYG{n+nx}{View}\PYG{p}{.}\PYG{n+nx}{extend}\PYG{p}{(}\PYG{p}{\PYGZob{}}
    \PYG{n+nx}{initialize}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{bind}\PYG{p}{(}\PYG{l+s+s2}{"change"}\PYG{p}{,} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{change}\PYG{p}{,} \PYG{k}{this}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nx}{change}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{n+nx}{model}\PYG{p}{,} \PYG{n+nx}{options}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{children}\PYG{p}{(}\PYG{l+s+s2}{"pre"}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{text}\PYG{p}{(}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{get}\PYG{p}{(}\PYG{l+s+s1}{'text'}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{scrollToBottom}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nb}{window}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{scrollspy}\PYG{p}{(}\PYG{l+s+s1}{'refresh'}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nx}{render}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k+kd}{var} \PYG{n+nx}{log} \PYG{o}{=} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{toJSON}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{attr}\PYG{p}{(}\PYG{l+s+s1}{'id'}\PYG{p}{,} \PYG{n+nx}{log}\PYG{p}{.}\PYG{n+nx}{stage}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{append}\PYG{p}{(}\PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{h4}\PYG{p}{(}\PYG{n+nx}{log}\PYG{p}{.}\PYG{n+nx}{stage}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{append}\PYG{p}{(}\PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{pre}\PYG{p}{(}\PYG{n+nx}{log}\PYG{p}{.}\PYG{n+nx}{text}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{return} \PYG{k}{this}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

\PYG{c+c1}{// The "Results" section}
\PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{ResultsView} \PYG{o}{=} \PYG{n+nx}{Backbone}\PYG{p}{.}\PYG{n+nx}{View}\PYG{p}{.}\PYG{n+nx}{extend}\PYG{p}{(}\PYG{p}{\PYGZob{}}
    \PYG{n+nx}{initialize}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{bind}\PYG{p}{(}\PYG{l+s+s2}{"change"}\PYG{p}{,} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{change}\PYG{p}{,} \PYG{k}{this}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{files}\PYG{p}{.}\PYG{n+nx}{bind}\PYG{p}{(}\PYG{l+s+s2}{"add"}\PYG{p}{,} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{fileadd}\PYG{p}{,} \PYG{k}{this}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nx}{change}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{n+nx}{model}\PYG{p}{,} \PYG{n+nx}{value}\PYG{p}{,} \PYG{n+nx}{options}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{empty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{render}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nb}{window}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{scrollspy}\PYG{p}{(}\PYG{l+s+s1}{'refresh'}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nx}{fileadd}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k+kd}{var} \PYG{n+nx}{augmented\PYGZus{}gb} \PYG{o}{=} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{files}\PYG{p}{.}\PYG{n+nx}{find}\PYG{p}{(}\PYG{k+kd}{function} \PYG{p}{(}\PYG{n+nx}{file}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{k}{return} \PYG{n+nx}{file}\PYG{p}{.}\PYG{n+nx}{get}\PYG{p}{(}\PYG{l+s+s1}{'path'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{match}\PYG{p}{(}\PYG{l+s+sr}{/augmented\PYGZbs{}.gb\PYGZdl{}/}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{if} \PYG{p}{(}\PYG{o}{!}\PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{augmented\PYGZus{}gb}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{augmented\PYGZus{}gb} \PYG{o}{=} \PYG{n+nx}{augmented\PYGZus{}gb}\PYG{p}{;}
            \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{empty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
            \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{render}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{p}{\PYGZcb{}}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nx}{render}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k+kd}{var} \PYG{n+nx}{analysis} \PYG{o}{=} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{toJSON}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{hg\PYGZus{}url} \PYG{o}{\textbar{}\textbar{}} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{augmented\PYGZus{}gb}\PYG{p}{)} \PYG{p}{\PYGZob{}}
            \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{append}\PYG{p}{(}\PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{h2}\PYG{p}{(}\PYG{l+s+s2}{"Results"}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
            \PYG{k+kd}{var} \PYG{n+nx}{\PYGZdl{}ul} \PYG{o}{=} \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{ul}\PYG{p}{(}\PYG{p}{)}\PYG{p}{)}
            \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{append}\PYG{p}{(}\PYG{n+nx}{\PYGZdl{}ul}\PYG{p}{[}\PYG{l+m+mi}{0}\PYG{p}{]}\PYG{p}{)}\PYG{p}{;}
            \PYG{k}{if} \PYG{p}{(}\PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{augmented\PYGZus{}gb}\PYG{p}{)} \PYG{p}{\PYGZob{}}
                \PYG{k+kd}{var} \PYG{n+nx}{href} \PYG{o}{=} \PYG{n+nx}{\PYGZus{}id} \PYG{o}{+} \PYG{l+s+s1}{'/files/'} \PYG{o}{+} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{augmented\PYGZus{}gb}\PYG{p}{.}\PYG{n+nx}{get}\PYG{p}{(}\PYG{l+s+s1}{'path'}\PYG{p}{)}\PYG{p}{;}
                \PYG{n+nx}{\PYGZdl{}ul}\PYG{p}{.}\PYG{n+nx}{append}\PYG{p}{(}\PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{li}\PYG{p}{(}
                    \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{a}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{n+nx}{href}\PYG{o}{:} \PYG{n+nx}{href}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
                         \PYG{l+s+s2}{"Augmented Genbank File"}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
            \PYG{p}{\PYGZcb{}}
            \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{hg\PYGZus{}url}\PYG{p}{)} \PYG{p}{\PYGZob{}}
                \PYG{n+nx}{\PYGZdl{}ul}\PYG{p}{.}\PYG{n+nx}{append}\PYG{p}{(}\PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{li}\PYG{p}{(}
                    \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{a}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{n+nx}{href}\PYG{o}{:} \PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{hg\PYGZus{}url}\PYG{p}{\PYGZcb{}}\PYG{p}{,}
                         \PYG{l+s+s2}{"Link to custom tracks in UCSC browser"}\PYG{p}{)}\PYG{p}{,}
                    \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{p}\PYG{p}{(}\PYG{l+s+s2}{"It might take a minute until the tracks become "} \PYG{o}{+}
                         \PYG{l+s+s2}{"available."}\PYG{p}{,} \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{br}\PYG{p}{(}\PYG{p}{)}\PYG{p}{,}
                         \PYG{l+s+s2}{"As soon as the last few items "}\PYG{p}{,}
                         \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{a}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{n+nx}{href}\PYG{o}{:} \PYG{n+nx}{galaxy\PYGZus{}history\PYGZus{}url}\PYG{p}{\PYGZcb{}}\PYG{p}{,} \PYG{l+s+s2}{"here"}\PYG{p}{)}\PYG{p}{,}
                         \PYG{l+s+s2}{" turn green it should work."}\PYG{p}{)}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
            \PYG{p}{\PYGZcb{}}
        \PYG{p}{\PYGZcb{}}
        \PYG{k}{return} \PYG{k}{this}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

\PYG{c+c1}{// A View displaying the list of files associated with}
\PYG{c+c1}{// this analysis available on the server (log files, mostly).}
\PYG{c+c1}{// This is currently rendered inside the "Processing" section above.}
\PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{DataDirView} \PYG{o}{=} \PYG{n+nx}{Backbone}\PYG{p}{.}\PYG{n+nx}{View}\PYG{p}{.}\PYG{n+nx}{extend}\PYG{p}{(}\PYG{p}{\PYGZob{}}
    \PYG{n+nx}{initialize}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{bind}\PYG{p}{(}\PYG{l+s+s2}{"reset"}\PYG{p}{,} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{reset}\PYG{p}{,} \PYG{k}{this}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{bind}\PYG{p}{(}\PYG{l+s+s2}{"add"}\PYG{p}{,} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{add}\PYG{p}{,} \PYG{k}{this}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nx}{reset}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{n+nx}{model}\PYG{p}{,} \PYG{n+nx}{value}\PYG{p}{,} \PYG{n+nx}{options}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{empty}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{render}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nx}{render}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{append}\PYG{p}{(}\PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{h2}\PYG{p}{(}\PYG{l+s+s2}{"Data Directory"}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
        \PYG{k+kd}{var} \PYG{n+nx}{ul} \PYG{o}{=} \PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{ul}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}ul} \PYG{o}{=} \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nx}{ul}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{append}\PYG{p}{(}\PYG{n+nx}{ul}\PYG{p}{)}\PYG{p}{;}
        \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nb}{window}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{scrollspy}\PYG{p}{(}\PYG{l+s+s1}{'refresh'}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{return} \PYG{k}{this}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
    \PYG{n+nx}{add}\PYG{o}{:} \PYG{k+kd}{function}\PYG{p}{(}\PYG{n+nx}{model}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}ul}\PYG{p}{.}\PYG{n+nx}{append}\PYG{p}{(}
            \PYG{k}{new} \PYG{n+nx}{DataDirFileView}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{n+nx}{model}\PYG{o}{:} \PYG{n+nx}{model}\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{render}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{el}
        \PYG{p}{)}\PYG{p}{;}
        \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nb}{window}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{scrollspy}\PYG{p}{(}\PYG{l+s+s1}{'refresh'}\PYG{p}{)}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}\PYG{p}{,}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\PYG{c+c1}{// An View, that renders one file}
\PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{DataDirFileView} \PYG{o}{=} \PYG{n+nx}{Backbone}\PYG{p}{.}\PYG{n+nx}{View}\PYG{p}{.}\PYG{n+nx}{extend}\PYG{p}{(}\PYG{p}{\PYGZob{}}
    \PYG{n+nx}{el}\PYG{o}{:} \PYG{l+s+s2}{"\textless{}li\textgreater{}"}\PYG{p}{,}
    \PYG{n+nx}{render}\PYG{o}{:} \PYG{k+kd}{function} \PYG{p}{(}\PYG{n+nx}{model}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{k+kd}{var} \PYG{n+nx}{file} \PYG{o}{=} \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{model}\PYG{p}{.}\PYG{n+nx}{toJSON}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
        \PYG{k+kd}{var} \PYG{n+nx}{href} \PYG{o}{=} \PYG{n+nx}{\PYGZus{}id} \PYG{o}{+} \PYG{l+s+s1}{'/files/'} \PYG{o}{+} \PYG{n+nx}{file}\PYG{p}{.}\PYG{n+nx}{path}\PYG{p}{;}
        \PYG{k}{this}\PYG{p}{.}\PYG{n+nx}{\PYGZdl{}el}\PYG{p}{.}\PYG{n+nx}{html}\PYG{p}{(}\PYG{n+nx}{el}\PYG{p}{.}\PYG{n+nx}{a}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{n+nx}{href}\PYG{o}{:} \PYG{n+nx}{href}\PYG{p}{\PYGZcb{}}\PYG{p}{,} \PYG{n+nx}{file}\PYG{p}{.}\PYG{n+nx}{path}\PYG{p}{)}\PYG{p}{)}\PYG{p}{;}
        \PYG{k}{return} \PYG{k}{this}\PYG{p}{;}
    \PYG{p}{\PYGZcb{}}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}


\PYG{c+c1}{// Initialization}
\PYG{c+c1}{// --------------}

\PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{n+nb}{document}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{ready}\PYG{p}{(}\PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}

    \PYG{c+c1}{// the id of the displayed analysis}
    \PYG{n+nx}{\PYGZus{}id} \PYG{o}{=} \PYG{n+nx}{\PYGZus{}}\PYG{p}{(}\PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{location}\PYG{p}{.}\PYG{n+nx}{pathname}\PYG{p}{.}\PYG{n+nx}{split}\PYG{p}{(}\PYG{l+s+s1}{'/'}\PYG{p}{)}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{last}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}

    \PYG{c+c1}{// create a backbone.js Model}
    \PYG{c+c1}{// with an associated Collection}
    \PYG{n+nx}{analysis} \PYG{o}{=} \PYG{k}{new} \PYG{n+nx}{Analysis}\PYG{p}{(}\PYG{p}{\PYGZob{}}
        \PYG{n+nx}{id}\PYG{o}{:} \PYG{n+nx}{\PYGZus{}id}\PYG{p}{,}
    \PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}

    \PYG{c+c1}{// create two backbone.js views for the}
    \PYG{c+c1}{// analysis, render and insert them into the DOM}
    \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}processing'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{html}\PYG{p}{(}
        \PYG{k}{new} \PYG{n+nx}{ProcessingView}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{n+nx}{model}\PYG{o}{:} \PYG{n+nx}{analysis}\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{render}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{el}
    \PYG{p}{)}\PYG{p}{;}
    \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}results'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{html}\PYG{p}{(}
        \PYG{k}{new} \PYG{n+nx}{ResultsView}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{n+nx}{model}\PYG{o}{:} \PYG{n+nx}{analysis}\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{render}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{el}
    \PYG{p}{)}\PYG{p}{;}
    \PYG{n+nx}{\PYGZdl{}}\PYG{p}{(}\PYG{l+s+s1}{'\PYGZsh{}datadir'}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{html}\PYG{p}{(}
        \PYG{k}{new} \PYG{n+nx}{DataDirView}\PYG{p}{(}\PYG{p}{\PYGZob{}}\PYG{n+nx}{model}\PYG{o}{:} \PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{files}\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{render}\PYG{p}{(}\PYG{p}{)}\PYG{p}{.}\PYG{n+nx}{el}
    \PYG{p}{)}\PYG{p}{;}

\PYG{c+cm}{/*}
\PYG{c+cm}{    // uncomment this to see what's going on in backbone.js}
\PYG{c+cm}{    if (rnaseqlyze\PYGZus{}debug) \PYGZob{}}
\PYG{c+cm}{        analysis.bind("all", function (event) \PYGZob{}}
\PYG{c+cm}{            log.debug("analysis", arguments);}
\PYG{c+cm}{        \PYGZcb{});}
\PYG{c+cm}{        analysis.files.bind("all", function (event) \PYGZob{}}
\PYG{c+cm}{            log.debug("analysis.files", arguments);}
\PYG{c+cm}{        \PYGZcb{});}
\PYG{c+cm}{        analysis.stage\PYGZus{}logs.bind("all", function (event) \PYGZob{}}
\PYG{c+cm}{            log.debug("analysis.stage\PYGZus{}logs", arguments);}
\PYG{c+cm}{        \PYGZcb{});}
\PYG{c+cm}{    \PYGZcb{}}
\PYG{c+cm}{ */}

    \PYG{c+c1}{// update the models until the analysis is finished}
    \PYG{k+kd}{var} \PYG{n+nx}{update} \PYG{o}{=} \PYG{k+kd}{function} \PYG{p}{(}\PYG{p}{)} \PYG{p}{\PYGZob{}}
        \PYG{c+c1}{// check at the beginning and not at the end}
        \PYG{c+c1}{// because the fetch() calls are asynchronous}
        \PYG{k}{if} \PYG{p}{(}\PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{attributes}\PYG{p}{.}\PYG{n+nx}{finished}\PYG{p}{)}
            \PYG{k}{return}\PYG{p}{;}
        \PYG{n+nx}{analysis}\PYG{p}{.}\PYG{n+nx}{fetch}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{c+c1}{//        log.debug("analysis.fetch()");}
        \PYG{n+nb}{window}\PYG{p}{.}\PYG{n+nx}{setTimeout}\PYG{p}{(}\PYG{n+nx}{update}\PYG{p}{,} \PYG{l+m+mi}{7000}\PYG{p}{)}\PYG{p}{;} \PYG{c+c1}{// re-update in 7 seconds}
    \PYG{p}{\PYGZcb{}}
    \PYG{n+nx}{update}\PYG{p}{(}\PYG{p}{)}\PYG{p}{;}
\PYG{p}{\PYGZcb{}}\PYG{p}{)}\PYG{p}{;}
\end{Verbatim}

